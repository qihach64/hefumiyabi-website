# 语料管理优化方案

## 优化目标

1. **新商家通用模板自动复制** - 注册时自动复制通用模板到商家知识库
2. **审核直接应用** - "通过"按钮直接将反馈应用到语料库（而非仅改变状态）
3. **审核时分类选择** - 提供分类下拉框，未选择则使用自动分类

---

## 第一阶段：审核时分类选择（前端）

### 1.1 修改文件
- `src/static/corpus.html`

### 1.2 修改内容

#### 1.2.1 在待审核列表项中添加分类下拉框

**位置**: 第 248-262 行（通过/拒绝按钮区域）

**当前代码**:
```html
<div class="flex items-center space-x-2 ml-4">
    <button @click="approveFeedback(item.id)" ...>通过</button>
    <button @click="rejectFeedback(item.id)" ...>拒绝</button>
</div>
```

**修改为**:
```html
<div class="flex items-center space-x-2 ml-4">
    <!-- 分类选择 -->
    <select
        x-model="item.selectedCategory"
        class="px-2 py-1.5 text-sm border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500"
    >
        <option value="">自动分类</option>
        <option value="general">一般问题</option>
        <option value="pricing">价格</option>
        <option value="booking">预约</option>
        <option value="size_style">尺寸款式</option>
        <option value="photo">摄影</option>
        <option value="hair_makeup">发型化妆</option>
        <option value="location">地点</option>
        <option value="return_policy">归还政策</option>
    </select>
    <button @click="approveFeedback(item.id, item.selectedCategory)" ...>通过</button>
    <button @click="rejectFeedback(item.id)" ...>拒绝</button>
</div>
```

#### 1.2.2 修改 approveFeedback 函数

**当前代码** (约第 544 行):
```javascript
async approveFeedback(feedbackId) {
    try {
        const response = await fetch(`/api/v1/feedback/${feedbackId}/approve`, {
            method: 'POST',
            headers: this.getAuthHeaders()
        });
        // ...
    }
}
```

**修改为**:
```javascript
async approveFeedback(feedbackId, category = null) {
    try {
        const response = await fetch(`/api/v1/feedback/${feedbackId}/approve`, {
            method: 'POST',
            headers: this.getAuthHeaders(),
            body: JSON.stringify({
                category: category || null,  // null 表示使用自动分类
                apply_immediately: true      // 新增：立即应用到语料库
            })
        });
        // ...
    }
}
```

---

## 第二阶段：审核直接应用（后端）

### 2.1 修改文件
- `src/api/feedback_routes.py`
- `src/learning/learning_service.py`

### 2.2 修改内容

#### 2.2.1 修改 ApproveRejectRequest 模型

**文件**: `src/api/feedback_routes.py` 第 54-56 行

**当前代码**:
```python
class ApproveRejectRequest(BaseModel):
    """审核请求"""
    reason: Optional[str] = None
```

**修改为**:
```python
class ApproveRejectRequest(BaseModel):
    """审核请求"""
    reason: Optional[str] = None
    category: Optional[str] = None  # 新增：指定分类，None 表示自动分类
    apply_immediately: bool = True  # 新增：是否立即应用到语料库
```

#### 2.2.2 修改 approve_feedback 函数

**文件**: `src/api/feedback_routes.py` 第 163-194 行

**当前代码**:
```python
async def approve_feedback(
    feedback_id: int,
    request: ApproveRejectRequest = None,
    current_user: TokenData = Depends(require_admin),
    db: AsyncSession = Depends(get_db_session),
):
    """审核通过反馈"""
    repo = FeedbackRepository(db)

    feedback = await repo.get_by_id(feedback_id)
    if not feedback:
        raise HTTPException(status_code=404, detail="反馈不存在")

    if current_user.role != "admin" and feedback.tenant_id != current_user.tenant_id:
        raise HTTPException(status_code=403, detail="无权操作此反馈")

    feedback = await repo.approve(
        feedback_id=feedback_id,
        reviewed_by=current_user.user_id,
    )

    await db.commit()

    return ApproveRejectResponse(
        success=True,
        message="反馈已审核通过",
        feedback_id=feedback_id,
        new_status="approved",
    )
```

**修改为**:
```python
async def approve_feedback(
    feedback_id: int,
    request: ApproveRejectRequest = None,
    current_user: TokenData = Depends(require_admin),
    db: AsyncSession = Depends(get_db_session),
    container: ServiceContainer = Depends(get_service_container),
):
    """审核通过反馈并应用到语料库"""
    repo = FeedbackRepository(db)

    feedback = await repo.get_by_id(feedback_id)
    if not feedback:
        raise HTTPException(status_code=404, detail="反馈不存在")

    if current_user.role != "admin" and feedback.tenant_id != current_user.tenant_id:
        raise HTTPException(status_code=403, detail="无权操作此反馈")

    # 审核通过
    feedback = await repo.approve(
        feedback_id=feedback_id,
        reviewed_by=current_user.user_id,
    )

    result_message = "反馈已审核通过"
    qa_pair_id = None

    # 立即应用到语料库（默认行为）
    apply_immediately = request.apply_immediately if request else True
    if apply_immediately:
        try:
            vector_store = container.knowledge_base.vector_store if container.knowledge_base else None
            learning_service = LearningService(session=db, vector_store=vector_store)

            # 如果指定了分类，临时设置到反馈对象
            if request and request.category:
                feedback.extra_data = feedback.extra_data or {}
                feedback.extra_data["manual_category"] = request.category

            result = await learning_service._process_single_feedback(feedback)

            if result.success:
                qa_pair_id = result.qa_pair_id
                result_message = f"反馈已审核通过并应用到语料库 ({result.action})"
            else:
                result_message = f"反馈已审核通过，但应用失败: {result.message}"
        except Exception as e:
            result_message = f"反馈已审核通过，但应用出错: {str(e)}"

    await db.commit()

    return ApproveRejectResponse(
        success=True,
        message=result_message,
        feedback_id=feedback_id,
        new_status="applied" if qa_pair_id else "approved",
    )
```

#### 2.2.3 修改 _apply_correction 支持手动分类

**文件**: `src/learning/learning_service.py` 第 152-242 行

**修改 _apply_correction 方法中的分类逻辑**:

将第 207 行:
```python
category=self._detect_category(question),
```

修改为:
```python
category=self._get_category(feedback, question),
```

**新增辅助方法**:
```python
def _get_category(self, feedback: Feedback, question: str) -> str:
    """
    获取分类，优先使用手动指定的分类

    Args:
        feedback: 反馈对象
        question: 问题文本

    Returns:
        分类名称
    """
    # 优先使用手动指定的分类
    if feedback.extra_data and feedback.extra_data.get("manual_category"):
        return feedback.extra_data["manual_category"]

    # 否则使用自动分类
    return self._detect_category(question)
```

---

## 第三阶段：新商家自动复制模板（后端）

### 3.1 修改文件
- `src/api/auth_routes.py`

### 3.2 修改内容

#### 3.2.1 修改 TenantRegisterRequest 模型

**新增字段**:
```python
class TenantRegisterRequest(BaseModel):
    """商家注册请求"""
    name: str = Field(..., min_length=2, max_length=100, description="商家名称")
    admin_username: str = Field(..., min_length=3, max_length=50, description="管理员用户名")
    admin_password: str = Field(..., min_length=6, description="管理员密码")
    admin_display_name: Optional[str] = Field(None, description="管理员显示名称")
    # 新增
    copy_templates: bool = Field(True, description="是否复制通用模板")
    template_categories: Optional[List[str]] = Field(
        None,
        description="要复制的模板类别，默认全部"
    )
```

#### 3.2.2 修改 register_tenant 函数

**在创建商家和用户后、返回响应前，添加模板复制逻辑**:

```python
from fastapi import BackgroundTasks

@auth_router.post(
    "/register/tenant",
    response_model=TenantRegisterResponse,
    status_code=status.HTTP_201_CREATED,
    summary="注册商家",
    description="注册新商家并创建管理员账户，可选自动复制通用模板",
)
async def register_tenant(
    request: TenantRegisterRequest,
    background_tasks: BackgroundTasks,  # 新增
    db: AsyncSession = Depends(get_db_session),
):
    """注册商家"""
    try:
        tenant_repo = TenantRepository(db)
        user_repo = UserRepository(db)

        # 创建商家
        tenant = await tenant_repo.create(name=request.name)

        # 创建管理员用户
        password_hash = hash_password(request.admin_password)
        admin_user = await user_repo.create(
            tenant_id=tenant.id,
            username=request.admin_username,
            password_hash=password_hash,
            role="tenant_admin",
            display_name=request.admin_display_name,
        )

        await db.commit()

        # 新增：自动复制通用模板（后台任务）
        if request.copy_templates:
            background_tasks.add_task(
                copy_templates_for_new_tenant,
                tenant_id=tenant.id,
                namespace=tenant.namespace,
                categories=request.template_categories,
            )

        # 生成令牌...
        # 返回响应...
```

#### 3.2.3 新增辅助函数

**文件**: `src/api/auth_routes.py` 末尾

```python
async def copy_templates_for_new_tenant(
    tenant_id: str,
    namespace: str,
    categories: Optional[List[str]] = None,
):
    """
    后台任务：为新商家复制通用模板

    Args:
        tenant_id: 商家 ID
        namespace: Pinecone 命名空间
        categories: 要复制的类别，None 表示全部
    """
    import json
    from pathlib import Path
    from .dependencies import ServiceContainer

    try:
        templates_file = Path(__file__).parent.parent.parent / "data" / "templates" / "universal_templates.json"

        if not templates_file.exists():
            print(f"[RegisterInit] {tenant_id}: 通用模板文件不存在，跳过复制")
            return

        with open(templates_file, "r", encoding="utf-8") as f:
            data = json.load(f)

        # 支持嵌套格式和扁平数组格式
        if isinstance(data, dict) and "templates" in data:
            all_templates = data["templates"]
        else:
            all_templates = data

        # 按类别过滤
        if categories:
            templates_to_copy = [t for t in all_templates if t.get("category") in categories]
        else:
            templates_to_copy = all_templates

        if not templates_to_copy:
            print(f"[RegisterInit] {tenant_id}: 无模板需要复制")
            return

        # 获取服务容器
        container = ServiceContainer.get_instance()
        if not container.knowledge_base:
            print(f"[RegisterInit] {tenant_id}: 知识库服务不可用")
            return

        vector_store = container.knowledge_base.vector_store

        # 批量复制
        batch_size = 50
        total = len(templates_to_copy)
        processed = 0

        for i in range(0, total, batch_size):
            batch = templates_to_copy[i:i + batch_size]

            for t in batch:
                vector_store.upsert_single(
                    question=t.get("question", ""),
                    answer=t.get("answer", ""),
                    category=t.get("category", "general"),
                    namespace=namespace,
                    quality_score=t.get("quality_score", 0.8),
                    source="universal_template",
                )

            processed += len(batch)
            print(f"[RegisterInit] {tenant_id}: 已复制 {processed}/{total} 条模板")

        print(f"[RegisterInit] {tenant_id}: 模板复制完成，共 {total} 条")

    except Exception as e:
        print(f"[RegisterInit] {tenant_id}: 模板复制失败 - {e}")
```

---

## 第四阶段：前端注册页面优化（可选）

### 4.1 修改文件
- `src/static/login.html`

### 4.2 修改内容

在注册表单中添加模板复制选项（可折叠的高级选项）:

```html
<!-- 高级选项（可折叠） -->
<div class="mt-4">
    <button
        type="button"
        @click="showAdvanced = !showAdvanced"
        class="text-sm text-gray-500 hover:text-purple-600 flex items-center"
    >
        <svg class="w-4 h-4 mr-1 transition-transform" :class="showAdvanced ? 'rotate-90' : ''" ...></svg>
        高级选项
    </button>

    <div x-show="showAdvanced" x-cloak class="mt-3 p-3 bg-gray-50 rounded-lg">
        <label class="flex items-center space-x-2">
            <input type="checkbox" x-model="registerForm.copy_templates" checked class="...">
            <span class="text-sm text-gray-700">自动复制通用模板到知识库</span>
        </label>
        <p class="text-xs text-gray-500 mt-1">
            包含常见和服租赁问答，可在语料管理中编辑或删除
        </p>
    </div>
</div>
```

---

## 实施顺序

| 阶段 | 内容 | 优先级 | 预估工作量 |
|------|------|--------|-----------|
| 1 | 审核时分类选择（前端） | 高 | 小 |
| 2 | 审核直接应用（后端） | 高 | 中 |
| 3 | 新商家自动复制模板（后端） | 中 | 中 |
| 4 | 注册页面高级选项（前端） | 低 | 小 |

建议按阶段顺序实施，每完成一个阶段进行测试验证后再进行下一阶段。

---

## 测试要点

### 阶段 1 测试
- [ ] 待审核列表显示分类下拉框
- [ ] 选择分类后点击通过，分类参数正确传递

### 阶段 2 测试
- [ ] 审核通过后，反馈状态变为 `applied`
- [ ] 语料列表中出现新增的问答对
- [ ] 手动选择的分类被正确应用
- [ ] 未选择分类时使用自动分类

### 阶段 3 测试
- [ ] 新注册商家自动有通用模板
- [ ] 模板复制在后台执行，不阻塞注册流程
- [ ] 指定类别时只复制对应类别的模板

### 阶段 4 测试
- [ ] 注册页面显示高级选项
- [ ] 取消勾选后不复制模板
