# Kimono AI 客服系统 - 系统运维可视化界面开发方案

## 项目概述

### 背景
当前 Kimono AI 客服系统已具备完整的核心功能，商家管理员可以通过现有界面（corpus.html、users.html）管理自己的知识库和用户。但**系统总运维人员**缺乏一个统一的管理界面来监控整个平台、管理所有商家、排查系统问题。

### 目标用户
**系统总运维人员** - 负责整个 AI 客服平台的运维管理

### 与商家管理员的职责区分

| 职责 | 商家管理员 | 系统总运维 |
|------|-----------|-----------|
| 管理本商家知识库 | ✅ corpus.html | ✅ 可介入 |
| 管理本商家用户 | ✅ users.html | ❌ 查看统计即可 |
| 审核本商家反馈 | ✅ 自行处理 | ❌ 不介入 |
| 管理所有商家 | ❌ | ✅ 核心职责 |
| 管理通用模板 | ❌ | ✅ 核心职责 |
| 系统监控 | ❌ | ✅ 核心职责 |
| API/成本监控 | ❌ | ✅ 核心职责 |
| 日志/告警 | ❌ | ✅ 核心职责 |
| 系统配置 | ❌ | ✅ 核心职责 |

### 目标
- 提供系统级运维管理界面
- 管理所有商家（租户）生命周期
- 管理通用知识库模板，可介入商家知识库
- 监控系统健康状态和 API 成本
- 提供日志查询和告警管理
- 支持系统配置热更新

### 现有基础
| 模块 | 状态 | 说明 |
|------|------|------|
| 用户认证 | ✅ 已完成 | JWT + 角色权限 |
| 健康检查 API | ✅ 已完成 | `/api/v1/system/health` |
| 统计 API | ✅ 已完成 | `/api/v1/system/stats` |
| 学习调度器 | ✅ 已完成 | 自动反馈处理 |
| 商家语料管理 | ✅ 已完成 | `corpus.html`（商家用） |
| 商家用户管理 | ✅ 已完成 | `users.html`（商家用） |

---

## 技术架构

### 前端技术栈
```
推荐方案（保持与现有页面一致的轻量风格）：
├── 框架：原生 HTML + JavaScript（或 Alpine.js）
├── UI：Tailwind CSS
├── 图表：ECharts
└── HTTP：Fetch API
```

### 文件结构
```
kimono_ai_customer_service/
├── src/
│   ├── api/
│   │   └── ops_routes.py              # 运维 API 路由
│   ├── ops/                           # 运维模块
│   │   ├── __init__.py
│   │   ├── metrics_collector.py       # 指标收集
│   │   ├── tenant_manager.py          # 商家管理
│   │   ├── template_manager.py        # 通用模板
│   │   ├── log_manager.py             # 日志管理
│   │   ├── alert_service.py           # 告警服务
│   │   ├── api_usage_tracker.py       # API 追踪
│   │   └── config_manager.py          # 配置管理
│   └── static/
│       └── ops/                       # 运维前端
│           ├── index.html             # 主框架
│           ├── dashboard.html         # 仪表盘
│           ├── tenants.html           # 商家管理
│           ├── templates.html         # 通用模板
│           ├── knowledge.html         # 知识库管理
│           ├── logs.html              # 日志查看
│           ├── alerts.html            # 告警管理
│           ├── config.html            # 配置管理
│           ├── css/ops.css
│           └── js/
│               ├── ops-common.js
│               ├── api-client.js
│               └── charts.js
```

---

## 开发阶段划分（共 5 个阶段）

---

## 第一阶段：仪表盘与系统监控

### 1.1 后端开发

#### 1.1.1 运维路由模块
**文件**: `src/api/ops_routes.py`

```python
# API 端点
GET  /api/v1/ops/dashboard/overview      # 全局概览
GET  /api/v1/ops/dashboard/trends        # 趋势数据
GET  /api/v1/ops/system/status           # 系统状态
GET  /api/v1/ops/system/components       # 组件健康
```

#### 1.1.2 数据模型
```python
class DashboardOverview(BaseModel):
    """仪表盘概览"""
    # 商家统计
    total_tenants: int
    active_tenants: int

    # 全局对话统计
    conversations_today: int
    conversations_week: int
    avg_response_time_ms: float

    # 全局知识库统计
    total_qa_pairs: int
    unsynced_qa_pairs: int

    # 全局反馈统计
    pending_feedbacks: int

    # API 调用
    api_calls_today: int
    estimated_cost_today: float

    # 系统状态
    components_status: Dict[str, str]
    uptime_seconds: int

class ComponentStatus(BaseModel):
    """组件状态"""
    name: str
    status: str           # healthy/degraded/unhealthy
    latency_ms: float
    last_check: datetime
```

#### 1.1.3 指标收集器
**文件**: `src/ops/metrics_collector.py`

```python
class MetricsCollector:
    async def collect_overview(self) -> DashboardOverview
    async def collect_trends(self, days: int = 7) -> TrendData
    async def check_components(self) -> List[ComponentStatus]
```

### 1.2 前端开发

#### 1.2.1 主框架
**文件**: `src/static/ops/index.html`

```
┌─────────────────────────────────────────────────────────────┐
│  Kimono AI 运维中心              🟢 系统正常    👤 运维员   │
├──────────┬──────────────────────────────────────────────────┤
│          │                                                  │
│  📊 仪表盘│           [页面内容区域]                        │
│          │                                                  │
│  🏪 商家  │                                                  │
│          │                                                  │
│  📚 模板  │                                                  │
│          │                                                  │
│  📖 知识库│                                                  │
│          │                                                  │
│  📋 日志  │                                                  │
│          │                                                  │
│  🔔 告警  │                                                  │
│          │                                                  │
│  ⚙️ 配置  │                                                  │
│          │                                                  │
└──────────┴──────────────────────────────────────────────────┘
```

#### 1.2.2 仪表盘页面
**文件**: `src/static/ops/dashboard.html`

```
┌──────────────────────────────────────────────────────────────┐
│  系统概览                                          [刷新]    │
├──────────────────────────────────────────────────────────────┤
│                                                              │
│  ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌────────┐ │
│  │商家总数  │ │今日对话  │ │待处理   │ │API调用   │ │预估成本 │ │
│  │   25    │ │  1,256  │ │反馈 156 │ │ 45,678  │ │ ¥128   │ │
│  └─────────┘ └─────────┘ └─────────┘ └─────────┘ └────────┘ │
│                                                              │
│  ┌──────────────────────────────┐ ┌────────────────────────┐ │
│  │ 对话趋势（7天）              │ │ 商家活跃度 TOP 5       │ │
│  │ [折线图]                     │ │ 1. Kimono One  156对话 │ │
│  │                              │ │ 2. 和服店A     45对话  │ │
│  │                              │ │ 3. ...                 │ │
│  └──────────────────────────────┘ └────────────────────────┘ │
│                                                              │
│  ┌──────────────────────────────┐ ┌────────────────────────┐ │
│  │ 组件状态                     │ │ 最近告警               │ │
│  │ ✅ 数据库    12ms            │ │ 🟡 反馈积压超100条     │ │
│  │ ✅ Pinecone  45ms            │ │ 🟡 API调用量增长50%    │ │
│  │ ✅ DashScope 230ms           │ │                        │ │
│  │ ✅ 调度器    运行中          │ │                        │ │
│  └──────────────────────────────┘ └────────────────────────┘ │
│                                                              │
└──────────────────────────────────────────────────────────────┘
```

### 1.3 数据库扩展

```sql
-- 指标快照表
CREATE TABLE metrics_snapshots (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    timestamp DATETIME DEFAULT CURRENT_TIMESTAMP,
    metric_type VARCHAR(50),
    metric_value FLOAT,
    dimensions JSON
);
CREATE INDEX idx_metrics_time ON metrics_snapshots(metric_type, timestamp);
```

### 1.4 交付物

| 交付物 | 描述 |
|--------|------|
| `ops_routes.py` | 运维 API 路由 |
| `metrics_collector.py` | 指标收集器 |
| `ops/index.html` | 主框架 |
| `ops/dashboard.html` | 仪表盘 |
| `ops/css/ops.css` | 样式 |
| `ops/js/*.js` | 脚本 |

### 1.5 验收标准

- [ ] 运维人员可通过 `/ops/` 访问
- [ ] 仪表盘显示商家数、对话数、API 调用、成本
- [ ] 组件健康状态实时显示
- [ ] 7 天趋势图表正常
- [ ] 页面 30 秒自动刷新

---

## 第二阶段：商家管理与通用模板

### 2.1 商家管理后端

#### 2.1.1 商家管理服务
**文件**: `src/ops/tenant_manager.py`

```python
class TenantManager:
    async def list_tenants(
        self,
        status: Optional[str] = None,
        keyword: Optional[str] = None,
        page: int = 1,
        page_size: int = 20,
    ) -> TenantListResponse

    async def get_tenant_detail(self, tenant_id: str) -> TenantDetail

    async def update_tenant_status(
        self,
        tenant_id: str,
        status: str,  # active/suspended
        reason: Optional[str] = None,
    ) -> None

    async def get_tenant_stats(self, tenant_id: str) -> TenantStats
```

#### 2.1.2 API 端点
```python
# 商家管理
GET    /api/v1/ops/tenants                 # 商家列表
GET    /api/v1/ops/tenants/{id}            # 商家详情
GET    /api/v1/ops/tenants/{id}/stats      # 商家统计
POST   /api/v1/ops/tenants/{id}/suspend    # 暂停商家
POST   /api/v1/ops/tenants/{id}/activate   # 激活商家
```

#### 2.1.3 数据模型
```python
class TenantListItem(BaseModel):
    id: str
    name: str
    status: str
    user_count: int
    qa_pair_count: int
    conversations_today: int
    last_active_at: Optional[datetime]
    created_at: datetime

class TenantStats(BaseModel):
    # 用户
    total_users: int
    admin_count: int
    staff_count: int
    # 知识库
    total_qa_pairs: int
    synced_qa_pairs: int
    avg_quality_score: float
    # 对话
    conversations_today: int
    conversations_week: int
    conversations_month: int
    avg_response_time_ms: float
    # 反馈
    pending_feedbacks: int
    feedback_approval_rate: float
```

### 2.2 通用模板管理

#### 2.2.1 模板管理服务
**文件**: `src/ops/template_manager.py`

```python
class TemplateManager:
    async def list_templates(self, category: Optional[str] = None) -> List[Template]
    async def create_template(self, data: TemplateCreate) -> Template
    async def update_template(self, id: int, data: TemplateUpdate) -> Template
    async def delete_template(self, id: int) -> None
    async def distribute_to_tenant(self, template_ids: List[int], tenant_id: str) -> DistributeResult
    async def distribute_to_all(self, template_ids: List[int]) -> DistributeResult
```

#### 2.2.2 API 端点
```python
# 通用模板
GET    /api/v1/ops/templates               # 模板列表
POST   /api/v1/ops/templates               # 创建模板
PUT    /api/v1/ops/templates/{id}          # 更新模板
DELETE /api/v1/ops/templates/{id}          # 删除模板
POST   /api/v1/ops/templates/distribute    # 分发到商家
```

### 2.3 前端开发

#### 2.3.1 商家列表页面
**文件**: `src/static/ops/tenants.html`

```
┌──────────────────────────────────────────────────────────────┐
│  商家管理                                                    │
├──────────────────────────────────────────────────────────────┤
│                                                              │
│  总商家: 25  活跃: 23  暂停: 2                               │
│                                                              │
│  筛选: [全部状态 ▼]  搜索: [________]  [搜索]               │
│                                                              │
│  ┌────────────────────────────────────────────────────────┐ │
│  │ 商家名称    │ 状态  │ 用户 │ QA数  │ 今日对话 │ 操作   │ │
│  ├────────────────────────────────────────────────────────┤ │
│  │ Kimono One  │ 🟢活跃│  5   │ 1,234 │   156   │ [详情] │ │
│  │ 和服店 A    │ 🟢活跃│  3   │  456  │    45   │ [详情] │ │
│  │ 和服店 B    │ 🟡暂停│  2   │  234  │     0   │ [详情] │ │
│  └────────────────────────────────────────────────────────┘ │
│                                                              │
│                                     << 1 2 3 >>              │
└──────────────────────────────────────────────────────────────┘
```

#### 2.3.2 商家详情弹窗
```
┌─────────────────────────────────────────────────────────────┐
│  商家详情: Kimono One                                   [×] │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  基本信息                         操作                      │
│  ID: tenant_001                   [暂停商家]                │
│  状态: 🟢 活跃                                              │
│  创建时间: 2024-01-15                                       │
│  最后活跃: 5 分钟前                                         │
│                                                             │
│  ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐          │
│  │ 用户数   │ │ 知识库   │ │ 今日对话 │ │待处理反馈│          │
│  │    5    │ │  1,234  │ │   156   │ │   23    │          │
│  └─────────┘ └─────────┘ └─────────┘ └─────────┘          │
│                                                             │
│  对话趋势（30天）                                           │
│  [折线图]                                                   │
│                                                             │
│  快捷操作:                                                  │
│  [查看知识库] [查看用户列表]                                │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

#### 2.3.3 通用模板页面
**文件**: `src/static/ops/templates.html`

```
┌──────────────────────────────────────────────────────────────┐
│  通用模板管理                               [+ 新建模板]     │
├──────────────────────────────────────────────────────────────┤
│                                                              │
│  分类: [全部 ▼]  搜索: [________]                           │
│                                                              │
│  ┌────────────────────────────────────────────────────────┐ │
│  │ □ │ 问题                    │ 分类  │ 已分发 │ 操作    │ │
│  ├────────────────────────────────────────────────────────┤ │
│  │ □ │ 租借价格是多少？        │ 价格  │ 20/25  │ ✏️ 🗑️  │ │
│  │ □ │ 如何预约？              │ 预约  │ 25/25  │ ✏️ 🗑️  │ │
│  │ □ │ 退款政策是什么？        │ 政策  │ 15/25  │ ✏️ 🗑️  │ │
│  └────────────────────────────────────────────────────────┘ │
│                                                              │
│  批量操作: [分发到指定商家] [分发到全部商家]                │
└──────────────────────────────────────────────────────────────┘
```

### 2.4 数据库扩展

```sql
-- 扩展 tenants 表
ALTER TABLE tenants ADD COLUMN last_active_at DATETIME;
ALTER TABLE tenants ADD COLUMN suspended_at DATETIME;
ALTER TABLE tenants ADD COLUMN suspended_reason TEXT;
```

### 2.5 交付物

| 交付物 | 描述 |
|--------|------|
| `tenant_manager.py` | 商家管理服务 |
| `template_manager.py` | 模板管理服务 |
| `ops/tenants.html` | 商家管理页面 |
| `ops/templates.html` | 模板管理页面 |

### 2.6 验收标准

- [ ] 可查看所有商家列表
- [ ] 可暂停/激活商家
- [ ] 可查看商家详情和统计
- [ ] 可创建/编辑/删除通用模板
- [ ] 可将模板分发到指定商家或全部商家

---

## 第三阶段：知识库管理

> 运维人员可介入管理所有商家的知识库

### 3.1 后端开发

#### 3.1.1 API 端点
```python
# 全局知识库
GET    /api/v1/ops/knowledge/overview          # 全局概览
GET    /api/v1/ops/knowledge/qa-pairs          # QA 列表（支持商家筛选）
POST   /api/v1/ops/knowledge/qa-pairs          # 创建 QA
PUT    /api/v1/ops/knowledge/qa-pairs/{id}     # 更新 QA
DELETE /api/v1/ops/knowledge/qa-pairs/{id}     # 删除 QA
POST   /api/v1/ops/knowledge/qa-pairs/bulk     # 批量操作
POST   /api/v1/ops/knowledge/sync              # 触发同步
GET    /api/v1/ops/knowledge/sync/status       # 同步状态
POST   /api/v1/ops/knowledge/import            # 导入
GET    /api/v1/ops/knowledge/export            # 导出
```

#### 3.1.2 数据模型
```python
class KnowledgeOverview(BaseModel):
    total_qa_pairs: int
    by_tenant: Dict[str, int]
    by_category: Dict[str, int]
    by_source: Dict[str, int]
    synced_count: int
    unsynced_count: int
    avg_quality_score: float

class QAPairFilter(BaseModel):
    tenant_id: Optional[str]       # 按商家筛选
    keyword: Optional[str]
    category: Optional[str]
    source: Optional[str]
    is_synced: Optional[bool]
    quality_min: Optional[float]
    quality_max: Optional[float]
    page: int = 1
    page_size: int = 20
```

### 3.2 前端开发

#### 3.2.1 知识库管理页面
**文件**: `src/static/ops/knowledge.html`

```
┌──────────────────────────────────────────────────────────────┐
│  知识库管理                        [导入] [导出] [同步全部]  │
├──────────────────────────────────────────────────────────────┤
│                                                              │
│  总计: 5,678  已同步: 5,500  待同步: 178  平均质量: 0.82    │
│                                                              │
│  商家: [全部商家 ▼]  分类: [全部 ▼]  同步: [全部 ▼]         │
│  关键词: [________]  [搜索]                                  │
│                                                              │
│  ┌────────────────────────────────────────────────────────┐ │
│  │ □ │ 商家      │ 问题            │ 分类 │ 质量 │ 同步  │ │
│  ├────────────────────────────────────────────────────────┤ │
│  │ □ │ Kimono One│ 租借价格...     │ 价格 │ 0.95 │ ✅    │ │
│  │ □ │ Kimono One│ 如何预约...     │ 预约 │ 0.88 │ ✅    │ │
│  │ □ │ 和服店 A  │ 退款政策...     │ 政策 │ 0.72 │ ⏳    │ │
│  └────────────────────────────────────────────────────────┘ │
│                                                              │
│  批量操作: [删除] [同步] [修改分类]      << 1 2 3 ... >>    │
└──────────────────────────────────────────────────────────────┘
```

### 3.3 导入导出服务
**文件**: `src/ops/import_export_service.py`

```python
class ImportExportService:
    async def import_from_excel(self, file: UploadFile, tenant_id: str) -> ImportResult
    async def import_from_csv(self, file: UploadFile, tenant_id: str) -> ImportResult
    async def export_to_excel(self, filter: QAPairFilter) -> bytes
    async def export_to_csv(self, filter: QAPairFilter) -> bytes
```

### 3.4 交付物

| 交付物 | 描述 |
|--------|------|
| `ops_routes.py` 扩展 | 知识库管理 API |
| `import_export_service.py` | 导入导出服务 |
| `ops/knowledge.html` | 知识库管理页面 |

### 3.5 验收标准

- [ ] 可查看所有商家的知识库
- [ ] 可按商家、分类、同步状态筛选
- [ ] 可创建/编辑/删除 QA 对
- [ ] 可批量操作
- [ ] 可导入/导出 Excel/CSV
- [ ] 可手动触发同步

---

## 第四阶段：日志、告警与 API 统计

### 4.1 日志管理

#### 4.1.1 日志服务
**文件**: `src/ops/log_manager.py`

```python
class LogManager:
    async def query_logs(
        self,
        start_time: datetime,
        end_time: datetime,
        level: Optional[str] = None,
        source: Optional[str] = None,
        keyword: Optional[str] = None,
        limit: int = 100,
    ) -> LogQueryResult

    async def get_log_stats(self, start_time: datetime, end_time: datetime) -> LogStats

    async def record_ops_log(
        self,
        user_id: str,
        action: str,
        target_type: str,
        target_id: str,
        details: dict,
    ) -> None
```

#### 4.1.2 API 端点
```python
# 日志
GET  /api/v1/ops/logs/query              # 查询日志
GET  /api/v1/ops/logs/stats              # 日志统计
GET  /api/v1/ops/logs/operations         # 操作日志
GET  /api/v1/ops/logs/export             # 导出
```

### 4.2 告警管理

#### 4.2.1 告警服务
**文件**: `src/ops/alert_service.py`

```python
class AlertService:
    async def create_alert(
        self,
        alert_type: str,
        severity: str,
        title: str,
        message: str,
        source: str,
    ) -> Alert

    async def get_active_alerts(self) -> List[Alert]
    async def acknowledge_alert(self, alert_id: int, user_id: str) -> None
    async def resolve_alert(self, alert_id: int) -> None
    async def check_thresholds(self) -> List[Alert]  # 定期检查，自动生成告警
```

#### 4.2.2 告警规则
```python
ALERT_RULES = [
    {"name": "high_error_rate", "condition": "error_rate > 0.1", "severity": "error"},
    {"name": "slow_response", "condition": "avg_latency_ms > 5000", "severity": "warning"},
    {"name": "pending_feedbacks", "condition": "pending_feedbacks > 100", "severity": "warning"},
    {"name": "sync_delay", "condition": "unsynced_qa > 50", "severity": "warning"},
    {"name": "component_down", "condition": "status != healthy", "severity": "critical"},
]
```

#### 4.2.3 API 端点
```python
# 告警
GET  /api/v1/ops/alerts/active           # 活跃告警
GET  /api/v1/ops/alerts/history          # 历史告警
POST /api/v1/ops/alerts/{id}/acknowledge # 确认
POST /api/v1/ops/alerts/{id}/resolve     # 解决
GET  /api/v1/ops/alerts/rules            # 规则列表
PUT  /api/v1/ops/alerts/rules            # 更新规则
```

### 4.3 API 使用统计

#### 4.3.1 API 追踪服务
**文件**: `src/ops/api_usage_tracker.py`

```python
class APIUsageTracker:
    async def record_api_call(
        self,
        api_type: str,           # dashscope/pinecone
        operation: str,          # chat/embedding/query
        tenant_id: Optional[str],
        tokens_used: int,
        latency_ms: int,
        success: bool,
    ) -> None

    async def get_usage_stats(
        self,
        start_time: datetime,
        end_time: datetime,
        tenant_id: Optional[str] = None,
    ) -> APIUsageStats

    async def estimate_cost(
        self,
        start_time: datetime,
        end_time: datetime,
    ) -> CostEstimate

class CostEstimate(BaseModel):
    dashscope_cost_cny: float
    pinecone_cost_usd: float
    total_cost_cny: float
    by_tenant: Dict[str, float]
```

#### 4.3.2 API 端点
```python
# API 统计
GET  /api/v1/ops/api-usage/stats         # 使用统计
GET  /api/v1/ops/api-usage/cost          # 成本估算
GET  /api/v1/ops/api-usage/trends        # 趋势
GET  /api/v1/ops/api-usage/by-tenant     # 按商家
```

### 4.4 前端开发

#### 4.4.1 日志页面
**文件**: `src/static/ops/logs.html`

```
┌──────────────────────────────────────────────────────────────┐
│  系统日志                                           [导出]   │
├──────────────────────────────────────────────────────────────┤
│                                                              │
│  时间: [今天 ▼]  级别: [全部 ▼]  来源: [全部 ▼]              │
│  关键词: [________]  [搜索]                                  │
│                                                              │
│  ┌────────────────────────────────────────────────────────┐ │
│  │ 时间       │ 级别  │ 来源    │ 消息                    │ │
│  ├────────────────────────────────────────────────────────┤ │
│  │ 10:30:15  │ INFO  │ api     │ POST /chat/message      │ │
│  │ 10:30:10  │ WARN  │ vector  │ 同步延迟 > 5min         │ │
│  │ 10:30:05  │ ERROR │ llm     │ API 超时                │ │
│  └────────────────────────────────────────────────────────┘ │
└──────────────────────────────────────────────────────────────┘
```

#### 4.4.2 告警页面
**文件**: `src/static/ops/alerts.html`

```
┌──────────────────────────────────────────────────────────────┐
│  告警中心                                   活跃告警: 3      │
├──────────────────────────────────────────────────────────────┤
│                                                              │
│  ┌────────────────────────────────────────────────────────┐ │
│  │ 活跃告警                                               │ │
│  │                                                        │ │
│  │ 🔴 [严重] LLM 服务无响应              2分钟前  [确认]  │ │
│  │ 🟡 [警告] 反馈积压: 156 条           15分钟前  [确认]  │ │
│  │ 🟡 [警告] 向量同步延迟: 78条         30分钟前  [确认]  │ │
│  └────────────────────────────────────────────────────────┘ │
│                                                              │
│  ┌────────────────────────────────────────────────────────┐ │
│  │ 告警规则                                      [编辑]   │ │
│  │                                                        │ │
│  │ ✅ 错误率告警    > 10%     严重                        │ │
│  │ ✅ 响应时间告警  > 5000ms  警告                        │ │
│  │ ✅ 反馈积压告警  > 100条   警告                        │ │
│  └────────────────────────────────────────────────────────┘ │
└──────────────────────────────────────────────────────────────┘
```

### 4.5 数据库扩展

```sql
-- 操作日志表
CREATE TABLE ops_logs (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    timestamp DATETIME DEFAULT CURRENT_TIMESTAMP,
    user_id VARCHAR(64),
    action VARCHAR(100),
    target_type VARCHAR(50),
    target_id VARCHAR(64),
    details JSON,
    ip_address VARCHAR(45)
);
CREATE INDEX idx_ops_logs_time ON ops_logs(timestamp);

-- 告警表
CREATE TABLE alerts (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    alert_type VARCHAR(50),
    severity VARCHAR(20),
    title VARCHAR(255),
    message TEXT,
    source VARCHAR(100),
    status VARCHAR(20),
    acknowledged_by VARCHAR(64),
    acknowledged_at DATETIME,
    resolved_at DATETIME
);
CREATE INDEX idx_alerts_status ON alerts(status);

-- API 调用记录表
CREATE TABLE api_usage_logs (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    timestamp DATETIME DEFAULT CURRENT_TIMESTAMP,
    api_type VARCHAR(50),
    operation VARCHAR(50),
    tenant_id VARCHAR(64),
    tokens_input INTEGER DEFAULT 0,
    tokens_output INTEGER DEFAULT 0,
    latency_ms INTEGER,
    success BOOLEAN
);
CREATE INDEX idx_api_usage_time ON api_usage_logs(timestamp);
CREATE INDEX idx_api_usage_tenant ON api_usage_logs(tenant_id);
```

### 4.6 交付物

| 交付物 | 描述 |
|--------|------|
| `log_manager.py` | 日志管理服务 |
| `alert_service.py` | 告警服务 |
| `api_usage_tracker.py` | API 追踪服务 |
| `ops/logs.html` | 日志页面 |
| `ops/alerts.html` | 告警页面 |
| 数据库迁移 | 新增表 |

### 4.7 验收标准

- [ ] 日志查询支持时间、级别、关键词筛选
- [ ] 日志可导出
- [ ] 告警根据规则自动生成
- [ ] 告警可确认和解决
- [ ] 告警规则可配置
- [ ] API 调用统计准确
- [ ] 成本估算显示正确

---

## 第五阶段：配置管理与安全加固

### 5.1 配置管理

#### 5.1.1 配置服务
**文件**: `src/ops/config_manager.py`

```python
class ConfigManager:
    # 可热更新的配置项
    RUNTIME_CONFIGS = {
        "scheduler": {
            "process_interval": {"type": "int", "min": 60, "max": 3600, "default": 300},
            "sync_interval": {"type": "int", "min": 60, "max": 3600, "default": 600},
            "batch_size": {"type": "int", "min": 10, "max": 200, "default": 50},
            "auto_learn_enabled": {"type": "bool", "default": True},
            "auto_sync_enabled": {"type": "bool", "default": True},
        },
        "rag": {
            "top_k": {"type": "int", "min": 1, "max": 20, "default": 5},
            "min_score": {"type": "float", "min": 0.0, "max": 1.0, "default": 0.3},
        },
    }

    async def get_config(self, category: str) -> dict
    async def update_config(self, category: str, updates: dict) -> None
    async def reset_config(self, category: str) -> None
```

#### 5.1.2 API 端点
```python
# 配置
GET  /api/v1/ops/config/categories       # 配置分类
GET  /api/v1/ops/config/{category}       # 获取配置
PUT  /api/v1/ops/config/{category}       # 更新配置
POST /api/v1/ops/config/{category}/reset # 重置

# 系统操作
POST /api/v1/ops/system/restart-scheduler    # 重启调度器
POST /api/v1/ops/system/clear-cache          # 清除缓存
GET  /api/v1/ops/system/env                  # 环境信息
```

### 5.2 安全加固

#### 5.2.1 运维角色权限
```python
OPS_ROLES = {
    "ops_admin": ["*"],                    # 运维管理员：全部权限
    "ops_viewer": ["read:*"],              # 运维只读
}
```

#### 5.2.2 操作审计
所有敏感操作自动记录到 `ops_logs` 表：
- 商家状态变更
- 配置修改
- 知识库批量操作
- 系统重启操作

#### 5.2.3 API 安全
- 运维接口强制认证
- Rate limiting
- 敏感数据脱敏

### 5.3 前端开发

#### 5.3.1 配置页面
**文件**: `src/static/ops/config.html`

```
┌──────────────────────────────────────────────────────────────┐
│  系统配置                                                    │
├──────────────────────────────────────────────────────────────┤
│                                                              │
│  ┌────────────────────────────────────────────────────────┐ │
│  │ 学习调度器                                    [重置]   │ │
│  │                                                        │ │
│  │ 反馈处理间隔    [====●=====] 300 秒                    │ │
│  │ 同步间隔        [====●=====] 600 秒                    │ │
│  │ 批处理大小      [==●=======] 50                        │ │
│  │ 自动学习        [✓]                                    │ │
│  │ 自动同步        [✓]                                    │ │
│  │                                                        │ │
│  │                              [保存] [重启调度器]       │ │
│  └────────────────────────────────────────────────────────┘ │
│                                                              │
│  ┌────────────────────────────────────────────────────────┐ │
│  │ RAG 配置                                      [重置]   │ │
│  │                                                        │ │
│  │ 检索数量 (top_k)     [==●=======] 5                    │ │
│  │ 最小相似度阈值       [===●======] 0.30                 │ │
│  │                                                        │ │
│  │                                           [保存]       │ │
│  └────────────────────────────────────────────────────────┘ │
│                                                              │
│  ┌────────────────────────────────────────────────────────┐ │
│  │ 系统操作                                               │ │
│  │                                                        │ │
│  │ [清除缓存]  [重启调度器]                               │ │
│  │                                                        │ │
│  │ 环境: Python 3.12 | FastAPI 0.104 | SQLite | Pinecone │ │
│  └────────────────────────────────────────────────────────┘ │
│                                                              │
└──────────────────────────────────────────────────────────────┘
```

### 5.4 交付物

| 交付物 | 描述 |
|--------|------|
| `config_manager.py` | 配置管理服务 |
| `ops/config.html` | 配置页面 |
| 权限控制增强 | 运维角色 |

### 5.5 验收标准

- [ ] 配置可热更新
- [ ] 配置有范围限制
- [ ] 可重置为默认值
- [ ] 危险操作有确认
- [ ] 所有操作有审计日志
- [ ] 运维接口有访问控制

---

## 整体验收清单

| 阶段 | 功能 | 状态 |
|------|------|------|
| 一 | 仪表盘 - 全局概览 | ⬜ |
| 一 | 仪表盘 - 趋势图表 | ⬜ |
| 一 | 仪表盘 - 组件状态 | ⬜ |
| 二 | 商家管理 - 列表和筛选 | ⬜ |
| 二 | 商家管理 - 暂停/激活 | ⬜ |
| 二 | 通用模板 - CRUD | ⬜ |
| 二 | 通用模板 - 分发 | ⬜ |
| 三 | 知识库 - 全局查看 | ⬜ |
| 三 | 知识库 - 编辑/删除 | ⬜ |
| 三 | 知识库 - 导入/导出 | ⬜ |
| 四 | 日志 - 查询和导出 | ⬜ |
| 四 | 告警 - 自动生成 | ⬜ |
| 四 | 告警 - 确认和解决 | ⬜ |
| 四 | API 统计 - 调用量 | ⬜ |
| 四 | API 统计 - 成本 | ⬜ |
| 五 | 配置 - 热更新 | ⬜ |
| 五 | 配置 - 系统操作 | ⬜ |
| 五 | 安全 - 操作审计 | ⬜ |

---

## API 端点汇总

```
/api/v1/ops/
├── dashboard/
│   ├── GET /overview              # 全局概览
│   └── GET /trends                # 趋势数据
├── system/
│   ├── GET /status                # 系统状态
│   ├── GET /components            # 组件健康
│   ├── POST /restart-scheduler    # 重启调度器
│   ├── POST /clear-cache          # 清除缓存
│   └── GET /env                   # 环境信息
├── tenants/
│   ├── GET /                      # 商家列表
│   ├── GET /{id}                  # 商家详情
│   ├── GET /{id}/stats            # 商家统计
│   ├── POST /{id}/suspend         # 暂停
│   └── POST /{id}/activate        # 激活
├── templates/
│   ├── GET /                      # 模板列表
│   ├── POST /                     # 创建
│   ├── PUT /{id}                  # 更新
│   ├── DELETE /{id}               # 删除
│   └── POST /distribute           # 分发
├── knowledge/
│   ├── GET /overview              # 概览
│   ├── GET /qa-pairs              # QA 列表
│   ├── POST /qa-pairs             # 创建
│   ├── PUT /qa-pairs/{id}         # 更新
│   ├── DELETE /qa-pairs/{id}      # 删除
│   ├── POST /qa-pairs/bulk        # 批量
│   ├── POST /sync                 # 同步
│   ├── POST /import               # 导入
│   └── GET /export                # 导出
├── logs/
│   ├── GET /query                 # 查询
│   ├── GET /stats                 # 统计
│   ├── GET /operations            # 操作日志
│   └── GET /export                # 导出
├── alerts/
│   ├── GET /active                # 活跃
│   ├── GET /history               # 历史
│   ├── POST /{id}/acknowledge     # 确认
│   ├── POST /{id}/resolve         # 解决
│   ├── GET /rules                 # 规则
│   └── PUT /rules                 # 更新规则
├── api-usage/
│   ├── GET /stats                 # 统计
│   ├── GET /cost                  # 成本
│   ├── GET /trends                # 趋势
│   └── GET /by-tenant             # 按商家
└── config/
    ├── GET /categories            # 分类
    ├── GET /{category}            # 获取
    ├── PUT /{category}            # 更新
    └── POST /{category}/reset     # 重置
```

---

## 新增数据库表

```sql
-- 指标快照
CREATE TABLE metrics_snapshots (...);

-- 操作日志
CREATE TABLE ops_logs (...);

-- 告警
CREATE TABLE alerts (...);

-- API 调用记录
CREATE TABLE api_usage_logs (...);

-- 扩展 tenants
ALTER TABLE tenants ADD COLUMN last_active_at DATETIME;
ALTER TABLE tenants ADD COLUMN suspended_at DATETIME;
ALTER TABLE tenants ADD COLUMN suspended_reason TEXT;
```

---

## 前端文件结构

```
static/ops/
├── index.html          # 主框架
├── dashboard.html      # 仪表盘
├── tenants.html        # 商家管理
├── templates.html      # 通用模板
├── knowledge.html      # 知识库管理
├── logs.html           # 日志
├── alerts.html         # 告警
├── config.html         # 配置
├── css/
│   └── ops.css
└── js/
    ├── ops-common.js
    ├── api-client.js
    └── charts.js
```

---

*文档版本: 2.0（精简版）*
*创建日期: 2025-12-17*
*修改说明: 删除反馈审核模块（商家自行管理），保留知识库管理权限，合并安全加固到配置阶段*
