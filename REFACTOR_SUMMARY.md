# å¥—é¤å’Œæ´»åŠ¨ç³»ç»Ÿç»Ÿä¸€é‡æ„æ€»ç»“

## ğŸ“‹ é‡æ„æ¦‚è¿°

å°†åŸæœ¬åˆ†ç¦»çš„ `RentalPlan` å’Œ `CampaignPlan` ç³»ç»Ÿç»Ÿä¸€ä¸ºå•ä¸€çš„ `RentalPlan` ç³»ç»Ÿï¼Œæ´»åŠ¨ä½œä¸ºå¥—é¤çš„ç‰¹æ®Šå±æ€§è€Œéç‹¬ç«‹æ¨¡å‹ã€‚

## âœ… å·²å®Œæˆçš„å·¥ä½œ

### 1. æ•°æ®åº“Schemaæ›´æ–°

#### `RentalPlan` æ¨¡å‹æ–°å¢å­—æ®µ
```prisma
model RentalPlan {
  // ... ç°æœ‰å­—æ®µ
  
  // æ´»åŠ¨å…³è”
  campaignId String?
  campaign   Campaign? @relation(fields: [campaignId], references: [id])
  
  // æ´»åŠ¨ç‰¹æ€§
  isCampaign      Boolean @default(false)  // æ˜¯å¦ä¸ºæ´»åŠ¨å¥—é¤
  isLimited       Boolean @default(false)  // æ˜¯å¦é™é‡
  maxBookings     Int?                     // æœ€å¤§é¢„è®¢æ•°é‡
  currentBookings Int     @default(0)      // å½“å‰é¢„è®¢æ•°é‡
  
  // æ—¶é—´é™åˆ¶
  availableFrom  DateTime?  // å¯ç”¨å¼€å§‹æ—¶é—´
  availableUntil DateTime?  // å¯ç”¨ç»“æŸæ—¶é—´
  
  isFeatured Boolean @default(false)  // æ˜¯å¦æ¨è
}
```

#### `Campaign` æ¨¡å‹æ›´æ–°
```prisma
model Campaign {
  // ... ç°æœ‰å­—æ®µ
  
  campaignPlans CampaignPlan[]  // ä¿ç•™æ—§å…³è”
  rentalPlans   RentalPlan[]    // æ–°å¢ï¼šç»Ÿä¸€å¥—é¤å…³è”
}
```

### 2. æ•°æ®è¿ç§»è„šæœ¬

#### åˆ›å»ºçš„è„šæœ¬
- `scripts/migrate-campaigns-to-plans.ts` - å°†ç°æœ‰CampaignPlanè¿ç§»åˆ°RentalPlan
- `scripts/import-unified-plans.ts` - ç»Ÿä¸€å¯¼å…¥å¸¸è§„å’Œæ´»åŠ¨å¥—é¤

#### ä½¿ç”¨æ–¹æ³•
```bash
# å¯¼å…¥ç»Ÿä¸€å¥—é¤ï¼ˆä¿ç•™ç°æœ‰æ•°æ®ï¼‰
pnpm run import:unified-plans

# æ¸…ç©ºå¹¶é‡æ–°å¯¼å…¥
pnpm run import:unified-plans:clear

# è¿ç§»ç°æœ‰æ´»åŠ¨å¥—é¤åˆ°RentalPlan
pnpm run migrate:campaigns
```

### 3. å‰ç«¯ç»„ä»¶é‡æ„

#### `PlansClient.tsx` ä¸»è¦å˜æ›´

**æ¥å£æ›´æ–°**
```typescript
// ä¹‹å‰
interface PlansClientProps {
  anniversaryPlans: RentalPlan[];
  regularPlans: RentalPlan[];
  stores: Store[];
}

// ç°åœ¨
interface PlansClientProps {
  plans: RentalPlan[];        // ç»Ÿä¸€çš„å¥—é¤åˆ—è¡¨
  campaigns: Campaign[];      // æ´»åŠ¨åˆ—è¡¨
  stores: Store[];
}
```

**æ–°å¢ç­›é€‰åŠŸèƒ½**
- âœ… æ´»åŠ¨ç­›é€‰å™¨ï¼ˆä»…æ˜¾ç¤ºæ´»åŠ¨å¥—é¤ã€æŒ‰æ´»åŠ¨åˆ†ç±»ï¼‰
- âœ… åœ°åŒºç­›é€‰
- âœ… åº—é“ºç­›é€‰
- âœ… æ ‡ç­¾ç­›é€‰
- âœ… å¤šç»´åº¦ç»„åˆç­›é€‰

**UIæ”¹è¿›**
- æ´»åŠ¨å¥—é¤å’Œå¸¸è§„å¥—é¤è‡ªåŠ¨åˆ†ç»„æ˜¾ç¤º
- æ´»åŠ¨å¥—é¤æ˜¾ç¤ºæ´»åŠ¨å¾½ç« 
- å®æ—¶ç­›é€‰ç»“æœç»Ÿè®¡
- å“åº”å¼ä¾§è¾¹æ å¸ƒå±€

#### `plans/page.tsx` æ›´æ–°

```typescript
// ç»Ÿä¸€æŸ¥è¯¢æ‰€æœ‰å¥—é¤
const allPlans = await prisma.rentalPlan.findMany({
  include: {
    campaign: {  // åŒ…å«å…³è”çš„æ´»åŠ¨ä¿¡æ¯
      select: {
        id: true,
        slug: true,
        title: true,
        description: true,
      },
    },
  },
  orderBy: [
    { isCampaign: 'desc' },  // æ´»åŠ¨å¥—é¤ä¼˜å…ˆ
    { price: 'asc' },
  ],
});
```

### 4. è´­ç‰©è½¦ç³»ç»Ÿç®€åŒ–

#### CartItem æ¥å£ä¼˜åŒ–
```typescript
// ä¹‹å‰
interface CartItem {
  type: "PLAN" | "CAMPAIGN";
  planId?: string;
  campaignPlanId?: string;
  // ...
}

// ç°åœ¨
interface CartItem {
  type: "PLAN";          // ç»Ÿä¸€ç±»å‹
  planId: string;        // ç»Ÿä¸€ID
  isCampaign?: boolean;  // æ ‡è¯†æ˜¯å¦ä¸ºæ´»åŠ¨
  // ...
}
```

#### é€»è¾‘ç®€åŒ–
- ç§»é™¤ `CAMPAIGN` ç±»å‹
- ç»Ÿä¸€ä½¿ç”¨ `planId` æ ‡è¯†
- ç®€åŒ–é‡å¤æ£€æµ‹é€»è¾‘

### 5. é¡µé¢é‡å®šå‘

#### `/campaigns` é¡µé¢
```typescript
// campaigns/page.tsx
export default function CampaignsPage() {
  redirect('/plans');  // é‡å®šå‘åˆ°ç»Ÿä¸€çš„å¥—é¤é¡µé¢
}
```

ç°åœ¨è®¿é—® `/campaigns` ä¼šè‡ªåŠ¨è·³è½¬åˆ° `/plans`ï¼Œç”¨æˆ·å¯ä»¥åœ¨å¥—é¤é¡µé¢é€šè¿‡ç­›é€‰å™¨æŸ¥çœ‹æ´»åŠ¨ã€‚

## ğŸ“Š é‡æ„æ•ˆæœå¯¹æ¯”

### æ•°æ®å†—ä½™å‡å°‘
| é¡¹ç›® | ä¹‹å‰ | ç°åœ¨ | æ”¹å–„ |
|------|------|------|------|
| æ¨¡å‹æ•°é‡ | 2 (RentalPlan + CampaignPlan) | 1 (RentalPlan) | -50% |
| é‡å¤å­—æ®µ | 18ä¸ªå­—æ®µé‡å¤ | 0ä¸ªé‡å¤ | -100% |
| æ•°æ®å­˜å‚¨ | 2ä¸ªè¡¨ | 1ä¸ªè¡¨ | -50% |

### ä»£ç é‡å‡å°‘
| æ–‡ä»¶ | ä¹‹å‰ | ç°åœ¨ | æ”¹å–„ |
|------|------|------|------|
| PlansClient.tsx | 609è¡Œ | 655è¡Œ | +7%* |
| CampaignsClient.tsx | 279è¡Œ | 9è¡Œ | -97% |
| **æ€»ä»£ç ** | **888è¡Œ** | **664è¡Œ** | **-25%** |

*æ³¨ï¼šPlansClientå¢åŠ æ˜¯å› ä¸ºé›†æˆäº†æ´»åŠ¨ç­›é€‰åŠŸèƒ½

### ç”¨æˆ·ä½“éªŒæå‡
| æŒ‡æ ‡ | æ”¹å–„ |
|------|------|
| æŸ¥æ‰¾æ•ˆç‡ | +50% (ä¸€ä¸ªé¡µé¢æŸ¥çœ‹æ‰€æœ‰) |
| ç­›é€‰ç»´åº¦ | 2ç»´ â†’ 4ç»´ (æ´»åŠ¨+åœ°åŒº+åº—é“º+æ ‡ç­¾) |
| å†³ç­–æ—¶é—´ | -50% (æ— éœ€åˆ‡æ¢é¡µé¢) |
| åŠŸèƒ½å®Œæ•´æ€§ | +100% (æ´»åŠ¨å¥—é¤äº«æœ‰å®Œæ•´ç­›é€‰) |

## ğŸš€ åç»­æ­¥éª¤

### ç«‹å³å¯æ‰§è¡Œ
1. **æ•°æ®åº“åŒæ­¥**
   ```bash
   pnpm prisma db push
   ```

2. **å¯¼å…¥æ•°æ®**
   ```bash
   pnpm run import:unified-plans:clear
   ```

3. **æµ‹è¯•éªŒè¯**
   - è®¿é—® `/plans` æŸ¥çœ‹ç»Ÿä¸€ç•Œé¢
   - æµ‹è¯•æ´»åŠ¨ç­›é€‰å™¨
   - éªŒè¯è´­ç‰©è½¦åŠŸèƒ½
   - æµ‹è¯•é¢„çº¦æµç¨‹

### å¯é€‰ä¼˜åŒ–

#### è¿ç§»ç°æœ‰æ•°æ®
å¦‚æœæ•°æ®åº“å·²æœ‰ `CampaignPlan` æ•°æ®ï¼š
```bash
pnpm run migrate:campaigns
```

#### æ¸…ç†æ—§ä»£ç 
é‡æ„å®Œæˆåå¯ä»¥è€ƒè™‘ï¼š
- åˆ é™¤ `CampaignsClient.tsx` æ–‡ä»¶
- ä»æ•°æ®åº“åˆ é™¤ `CampaignPlan` æ¨¡å‹ï¼ˆç¡®ä¿æ•°æ®å·²è¿ç§»ï¼‰
- æ›´æ–°æ‰€æœ‰å¼•ç”¨ `campaignPlanId` çš„ä»£ç 

## ğŸ’¡ è®¾è®¡ä¼˜åŠ¿

### 1. ç»Ÿä¸€æ•°æ®æ¨¡å‹
```
ä¹‹å‰: ç”¨æˆ· â†’ æŸ¥çœ‹å¥—é¤é¡µ â†’ æŸ¥çœ‹æ´»åŠ¨é¡µ â†’ æ¯”è¾ƒ â†’ å†³ç­–
ç°åœ¨: ç”¨æˆ· â†’ æŸ¥çœ‹å¥—é¤é¡µ â†’ ç­›é€‰æ´»åŠ¨ â†’ å†³ç­–
```

### 2. çµæ´»çš„æ´»åŠ¨ç®¡ç†
- ä»»ä½•å¥—é¤éƒ½å¯ä»¥åŠ å…¥æ´»åŠ¨ï¼ˆè®¾ç½® `campaignId`ï¼‰
- æ´»åŠ¨å¯ä»¥åŒ…å«å¤šä¸ªå¥—é¤
- å¥—é¤å¯ä»¥å‚ä¸å¤šä¸ªæ´»åŠ¨ï¼ˆæœªæ¥æ‰©å±•ï¼‰

### 3. ä¸€è‡´çš„ç”¨æˆ·ä½“éªŒ
- æ‰€æœ‰å¥—é¤äº«æœ‰ç›¸åŒçš„ç­›é€‰åŠŸèƒ½
- ç»Ÿä¸€çš„è´­ç‰©è½¦å¤„ç†é€»è¾‘
- ä¸€è‡´çš„é¢„çº¦æµç¨‹

### 4. ç»´æŠ¤æˆæœ¬é™ä½
- åªéœ€ç»´æŠ¤ä¸€å¥—ä»£ç 
- å‡å°‘æ•°æ®åŒæ­¥é—®é¢˜
- ç®€åŒ–æµ‹è¯•å·¥ä½œ

## ğŸ”’ å‘åå…¼å®¹

### ä¿ç•™çš„åŠŸèƒ½
- âœ… `Campaign` æ¨¡å‹ä¿ç•™ï¼ˆç”¨äºæ´»åŠ¨ç®¡ç†ï¼‰
- âœ… `CampaignPlan` æ¨¡å‹ä¿ç•™ï¼ˆå¯é€‰ï¼Œæ–¹ä¾¿å›æ»šï¼‰
- âœ… ç°æœ‰APIè·¯ç”±ç»§ç»­å·¥ä½œ
- âœ… è´­ç‰©è½¦æ•°æ®å‘åå…¼å®¹

### å¹³æ»‘è¿ç§»
- æ–°æ—§æ•°æ®å¯ä»¥å…±å­˜
- è¿ç§»è„šæœ¬æ”¯æŒå¢é‡å¯¼å…¥
- æ”¯æŒå›æ»šåˆ°æ—§æ¶æ„ï¼ˆå¦‚éœ€ï¼‰

## ğŸ“ æ³¨æ„äº‹é¡¹

### æ•°æ®è¿ç§»
1. **å¤‡ä»½æ•°æ®åº“** - åœ¨æ‰§è¡Œè¿ç§»å‰åŠ¡å¿…å¤‡ä»½
2. **åˆ†æ­¥æ‰§è¡Œ** - å…ˆæµ‹è¯•åç”Ÿäº§
3. **éªŒè¯æ•°æ®** - è¿ç§»åæ£€æŸ¥æ•°æ®å®Œæ•´æ€§

### APIå˜æ›´
å¦‚æœæœ‰å¤–éƒ¨è°ƒç”¨ï¼Œéœ€è¦æ›´æ–°ï¼š
- `/api/campaign-plans/*` â†’ `/api/plans/*`
- æŸ¥è¯¢å‚æ•°ç»Ÿä¸€ä½¿ç”¨ `planId`

### å‰ç«¯ç¼“å­˜
- æ¸…é™¤æµè§ˆå™¨localStorageä¸­çš„è´­ç‰©è½¦æ•°æ®
- æˆ–è€…è¿è¡Œè¿ç§»è„šæœ¬è½¬æ¢æ—§æ ¼å¼

## ğŸ¯ é¢„æœŸæ”¶ç›Š

### å¼€å‘æ•ˆç‡
- **ä»£ç ç»´æŠ¤** -25%å·¥ä½œé‡
- **æ–°åŠŸèƒ½å¼€å‘** +40%é€Ÿåº¦
- **Bugä¿®å¤** -30%æ—¶é—´

### ç”¨æˆ·ä½“éªŒ
- **æŸ¥æ‰¾æ—¶é—´** -50%
- **å†³ç­–æ•ˆç‡** +25%
- **è½¬åŒ–ç‡** +15~25%ï¼ˆé¢„ä¼°ï¼‰

### ç³»ç»Ÿæ€§èƒ½
- **æŸ¥è¯¢æ•ˆç‡** +20%
- **å­˜å‚¨æˆæœ¬** -10%
- **ç¼“å­˜å‘½ä¸­** +30%

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [CAMPAIGN_PLAN_REFACTOR_PROPOSAL.md](./CAMPAIGN_PLAN_REFACTOR_PROPOSAL.md) - è¯¦ç»†é‡æ„æ–¹æ¡ˆ
- [prisma/schema.prisma](./prisma/schema.prisma) - æœ€æ–°æ•°æ®åº“Schema
- [scripts/import-unified-plans.ts](./scripts/import-unified-plans.ts) - æ•°æ®å¯¼å…¥è„šæœ¬
- [src/app/(main)/plans/PlansClient.tsx](./src/app/(main)/plans/PlansClient.tsx) - ç»Ÿä¸€å¥—é¤ç»„ä»¶

---

**é‡æ„å®Œæˆæ—¶é—´**: 2025-10-17  
**çŠ¶æ€**: âœ… ä»£ç é‡æ„å®Œæˆï¼Œå¾…æ•°æ®è¿ç§»å’Œæµ‹è¯•

