# æ±Ÿæˆ¸å’Œè£…å·¥æˆ¿é›… - å’Œæœç§Ÿèµç½‘ç«™æ¶æ„æ–‡æ¡£

## ğŸ“‹ ç›®å½•

1. [é¡¹ç›®æ¦‚è¿°](#1-é¡¹ç›®æ¦‚è¿°)
2. [æŠ€æœ¯æ¶æ„](#2-æŠ€æœ¯æ¶æ„)
3. [æ•°æ®åº“æ¨¡å‹è¯¦è§£](#3-æ•°æ®åº“æ¨¡å‹è¯¦è§£)
4. [æ ¸å¿ƒä¸šåŠ¡æµç¨‹](#4-æ ¸å¿ƒä¸šåŠ¡æµç¨‹)
5. [ç›®å½•ç»“æ„è¯´æ˜](#5-ç›®å½•ç»“æ„è¯´æ˜)
6. [å…³é”®åŠŸèƒ½å®ç°](#6-å…³é”®åŠŸèƒ½å®ç°)
7. [å¼€å‘å’Œéƒ¨ç½²æŒ‡å—](#7-å¼€å‘å’Œéƒ¨ç½²æŒ‡å—)

---

## 1. é¡¹ç›®æ¦‚è¿°

### 1.1 é¡¹ç›®å®šä½
æ±Ÿæˆ¸å’Œè£…å·¥æˆ¿é›…æ˜¯ä¸€ä¸ªä¸“ä¸šçš„å’Œæœç§Ÿèµå¹³å°ï¼Œä¸»è¦é¢å‘åœ¨æ—¥æœ¬çš„æ¸¸å®¢å’Œå½“åœ°ç”¨æˆ·æä¾›ä¼ ç»Ÿå’Œæœç§ŸèµæœåŠ¡ã€‚ç½‘ç«™æ”¯æŒå¤šåº—é“ºç®¡ç†ã€å¥—é¤é¢„è®¢ã€ä¼˜æƒ æ´»åŠ¨ç­‰åŠŸèƒ½ã€‚

### 1.2 ä¸»è¦åŠŸèƒ½
- **ç”¨æˆ·ç³»ç»Ÿ**: æ³¨å†Œç™»å½•ã€é‚®ç®±éªŒè¯ã€ä¸ªäººä¸­å¿ƒ
- **å’Œæœå±•ç¤º**: å’Œæœå›¾åº“ã€åˆ†ç±»ç­›é€‰ã€è¯¦æƒ…å±•ç¤º
- **å¥—é¤ç®¡ç†**: ç§Ÿèµå¥—é¤ã€ä»·æ ¼ç®¡ç†ã€ç‰¹è‰²æœåŠ¡
- **æ´»åŠ¨ç³»ç»Ÿ**: ä¼˜æƒ æ´»åŠ¨ã€é™æ—¶æŠ˜æ‰£ã€å‘¨å¹´åº†å…¸
- **é¢„çº¦ç³»ç»Ÿ**: åœ¨çº¿é¢„çº¦ã€å¤šåº—é“ºæ”¯æŒã€é¢„çº¦ç®¡ç†
- **è´­ç‰©è½¦**: å¥—é¤é€‰æ‹©ã€åº—é“ºåˆ†é…ã€æ•°é‡ç®¡ç†
- **åº—é“ºç®¡ç†**: å¤šåº—é“ºæ”¯æŒã€åœ°ç†ä½ç½®ã€è¥ä¸šæ—¶é—´

### 1.3 æŠ€æœ¯é€‰å‹åŸå› 

| æŠ€æœ¯ | é€‰æ‹©åŸå›  |
|------|----------|
| **Next.js 14** | å…¨æ ˆæ¡†æ¶ï¼Œæ”¯æŒ SSR/SSGï¼Œä¼˜ç§€çš„å¼€å‘ä½“éªŒ |
| **TypeScript** | ç±»å‹å®‰å…¨ï¼Œæé«˜ä»£ç è´¨é‡å’Œå¼€å‘æ•ˆç‡ |
| **Prisma** | ç°ä»£åŒ– ORMï¼Œç±»å‹å®‰å…¨ï¼Œä¼˜ç§€çš„å¼€å‘å·¥å…· |
| **PostgreSQL** | å¯é çš„å…³ç³»å‹æ•°æ®åº“ï¼Œæ”¯æŒå¤æ‚æŸ¥è¯¢ |
| **NextAuth.js** | æˆç†Ÿçš„è®¤è¯è§£å†³æ–¹æ¡ˆï¼Œæ”¯æŒå¤šç§ç™»å½•æ–¹å¼ |
| **Zustand** | è½»é‡çº§çŠ¶æ€ç®¡ç†ï¼Œç®€å•æ˜“ç”¨ |
| **Tailwind CSS** | å®ç”¨ä¼˜å…ˆçš„ CSS æ¡†æ¶ï¼Œå¿«é€Ÿå¼€å‘ |
| **Nodemailer** | é‚®ä»¶å‘é€ï¼Œæ”¯æŒå¤šç§ SMTP æœåŠ¡ |

---

## 2. æŠ€æœ¯æ¶æ„

### 2.1 å‰ç«¯æŠ€æœ¯æ ˆ

```typescript
// æ ¸å¿ƒæŠ€æœ¯
Next.js 14 (App Router) + TypeScript + Tailwind CSS

// çŠ¶æ€ç®¡ç†
Zustand (è´­ç‰©è½¦çŠ¶æ€) + TanStack Query (æœåŠ¡ç«¯çŠ¶æ€)

// è¡¨å•å¤„ç†
React Hook Form + Zod (éªŒè¯)

// UI ç»„ä»¶
Lucide React (å›¾æ ‡) + è‡ªå®šä¹‰ç»„ä»¶

// æ ·å¼ç³»ç»Ÿ
Tailwind CSS + CSS Variables (ä¸»é¢˜)
```

### 2.2 åç«¯æŠ€æœ¯æ ˆ

```typescript
// API è·¯ç”±
Next.js API Routes (RESTful)

// æ•°æ®åº“
PostgreSQL + Prisma ORM

// è®¤è¯ç³»ç»Ÿ
NextAuth.js + Prisma Adapter

// é‚®ä»¶æœåŠ¡
Nodemailer + SMTP

// å¯†ç åŠ å¯†
bcryptjs
```

### 2.3 æ•°æ®åº“è®¾è®¡

```mermaid
erDiagram
    User ||--o{ Booking : "creates"
    User ||--o{ Favorite : "likes"
    User ||--o{ Review : "writes"
    User ||--|| Cart : "has"
    User ||--|| UserPreference : "has"
    
    Booking ||--o{ BookingItem : "contains"
    BookingItem }o--|| Store : "at"
    BookingItem }o--o| RentalPlan : "uses"
    BookingItem ||--o{ BookingKimono : "includes"
    
    Store ||--o{ KimonoStore : "stocks"
    KimonoStore }o--|| Kimono : "references"
    Kimono ||--o{ KimonoImage : "has"
    
    Cart ||--o{ CartItem : "contains"
    CartItem }o--o| RentalPlan : "references"
    
    Campaign ||--o{ CampaignPlan : "contains"
    CampaignPlan ||--o{ CartItem : "added_to_cart"
```

### 2.4 è®¤è¯ç³»ç»Ÿæ¶æ„

```typescript
// è®¤è¯æµç¨‹
ç”¨æˆ·æ³¨å†Œ â†’ é‚®ç®±éªŒè¯ â†’ ç™»å½• â†’ JWT Session

// æ”¯æŒçš„è®¤è¯æ–¹å¼
- é‚®ç®±å¯†ç ç™»å½•
- é‚®ç®±éªŒè¯ï¼ˆå¼ºåˆ¶ï¼‰
- æ¸¸å®¢é¢„çº¦ï¼ˆæ— éœ€ç™»å½•ï¼‰

// Session ç®¡ç†
- NextAuth.js JWT Strategy
- è‡ªåŠ¨è¿‡æœŸå¤„ç†
- å®‰å…¨çš„å¯†ç å“ˆå¸Œ
```

### 2.5 çŠ¶æ€ç®¡ç†æ¶æ„

```typescript
// å®¢æˆ·ç«¯çŠ¶æ€
- Zustand: è´­ç‰©è½¦çŠ¶æ€ï¼ˆæŒä¹…åŒ–åˆ° localStorageï¼‰
- React State: ç»„ä»¶å†…éƒ¨çŠ¶æ€
- URL State: è·¯ç”±å‚æ•°å’ŒæŸ¥è¯¢å‚æ•°

// æœåŠ¡ç«¯çŠ¶æ€
- Next.js Server Components: æœåŠ¡ç«¯æ•°æ®è·å–
- TanStack Query: å®¢æˆ·ç«¯æ•°æ®ç¼“å­˜å’ŒåŒæ­¥
```

---

## 3. æ•°æ®åº“æ¨¡å‹è¯¦è§£

### 3.1 ç”¨æˆ·ç³»ç»Ÿ

#### User æ¨¡å‹
```prisma
model User {
  id            String    @id @default(cuid())
  email         String?   @unique
  emailVerified DateTime?
  phone         String?   @unique
  passwordHash  String?
  
  name     String?
  avatar   String?
  role     Role      @default(USER)
  language Language  @default(ZH)
  birthday DateTime?
  gender   Gender?
  
  // è¥é”€æ•°æ®
  source       String?
  referralCode String?   @unique
  referredBy   String?
  
  // å…³è”æ•°æ®
  preference UserPreference?
  cart       Cart?
  bookings   Booking[]
  favorites  Favorite[]
  reviews    Review[]
  accounts   Account[]
  sessions   Session[]
}
```

**æ ¸å¿ƒç‰¹æ€§**:
- æ”¯æŒé‚®ç®±/æ‰‹æœºå·ç™»å½•
- é‚®ç®±éªŒè¯æœºåˆ¶
- æ¨èç³»ç»Ÿæ”¯æŒ
- å¤šè¯­è¨€åå¥½
- å®Œæ•´çš„ç”¨æˆ·ç”»åƒ

#### è®¤è¯ç›¸å…³æ¨¡å‹
```prisma
model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  // OAuth ç›¸å…³å­—æ®µ...
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime
}
```

### 3.2 å’Œæœç³»ç»Ÿ

#### Kimono æ¨¡å‹
```prisma
model Kimono {
  id          String   @id @default(cuid())
  code        String   @unique
  name        String
  nameEn      String?
  description String?
  
  category KimonoCategory
  style    String
  color    String[]
  pattern  String[]
  season   Season[]
  
  size        String
  isAvailable Boolean  @default(true)
  
  // å…³è”æ•°æ®
  images      KimonoImage[]
  stores      KimonoStore[]
  favorites   Favorite[]
  bookings    BookingKimono[]
  
  // ç»Ÿè®¡ä¿¡æ¯
  viewCount    Int @default(0)
  bookingCount Int @default(0)
}
```

**æ ¸å¿ƒç‰¹æ€§**:
- å¤šè¯­è¨€æ”¯æŒï¼ˆä¸­æ–‡/è‹±æ–‡ï¼‰
- ä¸°å¯Œçš„å±æ€§æ ‡ç­¾ï¼ˆé¢œè‰²ã€å›¾æ¡ˆã€å­£èŠ‚ï¼‰
- å¤šå›¾ç‰‡æ”¯æŒ
- å¤šåº—é“ºåº“å­˜ç®¡ç†
- ç»Ÿè®¡ä¿¡æ¯è¿½è¸ª

#### KimonoImage æ¨¡å‹
```prisma
model KimonoImage {
  id       String @id @default(cuid())
  kimonoId String
  url      String
  alt      String?
  order    Int     @default(0)
}
```

### 3.3 åº—é“ºç³»ç»Ÿ

#### Store æ¨¡å‹
```prisma
model Store {
  id   String @id @default(cuid())
  slug String @unique
  
  name   String
  nameEn String?
  city   String
  
  address      String
  addressEn    String?
  phone        String?
  email        String?
  
  latitude  Float?
  longitude Float?
  openingHours Json? // è¥ä¸šæ—¶é—´é…ç½®
  
  isActive Boolean @default(true)
  
  // å…³è”æ•°æ®
  kimonos      KimonoStore[]
  bookingItems BookingItem[]
}
```

**æ ¸å¿ƒç‰¹æ€§**:
- å¤šè¯­è¨€æ”¯æŒ
- åœ°ç†ä½ç½®ä¿¡æ¯
- çµæ´»çš„è¥ä¸šæ—¶é—´é…ç½®
- ä¸å’Œæœçš„åº“å­˜å…³è”

### 3.4 å¥—é¤ç³»ç»Ÿ

#### RentalPlan æ¨¡å‹
```prisma
model RentalPlan {
  id   String @id @default(cuid())
  slug String @unique
  
  name        String
  nameEn      String?
  description String
  
  category PlanCategory
  
  price         Int // äººæ°‘å¸ï¼ˆåˆ†ï¼‰
  depositAmount Int @default(0)
  duration      Int // å°æ—¶
  
  includes String[] // åŒ…å«çš„æœåŠ¡
  
  isActive Boolean @default(true)
  
  // å…³è”æ•°æ®
  bookingItems BookingItem[]
  cartItems    CartItem[]
}
```

### 3.5 æ´»åŠ¨ç³»ç»Ÿ

#### Campaign æ¨¡å‹
```prisma
model Campaign {
  id   String @id @default(cuid())
  slug String @unique
  
  title       String
  titleEn     String?
  description String
  subtitle    String?
  
  // æ—¶é—´ç®¡ç†
  startDate DateTime
  endDate   DateTime
  usageStartDate DateTime?
  usageEndDate   DateTime?
  
  // æ´»åŠ¨é…ç½®
  isActive  Boolean @default(true)
  isPinned  Boolean @default(false)
  priority  Int     @default(0)
  
  // åª’ä½“èµ„æº
  coverImage String?
  bannerImage String?
  
  type CampaignType @default(DISCOUNT)
  restrictions String[]
  terms String?
  
  campaignPlans CampaignPlan[]
}
```

#### CampaignPlan æ¨¡å‹
```prisma
model CampaignPlan {
  id         String @id @default(cuid())
  campaignId String
  
  name        String
  nameEn      String?
  description String
  
  // ä»·æ ¼é…ç½®
  originalPrice Int // åŸä»·ï¼ˆåˆ†ï¼‰
  campaignPrice Int // æ´»åŠ¨ä»·ï¼ˆåˆ†ï¼‰
  
  // å¥—é¤è¯¦æƒ…
  duration     Int?
  includes     String[]
  applicableStores String[] // é€‚ç”¨åº—é“º
  images       String[]
  
  // é™åˆ¶æ¡ä»¶
  maxBookings Int?
  currentBookings Int @default(0)
  isFeatured Boolean @default(false)
}
```

### 3.6 é¢„çº¦ç³»ç»Ÿ

#### Booking æ¨¡å‹
```prisma
model Booking {
  id String @id @default(cuid())
  
  // ç”¨æˆ·ä¿¡æ¯ï¼ˆæ”¯æŒæ¸¸å®¢é¢„çº¦ï¼‰
  userId     String?
  guestName  String?
  guestEmail String?
  guestPhone String?
  
  // åˆ°åº—ä¿¡æ¯
  visitDate DateTime
  visitTime String
  
  // é¢„çº¦é¡¹ï¼ˆæ”¯æŒå¤šä¸ªå¥—é¤ï¼Œè·¨åº—é“ºï¼‰
  items BookingItem[]
  
  // æ”¯ä»˜ä¿¡æ¯
  totalAmount   Int
  depositAmount Int
  paidAmount    Int            @default(0)
  paymentStatus PaymentStatus  @default(PENDING)
  paymentMethod String?
  
  // çŠ¶æ€ç®¡ç†
  status BookingStatus @default(PENDING)
  specialRequests String?
}
```

#### BookingItem æ¨¡å‹
```prisma
model BookingItem {
  id        String  @id @default(cuid())
  bookingId String
  
  // åº—é“ºä¿¡æ¯
  storeId String
  store   Store  @relation(fields: [storeId], references: [id])
  
  // å¥—é¤ç±»å‹
  type           String  // 'PLAN' | 'CAMPAIGN'
  planId         String?
  campaignPlanId String?
  
  // æ•°é‡å’Œä»·æ ¼
  quantity   Int @default(1)
  unitPrice  Int
  totalPrice Int
  
  // é™„åŠ ä¿¡æ¯
  addOns String[]
  notes  String?
  kimonos BookingKimono[]
}
```

### 3.7 è´­ç‰©è½¦ç³»ç»Ÿ

#### Cart æ¨¡å‹
```prisma
model Cart {
  id        String   @id @default(cuid())
  userId    String?  @unique // null è¡¨ç¤ºæ¸¸å®¢è´­ç‰©è½¦
  sessionId String?  @unique // æ¸¸å®¢ä½¿ç”¨ sessionId
  
  items     CartItem[]
  expiresAt DateTime // è´­ç‰©è½¦è¿‡æœŸæ—¶é—´ï¼ˆ7å¤©åï¼‰
}
```

#### CartItem æ¨¡å‹
```prisma
model CartItem {
  id     String @id @default(cuid())
  cartId String
  
  type           String  // 'PLAN' | 'CAMPAIGN'
  planId         String?
  campaignPlanId String?
  
  quantity Int      @default(1)
  addOns   String[] // é™„åŠ æœåŠ¡
  notes    String?  // å¤‡æ³¨
}
```

---

## 4. æ ¸å¿ƒä¸šåŠ¡æµç¨‹

### 4.1 ç”¨æˆ·æ³¨å†Œå’Œé‚®ç®±éªŒè¯æµç¨‹

```mermaid
sequenceDiagram
    participant U as ç”¨æˆ·
    participant F as å‰ç«¯
    participant A as API
    participant DB as æ•°æ®åº“
    participant E as é‚®ä»¶æœåŠ¡
    
    U->>F: å¡«å†™æ³¨å†Œè¡¨å•
    F->>A: POST /api/auth/register
    A->>DB: åˆ›å»ºç”¨æˆ·è®°å½•(emailVerified=null)
    A->>E: å‘é€éªŒè¯é‚®ä»¶
    E->>U: éªŒè¯é‚®ä»¶
    A->>F: è¿”å›æ³¨å†ŒæˆåŠŸ
    F->>U: æ˜¾ç¤ºéªŒè¯æç¤º
    
    U->>E: ç‚¹å‡»éªŒè¯é“¾æ¥
    E->>A: GET /verify-email?token=xxx
    A->>DB: éªŒè¯tokenå¹¶æ›´æ–°emailVerified
    A->>F: æ˜¾ç¤ºéªŒè¯æˆåŠŸ
    F->>U: è·³è½¬åˆ°ç™»å½•é¡µ
```

**å…³é”®å®ç°**:
```typescript
// æ³¨å†ŒAPIå®ç°
export async function POST(request: Request) {
  const { email, password, name } = await request.json();
  
  // å¯†ç åŠ å¯†
  const passwordHash = await bcrypt.hash(password, 12);
  
  // åˆ›å»ºç”¨æˆ·
  const user = await prisma.user.create({
    data: { email, passwordHash, name }
  });
  
  // ç”ŸæˆéªŒè¯token
  const token = await generateVerificationToken(email);
  
  // å‘é€éªŒè¯é‚®ä»¶
  await sendVerificationEmail(email, token);
  
  return NextResponse.json({ message: "æ³¨å†ŒæˆåŠŸ" });
}
```

### 4.2 å¥—é¤æµè§ˆå’Œé€‰æ‹©æµç¨‹

```mermaid
flowchart TD
    A[è®¿é—®å¥—é¤é¡µé¢] --> B[åŠ è½½å¥—é¤æ•°æ®]
    B --> C[æ˜¾ç¤ºå¥—é¤åˆ—è¡¨]
    C --> D[ç”¨æˆ·ç­›é€‰/æœç´¢]
    D --> E[é€‰æ‹©å¥—é¤]
    E --> F[åŠ å…¥è´­ç‰©è½¦]
    F --> G[é€‰æ‹©åº—é“º]
    G --> H[æ›´æ–°è´­ç‰©è½¦]
    H --> I[ç»§ç»­è´­ç‰©æˆ–å»ç»“ç®—]
```

**å…³é”®å®ç°**:
```typescript
// å¥—é¤é¡µé¢æ•°æ®è·å–
export default async function PlansPage() {
  const featuredPlans = await prisma.rentalPlan.findMany({
    where: { isActive: true },
    orderBy: { createdAt: "asc" },
    take: 6,
  });
  
  const stores = await prisma.store.findMany({
    where: { isActive: true },
    orderBy: { name: "asc" },
  });
  
  return <PlansClient featuredPlans={featuredPlans} stores={stores} />;
}
```

### 4.3 è´­ç‰©è½¦ç®¡ç†æµç¨‹

```mermaid
stateDiagram-v2
    [*] --> ç©ºè´­ç‰©è½¦
    ç©ºè´­ç‰©è½¦ --> æœ‰å•†å“: æ·»åŠ å¥—é¤
    æœ‰å•†å“ --> æœ‰å•†å“: ä¿®æ”¹æ•°é‡/åº—é“º
    æœ‰å•†å“ --> ç©ºè´­ç‰©è½¦: æ¸…ç©ºè´­ç‰©è½¦
    æœ‰å•†å“ --> é¢„çº¦é¡µé¢: å»é¢„çº¦
    ç©ºè´­ç‰©è½¦ --> å¥—é¤é¡µé¢: ç»§ç»­è´­ç‰©
```

**çŠ¶æ€ç®¡ç†å®ç°**:
```typescript
// Zustand è´­ç‰©è½¦çŠ¶æ€
export const useCartStore = create<CartStore>()(
  persist(
    (set, get) => ({
      items: [],
      
      addItem: (item) => {
        const existingIndex = get().items.findIndex(
          (i) => i.type === item.type && i.planId === item.planId
        );
        
        if (existingIndex >= 0) {
          // å¢åŠ æ•°é‡
          set(state => ({
            items: state.items.map((item, index) =>
              index === existingIndex 
                ? { ...item, quantity: item.quantity + 1 }
                : item
            )
          }));
        } else {
          // æ·»åŠ æ–°é¡¹
          set(state => ({
            items: [...state.items, { ...item, id: generateId(), quantity: 1 }]
          }));
        }
      },
      
      updateStore: (id, storeId, storeName) => {
        set(state => ({
          items: state.items.map(item =>
            item.id === id ? { ...item, storeId, storeName } : item
          )
        }));
      },
    }),
    { name: "cart-storage" } // localStorage æŒä¹…åŒ–
  )
);
```

### 4.4 é¢„çº¦ä¸‹å•æµç¨‹

```mermaid
sequenceDiagram
    participant U as ç”¨æˆ·
    participant C as è´­ç‰©è½¦
    participant B as é¢„çº¦é¡µé¢
    participant A as API
    participant DB as æ•°æ®åº“
    participant E as é‚®ä»¶æœåŠ¡
    
    U->>C: ç¡®è®¤è´­ç‰©è½¦å•†å“
    C->>B: è·³è½¬åˆ°é¢„çº¦é¡µé¢
    U->>B: å¡«å†™é¢„çº¦ä¿¡æ¯
    B->>A: POST /api/bookings
    A->>DB: æŒ‰åº—é“ºåˆ†ç»„åˆ›å»ºé¢„çº¦
    A->>E: å‘é€ç¡®è®¤é‚®ä»¶
    E->>U: é¢„çº¦ç¡®è®¤é‚®ä»¶
    A->>B: è¿”å›é¢„çº¦æˆåŠŸ
    B->>U: æ˜¾ç¤ºæˆåŠŸé¡µé¢
```

**é¢„çº¦åˆ›å»ºå®ç°**:
```typescript
// é¢„çº¦APIå®ç°
export async function POST(request: Request) {
  const data = await request.json();
  const session = await auth();
  
  // æŒ‰åº—é“ºåˆ†ç»„åˆ›å»ºé¢„çº¦
  const bookingPromises = Object.entries(itemsByStore).map(async ([storeId, storeItems]) => {
    const booking = await prisma.booking.create({
      data: {
        userId: session?.user?.id || null,
        guestName: data.guestName || session?.user?.name,
        guestEmail: data.guestEmail || session?.user?.email,
        visitDate: new Date(data.visitDate),
        visitTime: data.visitTime,
        totalAmount: calculateTotal(storeItems),
        items: {
          create: storeItems.map(item => ({
            storeId,
            type: item.type,
            planId: item.planId,
            quantity: item.quantity,
            unitPrice: item.price,
            totalPrice: item.price * item.quantity,
          }))
        }
      }
    });
    
    return booking;
  });
  
  const bookings = await Promise.all(bookingPromises);
  
  // å‘é€ç¡®è®¤é‚®ä»¶
  await sendBookingConfirmationEmail(email, name, bookings[0]);
  
  return NextResponse.json({ bookings });
}
```

### 4.5 é¢„çº¦ç®¡ç†æµç¨‹

```mermaid
flowchart TD
    A[ç”¨æˆ·ä¸ªäººä¸­å¿ƒ] --> B[æŸ¥çœ‹é¢„çº¦åˆ—è¡¨]
    B --> C{é¢„çº¦çŠ¶æ€}
    C -->|å¾…ç¡®è®¤| D[ç­‰å¾…ç¡®è®¤]
    C -->|å·²ç¡®è®¤| E[å‡†å¤‡åˆ°åº—]
    C -->|è¿›è¡Œä¸­| F[ä½¿ç”¨ä¸­]
    C -->|å·²å®Œæˆ| G[å·²å®Œæˆ]
    C -->|å¯å–æ¶ˆ| H[å–æ¶ˆé¢„çº¦]
    
    H --> I[å‘é€å–æ¶ˆé‚®ä»¶]
    I --> J[æ›´æ–°é¢„çº¦çŠ¶æ€]
```

---

## 5. ç›®å½•ç»“æ„è¯´æ˜

### 5.1 é¡¹ç›®æ ¹ç›®å½•

```
hefumiyabi-website/
â”œâ”€â”€ prisma/                    # æ•°æ®åº“ç›¸å…³
â”‚   â”œâ”€â”€ schema.prisma         # æ•°æ®åº“æ¨¡å‹å®šä¹‰
â”‚   â”œâ”€â”€ migrations/           # æ•°æ®åº“è¿ç§»æ–‡ä»¶
â”‚   â”œâ”€â”€ seed.ts              # æ•°æ®ç§å­æ–‡ä»¶
â”‚   â””â”€â”€ update-*.ts          # æ•°æ®æ›´æ–°è„šæœ¬
â”œâ”€â”€ public/                   # é™æ€èµ„æº
â”‚   â”œâ”€â”€ logo.png            # ç½‘ç«™Logo
â”‚   â””â”€â”€ *.svg               # å›¾æ ‡æ–‡ä»¶
â”œâ”€â”€ scripts/                 # è„šæœ¬æ–‡ä»¶
â”‚   â”œâ”€â”€ scraper.ts          # æ•°æ®çˆ¬è™«
â”‚   â””â”€â”€ test-db.ts          # æ•°æ®åº“æµ‹è¯•
â”œâ”€â”€ src/                     # æºä»£ç 
â””â”€â”€ é…ç½®æ–‡ä»¶...
```

### 5.2 src ç›®å½•ç»“æ„

```
src/
â”œâ”€â”€ app/                     # Next.js App Router
â”‚   â”œâ”€â”€ (auth)/             # è®¤è¯ç›¸å…³é¡µé¢
â”‚   â”‚   â”œâ”€â”€ layout.tsx      # è®¤è¯é¡µé¢å¸ƒå±€
â”‚   â”‚   â”œâ”€â”€ login/          # ç™»å½•é¡µé¢
â”‚   â”‚   â”œâ”€â”€ register/       # æ³¨å†Œé¡µé¢
â”‚   â”‚   â””â”€â”€ verify-email/   # é‚®ç®±éªŒè¯é¡µé¢
â”‚   â”œâ”€â”€ (main)/             # ä¸»è¦é¡µé¢
â”‚   â”‚   â”œâ”€â”€ layout.tsx      # ä¸»é¡µé¢å¸ƒå±€
â”‚   â”‚   â”œâ”€â”€ page.tsx        # é¦–é¡µ
â”‚   â”‚   â”œâ”€â”€ about/          # å…³äºæˆ‘ä»¬
â”‚   â”‚   â”œâ”€â”€ booking/        # é¢„çº¦ç›¸å…³
â”‚   â”‚   â”œâ”€â”€ campaigns/      # ä¼˜æƒ æ´»åŠ¨
â”‚   â”‚   â”œâ”€â”€ cart/           # è´­ç‰©è½¦
â”‚   â”‚   â”œâ”€â”€ contact/        # è”ç³»æˆ‘ä»¬
â”‚   â”‚   â”œâ”€â”€ faq/            # å¸¸è§é—®é¢˜
â”‚   â”‚   â”œâ”€â”€ kimonos/        # å’Œæœå±•ç¤º
â”‚   â”‚   â”œâ”€â”€ plans/          # ç§Ÿèµå¥—é¤
â”‚   â”‚   â”œâ”€â”€ profile/        # ç”¨æˆ·ä¸­å¿ƒ
â”‚   â”‚   â””â”€â”€ stores/         # åº—é“ºä¿¡æ¯
â”‚   â”œâ”€â”€ api/                # API è·¯ç”±
â”‚   â”‚   â”œâ”€â”€ auth/           # è®¤è¯API
â”‚   â”‚   â”œâ”€â”€ bookings/       # é¢„çº¦API
â”‚   â”‚   â”œâ”€â”€ kimonos/        # å’ŒæœAPI
â”‚   â”‚   â”œâ”€â”€ plans/          # å¥—é¤API
â”‚   â”‚   â””â”€â”€ stores/         # åº—é“ºAPI
â”‚   â”œâ”€â”€ globals.css         # å…¨å±€æ ·å¼
â”‚   â””â”€â”€ layout.tsx          # æ ¹å¸ƒå±€
â”œâ”€â”€ components/             # ç»„ä»¶åº“
â”‚   â”œâ”€â”€ auth/              # è®¤è¯ç»„ä»¶
â”‚   â”œâ”€â”€ booking/           # é¢„çº¦ç»„ä»¶
â”‚   â”œâ”€â”€ kimono/            # å’Œæœç»„ä»¶
â”‚   â”œâ”€â”€ layout/            # å¸ƒå±€ç»„ä»¶
â”‚   â”œâ”€â”€ providers/         # ä¸Šä¸‹æ–‡æä¾›è€…
â”‚   â””â”€â”€ ui/                # UI ç»„ä»¶
â”œâ”€â”€ hooks/                 # è‡ªå®šä¹‰Hooks
â”œâ”€â”€ lib/                   # å·¥å…·åº“
â”‚   â”œâ”€â”€ prisma.ts         # æ•°æ®åº“å®¢æˆ·ç«¯
â”‚   â”œâ”€â”€ email.ts          # é‚®ä»¶æœåŠ¡
â”‚   â”œâ”€â”€ tokens.ts         # Tokenç®¡ç†
â”‚   â””â”€â”€ utils.ts          # é€šç”¨å·¥å…·
â”œâ”€â”€ store/                # çŠ¶æ€ç®¡ç†
â”‚   â””â”€â”€ cart.ts           # è´­ç‰©è½¦çŠ¶æ€
â”œâ”€â”€ types/                # ç±»å‹å®šä¹‰
â”‚   â”œâ”€â”€ index.ts          # é€šç”¨ç±»å‹
â”‚   â””â”€â”€ next-auth.d.ts    # NextAuthç±»å‹æ‰©å±•
â””â”€â”€ auth.ts               # è®¤è¯é…ç½®
```

### 5.3 ç»„ä»¶ç»“æ„

```
components/
â”œâ”€â”€ auth/
â”‚   â””â”€â”€ EmailVerificationBanner.tsx  # é‚®ç®±éªŒè¯æç¤º
â”œâ”€â”€ booking/
â”‚   â”œâ”€â”€ Step1SelectStore.tsx         # é€‰æ‹©åº—é“ºæ­¥éª¤
â”‚   â”œâ”€â”€ Step2PersonalInfo.tsx        # ä¸ªäººä¿¡æ¯æ­¥éª¤
â”‚   â”œâ”€â”€ Step3AddOns.tsx             # é™„åŠ æœåŠ¡æ­¥éª¤
â”‚   â”œâ”€â”€ Step4Confirm.tsx            # ç¡®è®¤è®¢å•æ­¥éª¤
â”‚   â””â”€â”€ StepIndicator.tsx           # æ­¥éª¤æŒ‡ç¤ºå™¨
â”œâ”€â”€ kimono/
â”‚   â”œâ”€â”€ FavoriteButton.tsx          # æ”¶è—æŒ‰é’®
â”‚   â”œâ”€â”€ KimonoCard.tsx              # å’Œæœå¡ç‰‡
â”‚   â”œâ”€â”€ KimonoFilter.tsx            # å’Œæœç­›é€‰å™¨
â”‚   â””â”€â”€ KimonoGrid.tsx              # å’Œæœç½‘æ ¼
â”œâ”€â”€ layout/
â”‚   â”œâ”€â”€ Footer.tsx                   # é¡µè„š
â”‚   â”œâ”€â”€ Header.tsx                   # é¡µå¤´
â”‚   â”œâ”€â”€ HeaderActions.tsx            # å¤´éƒ¨æ“ä½œæŒ‰é’®
â”‚   â”œâ”€â”€ HeaderClient.tsx             # å¤´éƒ¨å®¢æˆ·ç«¯ç»„ä»¶
â”‚   â””â”€â”€ UserMenu.tsx                 # ç”¨æˆ·èœå•
â”œâ”€â”€ providers/
â”‚   â””â”€â”€ SessionProvider.tsx          # ä¼šè¯æä¾›è€…
â””â”€â”€ ui/                             # åŸºç¡€UIç»„ä»¶
    â”œâ”€â”€ button.tsx
    â”œâ”€â”€ input.tsx
    â””â”€â”€ ...
```

### 5.4 API è·¯ç”±ç»“æ„

```
api/
â”œâ”€â”€ auth/
â”‚   â”œâ”€â”€ [...nextauth]/
â”‚   â”‚   â””â”€â”€ route.ts                # NextAuthé…ç½®
â”‚   â”œâ”€â”€ register/
â”‚   â”‚   â””â”€â”€ route.ts                # ç”¨æˆ·æ³¨å†Œ
â”‚   â”œâ”€â”€ send-verification/
â”‚   â”‚   â””â”€â”€ route.ts                # é‡å‘éªŒè¯é‚®ä»¶
â”‚   â””â”€â”€ verify-email/
â”‚       â””â”€â”€ route.ts                # é‚®ç®±éªŒè¯
â”œâ”€â”€ bookings/
â”‚   â”œâ”€â”€ route.ts                    # åˆ›å»ºé¢„çº¦
â”‚   â””â”€â”€ [id]/
â”‚       â”œâ”€â”€ route.ts                # è·å–/æ›´æ–°é¢„çº¦
â”‚       â””â”€â”€ cancel/
â”‚           â””â”€â”€ route.ts            # å–æ¶ˆé¢„çº¦
â”œâ”€â”€ kimonos/
â”‚   â”œâ”€â”€ route.ts                    # è·å–å’Œæœåˆ—è¡¨
â”‚   â””â”€â”€ [id]/
â”‚       â””â”€â”€ route.ts                # è·å–å’Œæœè¯¦æƒ…
â”œâ”€â”€ plans/
â”‚   â”œâ”€â”€ route.ts                    # è·å–å¥—é¤åˆ—è¡¨
â”‚   â””â”€â”€ [id]/
â”‚       â””â”€â”€ route.ts                # è·å–å¥—é¤è¯¦æƒ…
â””â”€â”€ stores/
    â”œâ”€â”€ route.ts                    # è·å–åº—é“ºåˆ—è¡¨
    â””â”€â”€ [id]/
        â””â”€â”€ route.ts                # è·å–åº—é“ºè¯¦æƒ…
```

---

## 6. å…³é”®åŠŸèƒ½å®ç°

### 6.1 NextAuth è®¤è¯ç³»ç»Ÿ

#### è®¤è¯é…ç½®
```typescript
// src/auth.ts
export const { handlers, auth, signIn, signOut } = NextAuth({
  adapter: PrismaAdapter(prisma),
  session: {
    strategy: "jwt",
  },
  pages: {
    signIn: "/login",
    newUser: "/register",
  },
  providers: [
    CredentialsProvider({
      name: "credentials",
      credentials: {
        email: { label: "é‚®ç®±", type: "email" },
        password: { label: "å¯†ç ", type: "password" },
      },
      async authorize(credentials) {
        if (!credentials?.email || !credentials?.password) {
          return null;
        }

        const user = await prisma.user.findUnique({
          where: { email: credentials.email as string },
        });

        if (!user || !user.passwordHash) {
          return null;
        }

        const isPasswordValid = await bcrypt.compare(
          credentials.password as string,
          user.passwordHash
        );

        if (!isPasswordValid) {
          return null;
        }

        return {
          id: user.id,
          email: user.email,
          name: user.name,
          role: user.role,
        };
      },
    }),
  ],
  callbacks: {
    async jwt({ token, user }) {
      if (user) {
        token.id = user.id;
        token.role = user.role;
      }
      return token;
    },
    async session({ session, token }) {
      if (session.user) {
        session.user.id = token.id as string;
        session.user.role = token.role as string;
      }
      return session;
    },
  },
});
```

#### ä¼šè¯ç®¡ç†
```typescript
// æœåŠ¡ç«¯è·å–ä¼šè¯
import { auth } from "@/auth";

export default async function ProfilePage() {
  const session = await auth();
  
  if (!session?.user) {
    redirect("/login");
  }
  
  // ä½¿ç”¨ä¼šè¯æ•°æ®...
}

// å®¢æˆ·ç«¯è·å–ä¼šè¯
"use client";
import { useSession } from "next-auth/react";

export default function Header() {
  const { data: session } = useSession();
  
  return (
    <div>
      {session?.user ? (
        <UserMenu user={session.user} />
      ) : (
        <LoginButton />
      )}
    </div>
  );
}
```

### 6.2 Zustand çŠ¶æ€ç®¡ç†

#### è´­ç‰©è½¦çŠ¶æ€å®ç°
```typescript
// src/store/cart.ts
import { create } from "zustand";
import { persist } from "zustand/middleware";

export interface CartItem {
  id: string;
  type: "PLAN" | "CAMPAIGN";
  planId?: string;
  campaignPlanId?: string;
  name: string;
  price: number;
  quantity: number;
  addOns: string[];
  storeId?: string;
  storeName?: string;
}

interface CartStore {
  items: CartItem[];
  addItem: (item: Omit<CartItem, "id" | "quantity">) => void;
  updateQuantity: (id: string, quantity: number) => void;
  removeItem: (id: string) => void;
  updateStore: (id: string, storeId: string, storeName: string) => void;
  clearCart: () => void;
  getTotalPrice: () => number;
  getTotalItems: () => number;
}

export const useCartStore = create<CartStore>()(
  persist(
    (set, get) => ({
      items: [],

      addItem: (item) => {
        const items = get().items;
        const existingIndex = items.findIndex(
          (i) => i.type === item.type && i.planId === item.planId
        );

        if (existingIndex >= 0) {
          const newItems = [...items];
          newItems[existingIndex].quantity += 1;
          set({ items: newItems });
        } else {
          set({
            items: [
              ...items,
              {
                ...item,
                id: `cart-${Date.now()}-${Math.random()}`,
                quantity: 1,
              },
            ],
          });
        }
      },

      updateQuantity: (id, quantity) => {
        if (quantity <= 0) {
          get().removeItem(id);
          return;
        }

        set({
          items: get().items.map((item) =>
            item.id === id ? { ...item, quantity } : item
          ),
        });
      },

      removeItem: (id) => {
        set({
          items: get().items.filter((item) => item.id !== id),
        });
      },

      updateStore: (id, storeId, storeName) => {
        set({
          items: get().items.map((item) =>
            item.id === id ? { ...item, storeId, storeName } : item
          ),
        });
      },

      clearCart: () => {
        set({ items: [] });
      },

      getTotalPrice: () => {
        return get().items.reduce(
          (total, item) => total + item.price * item.quantity,
          0
        );
      },

      getTotalItems: () => {
        return get().items.reduce((total, item) => total + item.quantity, 0);
      },
    }),
    {
      name: "cart-storage", // localStorage key
    }
  )
);
```

### 6.3 é‚®ä»¶ç³»ç»Ÿ

#### é‚®ä»¶æœåŠ¡é…ç½®
```typescript
// src/lib/email.ts
import nodemailer from "nodemailer";

const transporter = nodemailer.createTransporter({
  host: process.env.SMTP_HOST,
  port: parseInt(process.env.SMTP_PORT || "587"),
  secure: process.env.SMTP_PORT === "465",
  auth: {
    user: process.env.SMTP_USER,
    pass: process.env.SMTP_PASSWORD,
  },
});

export async function sendVerificationEmail(email: string, token: string) {
  const verificationUrl = `${process.env.NEXTAUTH_URL}/verify-email?token=${token}`;

  const mailOptions = {
    from: process.env.SMTP_FROM,
    to: email,
    subject: "éªŒè¯æ‚¨çš„é‚®ç®± - æ±Ÿæˆ¸å’Œè£…å·¥æˆ¿é›…",
    html: `
      <!DOCTYPE html>
      <html>
        <head>
          <meta charset="utf-8">
          <style>
            /* ç²¾ç¾çš„é‚®ä»¶æ ·å¼ */
            .container {
              background: linear-gradient(135deg, #fce7f3 0%, #fbcfe8 100%);
              border-radius: 20px;
              padding: 40px;
              text-align: center;
            }
          </style>
        </head>
        <body>
          <div class="container">
            <div class="logo">ğŸŒ¸ æ±Ÿæˆ¸å’Œè£…å·¥æˆ¿é›…</div>
            <h1>æ¬¢è¿æ³¨å†Œï¼</h1>
            <p>è¯·ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®éªŒè¯æ‚¨çš„é‚®ç®±åœ°å€ï¼š</p>
            <a href="${verificationUrl}" class="button">éªŒè¯é‚®ç®±</a>
          </div>
        </body>
      </html>
    `,
  };

  try {
    await transporter.sendMail(mailOptions);
    return { success: true };
  } catch (error) {
    console.error("Email sending error:", error);
    return { success: false, error };
  }
}
```

#### é¢„çº¦ç¡®è®¤é‚®ä»¶
```typescript
export async function sendBookingConfirmationEmail(
  email: string,
  name: string,
  booking: any
) {
  const mailOptions = {
    from: process.env.SMTP_FROM,
    to: email,
    subject: "é¢„çº¦ç¡®è®¤ - æ±Ÿæˆ¸å’Œè£…å·¥æˆ¿é›…",
    html: `
      <div class="container">
        <div class="logo">ğŸŒ¸ æ±Ÿæˆ¸å’Œè£…å·¥æˆ¿é›…</div>
        <h1>é¢„çº¦ç¡®è®¤</h1>
        <p>å°Šæ•¬çš„ ${name}ï¼Œæ„Ÿè°¢æ‚¨çš„é¢„çº¦ï¼</p>
        
        <div class="booking-info">
          <h3>é¢„çº¦è¯¦æƒ…</h3>
          <div class="info-row">
            <div class="info-label">é¢„çº¦ç¼–å·ï¼š</div>
            <div class="info-value">${booking.id}</div>
          </div>
          <div class="info-row">
            <div class="info-label">åˆ°åº—æ—¥æœŸï¼š</div>
            <div class="info-value">${new Date(booking.visitDate).toLocaleDateString("zh-CN")}</div>
          </div>
          <div class="info-row">
            <div class="info-label">åˆ°åº—æ—¶é—´ï¼š</div>
            <div class="info-value">${booking.visitTime}</div>
          </div>
        </div>
        
        <div class="notice">
          <strong>æ¸©é¦¨æç¤ºï¼š</strong>
          <ul>
            <li>è¯·åœ¨é¢„çº¦æ—¶é—´å‰15åˆ†é’Ÿåˆ°åº—</li>
            <li>åˆ°åº—åå·¥ä½œäººå‘˜å°†ä¸ºæ‚¨é€‰æ‹©åˆé€‚çš„å’Œæœ</li>
            <li>å¦‚éœ€å–æ¶ˆæˆ–ä¿®æ”¹é¢„çº¦ï¼Œè¯·æå‰3å¤©è”ç³»æˆ‘ä»¬</li>
          </ul>
        </div>
      </div>
    `,
  };

  await transporter.sendMail(mailOptions);
}
```

### 6.4 è´­ç‰©è½¦æŒä¹…åŒ–

#### æœ¬åœ°å­˜å‚¨ç­–ç•¥
```typescript
// è´­ç‰©è½¦çŠ¶æ€æŒä¹…åŒ–åˆ° localStorage
export const useCartStore = create<CartStore>()(
  persist(
    (set, get) => ({
      // çŠ¶æ€é€»è¾‘...
    }),
    {
      name: "cart-storage",
      // è‡ªå®šä¹‰åºåˆ—åŒ–
      serialize: (state) => JSON.stringify(state),
      deserialize: (str) => JSON.parse(str),
      // éƒ¨åˆ†çŠ¶æ€æŒä¹…åŒ–
      partialize: (state) => ({
        items: state.items,
      }),
    }
  )
);
```

#### æ¸¸å®¢è´­ç‰©è½¦å¤„ç†
```typescript
// æ¸¸å®¢è´­ç‰©è½¦ä½¿ç”¨ sessionId
const cart = await prisma.cart.upsert({
  where: { sessionId: sessionId },
  update: {
    items: {
      create: cartItemData,
    },
  },
  create: {
    sessionId: sessionId,
    expiresAt: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000), // 7å¤©è¿‡æœŸ
    items: {
      create: cartItemData,
    },
  },
});
```

### 6.5 å¤šåº—é“ºé¢„çº¦

#### æŒ‰åº—é“ºåˆ†ç»„é¢„çº¦
```typescript
// é¢„çº¦åˆ›å»ºæ—¶æŒ‰åº—é“ºåˆ†ç»„
export async function POST(request: Request) {
  const data = await request.json();
  const { items } = data;
  
  // æŒ‰åº—é“ºåˆ†ç»„
  const itemsByStore = items.reduce((acc, item) => {
    const storeId = item.storeId;
    if (!acc[storeId]) {
      acc[storeId] = [];
    }
    acc[storeId].push(item);
    return acc;
  }, {} as Record<string, typeof items>);
  
  // ä¸ºæ¯ä¸ªåº—é“ºåˆ›å»ºé¢„çº¦
  const bookingPromises = Object.entries(itemsByStore).map(async ([storeId, storeItems]) => {
    const booking = await prisma.booking.create({
      data: {
        userId: session?.user?.id || null,
        guestName: data.guestName,
        guestEmail: data.guestEmail,
        visitDate: new Date(data.visitDate),
        visitTime: data.visitTime,
        totalAmount: storeItems.reduce((sum, item) => sum + item.totalPrice, 0),
        items: {
          create: storeItems.map(item => ({
            storeId,
            type: item.type,
            planId: item.planId,
            campaignPlanId: item.campaignPlanId,
            quantity: item.quantity,
            unitPrice: item.unitPrice,
            totalPrice: item.totalPrice,
            addOns: item.addOns,
            notes: item.notes,
          }))
        }
      },
      include: {
        items: {
          include: {
            store: true,
            plan: true,
          }
        }
      }
    });
    
    return booking;
  });
  
  const bookings = await Promise.all(bookingPromises);
  return NextResponse.json({ bookings });
}
```

---

## 7. å¼€å‘å’Œéƒ¨ç½²æŒ‡å—

### 7.1 ç¯å¢ƒé…ç½®

#### å¿…éœ€çš„ç¯å¢ƒå˜é‡
```bash
# .env.local
# æ•°æ®åº“
DATABASE_URL="postgresql://username:password@localhost:5432/hefumiyabi"

# NextAuth
NEXTAUTH_URL="http://localhost:3000"
NEXTAUTH_SECRET="your-secret-key"

# é‚®ä»¶æœåŠ¡
SMTP_HOST="smtp.gmail.com"
SMTP_PORT="587"
SMTP_USER="your-email@gmail.com"
SMTP_PASSWORD="your-app-password"
SMTP_FROM="æ±Ÿæˆ¸å’Œè£…å·¥æˆ¿é›… <your-email@gmail.com>"
```

#### å¼€å‘ç¯å¢ƒè®¾ç½®
```bash
# 1. å®‰è£…ä¾èµ–
pnpm install

# 2. è®¾ç½®ç¯å¢ƒå˜é‡
cp .env.example .env.local
# ç¼–è¾‘ .env.local æ–‡ä»¶

# 3. è¿è¡Œæ•°æ®åº“è¿ç§»
pnpm prisma migrate dev

# 4. ç”Ÿæˆ Prisma å®¢æˆ·ç«¯
pnpm prisma generate

# 5. ç§å­æ•°æ®ï¼ˆå¯é€‰ï¼‰
pnpm db:seed

# 6. å¯åŠ¨å¼€å‘æœåŠ¡å™¨
pnpm dev
```

### 7.2 å¼€å‘æµç¨‹

#### æ•°æ®åº“å¼€å‘æµç¨‹
```bash
# 1. ä¿®æ”¹ schema.prisma
# 2. åˆ›å»ºè¿ç§»
pnpm prisma migrate dev --name "add_new_field"

# 3. é‡ç½®æ•°æ®åº“ï¼ˆå¼€å‘æ—¶ï¼‰
pnpm db:reset

# 4. æŸ¥çœ‹æ•°æ®åº“
pnpm prisma studio
```

#### ä»£ç å¼€å‘æµç¨‹
```bash
# 1. åˆ›å»ºåŠŸèƒ½åˆ†æ”¯
git checkout -b feature/new-feature

# 2. å¼€å‘åŠŸèƒ½
# - ä¿®æ”¹/æ·»åŠ ç»„ä»¶
# - æ›´æ–°APIè·¯ç”±
# - æµ‹è¯•åŠŸèƒ½

# 3. ä»£ç æ£€æŸ¥
pnpm lint

# 4. æ„å»ºæµ‹è¯•
pnpm build

# 5. æäº¤ä»£ç 
git add .
git commit -m "feat: add new feature"
git push origin feature/new-feature
```

### 7.3 æ•°æ®åº“è¿ç§»

#### è¿ç§»æ–‡ä»¶ç»“æ„
```
prisma/
â”œâ”€â”€ migrations/
â”‚   â”œâ”€â”€ 20250114053455_init/
â”‚   â”‚   â””â”€â”€ migration.sql
â”‚   â”œâ”€â”€ 20250114194920_add_campaign_system/
â”‚   â”‚   â””â”€â”€ migration.sql
â”‚   â””â”€â”€ migration_lock.toml
â””â”€â”€ schema.prisma
```

#### è¿ç§»æœ€ä½³å®è·µ
```sql
-- æ·»åŠ æ–°å­—æ®µï¼ˆå‘åå…¼å®¹ï¼‰
ALTER TABLE "users" ADD COLUMN "new_field" TEXT;

-- åˆ›å»ºæ–°è¡¨
CREATE TABLE "new_table" (
    "id" TEXT NOT NULL,
    "name" TEXT NOT NULL,
    "created_at" TIMESTAMP(3) NOT NULL DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT "new_table_pkey" PRIMARY KEY ("id")
);

-- åˆ›å»ºç´¢å¼•
CREATE INDEX "users_email_idx" ON "users"("email");
CREATE UNIQUE INDEX "users_phone_key" ON "users"("phone");
```

### 7.4 éƒ¨ç½²æ³¨æ„äº‹é¡¹

#### Vercel éƒ¨ç½²é…ç½®
```json
// vercel.json
{
  "buildCommand": "pnpm build",
  "devCommand": "pnpm dev",
  "installCommand": "pnpm install",
  "framework": "nextjs",
  "env": {
    "DATABASE_URL": "@database-url",
    "NEXTAUTH_SECRET": "@nextauth-secret",
    "SMTP_HOST": "@smtp-host",
    "SMTP_USER": "@smtp-user",
    "SMTP_PASSWORD": "@smtp-password"
  }
}
```

#### ç”Ÿäº§ç¯å¢ƒä¼˜åŒ–
```typescript
// next.config.ts
const nextConfig = {
  // å›¾ç‰‡ä¼˜åŒ–
  images: {
    domains: ['your-domain.com'],
    formats: ['image/webp', 'image/avif'],
  },
  
  // æ€§èƒ½ä¼˜åŒ–
  experimental: {
    optimizePackageImports: ['lucide-react'],
  },
  
  // å®‰å…¨é…ç½®
  async headers() {
    return [
      {
        source: '/api/:path*',
        headers: [
          { key: 'Access-Control-Allow-Origin', value: '*' },
          { key: 'Access-Control-Allow-Methods', value: 'GET, POST, PUT, DELETE' },
        ],
      },
    ];
  },
};
```

#### æ•°æ®åº“ç”Ÿäº§é…ç½®
```typescript
// ç”Ÿäº§ç¯å¢ƒæ•°æ®åº“è¿æ¥æ± é…ç½®
const prisma = new PrismaClient({
  datasources: {
    db: {
      url: process.env.DATABASE_URL,
    },
  },
  log: process.env.NODE_ENV === 'development' ? ['query', 'error', 'warn'] : ['error'],
});
```

#### ç›‘æ§å’Œæ—¥å¿—
```typescript
// é”™è¯¯ç›‘æ§
export async function POST(request: Request) {
  try {
    // API é€»è¾‘
  } catch (error) {
    console.error('API Error:', error);
    
    // å‘é€åˆ°ç›‘æ§æœåŠ¡ï¼ˆå¦‚ Sentryï¼‰
    // Sentry.captureException(error);
    
    return NextResponse.json(
      { error: 'Internal server error' },
      { status: 500 }
    );
  }
}
```

### 7.5 æ€§èƒ½ä¼˜åŒ–å»ºè®®

#### æ•°æ®åº“æŸ¥è¯¢ä¼˜åŒ–
```typescript
// ä½¿ç”¨ include é¢„åŠ è½½å…³è”æ•°æ®
const bookings = await prisma.booking.findMany({
  include: {
    items: {
      include: {
        store: true,
        plan: true,
      }
    },
    user: true,
  },
});

// ä½¿ç”¨ select åªé€‰æ‹©éœ€è¦çš„å­—æ®µ
const users = await prisma.user.findMany({
  select: {
    id: true,
    name: true,
    email: true,
  },
});
```

#### å›¾ç‰‡ä¼˜åŒ–
```typescript
// ä½¿ç”¨ Next.js Image ç»„ä»¶
import Image from 'next/image';

<Image
  src="/kimono-image.jpg"
  alt="å’Œæœå›¾ç‰‡"
  width={400}
  height={600}
  priority={false} // éå…³é”®å›¾ç‰‡ä¸é¢„åŠ è½½
  placeholder="blur"
  blurDataURL="data:image/jpeg;base64,..."
/>
```

#### ç¼“å­˜ç­–ç•¥
```typescript
// API è·¯ç”±ç¼“å­˜
export async function GET() {
  const data = await fetchData();
  
  return NextResponse.json(data, {
    headers: {
      'Cache-Control': 'public, s-maxage=60, stale-while-revalidate=300',
    },
  });
}

// é™æ€é¡µé¢ç”Ÿæˆ
export async function generateStaticParams() {
  const kimonos = await prisma.kimono.findMany({
    select: { id: true },
  });
  
  return kimonos.map((kimono) => ({
    id: kimono.id,
  }));
}
```

---

## æ€»ç»“

æ±Ÿæˆ¸å’Œè£…å·¥æˆ¿é›…å’Œæœç§Ÿèµç½‘ç«™é‡‡ç”¨äº†ç°ä»£åŒ–çš„å…¨æ ˆæŠ€æœ¯æ¶æ„ï¼Œå…·æœ‰ä»¥ä¸‹ç‰¹ç‚¹ï¼š

### æŠ€æœ¯ä¼˜åŠ¿
- **ç±»å‹å®‰å…¨**: å…¨é¢çš„ TypeScript æ”¯æŒ
- **å¼€å‘æ•ˆç‡**: Next.js 14 + Prisma æä¾›ä¼˜ç§€çš„å¼€å‘ä½“éªŒ
- **ç”¨æˆ·ä½“éªŒ**: å“åº”å¼è®¾è®¡ï¼Œæ”¯æŒå¤šè¯­è¨€
- **å¯æ‰©å±•æ€§**: æ¨¡å—åŒ–æ¶æ„ï¼Œæ˜“äºæ‰©å±•æ–°åŠŸèƒ½
- **å®‰å…¨æ€§**: å®Œå–„çš„è®¤è¯ç³»ç»Ÿå’Œæ•°æ®éªŒè¯

### ä¸šåŠ¡ç‰¹è‰²
- **å¤šåº—é“ºæ”¯æŒ**: çµæ´»çš„å¤šåº—é“ºç®¡ç†
- **æ™ºèƒ½é¢„çº¦**: æ”¯æŒè·¨åº—é“ºé¢„çº¦å’Œå¥—é¤ç»„åˆ
- **ä¼˜æƒ æ´»åŠ¨**: å®Œæ•´çš„æ´»åŠ¨ç®¡ç†ç³»ç»Ÿ
- **æ¸¸å®¢å‹å¥½**: æ”¯æŒæ¸¸å®¢é¢„çº¦ï¼Œé™ä½ä½¿ç”¨é—¨æ§›
- **é‚®ä»¶é€šçŸ¥**: å®Œæ•´çš„é‚®ä»¶é€šçŸ¥ç³»ç»Ÿ

### æœªæ¥æ‰©å±•æ–¹å‘
- æ”¯ä»˜ç³»ç»Ÿé›†æˆ
- å®æ—¶åº“å­˜ç®¡ç†
- ç§»åŠ¨ç«¯ App
- å¤šè¯­è¨€å›½é™…åŒ–
- æ•°æ®åˆ†æé¢æ¿
- å®¢æœç³»ç»Ÿé›†æˆ

è¿™ä¸ªæ¶æ„ä¸ºå’Œæœç§Ÿèµä¸šåŠ¡æä¾›äº†åšå®çš„æŠ€æœ¯åŸºç¡€ï¼Œæ”¯æŒä¸šåŠ¡çš„å¿«é€Ÿå‘å±•å’ŒåŠŸèƒ½æ‰©å±•ã€‚
