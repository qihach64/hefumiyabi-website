generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id            String          @id @default(cuid())
  email         String?         @unique
  emailVerified DateTime?
  phone         String?         @unique
  phoneVerified DateTime?
  passwordHash  String?
  name          String?
  avatar        String?
  role          Role            @default(USER)
  language      Language        @default(ZH)
  birthday      DateTime?
  gender        Gender?
  source        String?
  referralCode  String?         @unique
  referredBy    String?
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt
  accounts      Account[]
  bookings      Booking[]
  cart          Cart?
  favorites     Favorite[]
  reviews       Review[]
  sessions      Session[]
  behaviors     UserBehavior[]
  preference    UserPreference?
  referrer      User?           @relation("Referrals", fields: [referredBy], references: [id])
  referrals     User[]          @relation("Referrals")
  merchant      Merchant?

  @@index([email])
  @@index([phone])
  @@map("users")
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?
  user              User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@map("accounts")
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@map("verification_tokens")
}

model UserPreference {
  id                String   @id @default(cuid())
  userId            String   @unique
  preferredStyles   String[]
  preferredColors   String[]
  preferredPatterns String[]
  height            Int?
  shoeSize          Float?
  emailNotification Boolean  @default(true)
  smsNotification   Boolean  @default(false)
  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_preferences")
}

model Kimono {
  id           String          @id @default(cuid())
  code         String          @unique
  name         String
  nameEn       String?
  description  String?
  category     KimonoCategory
  style        String
  color        String[]
  pattern      String[]
  season       Season[]
  size         String
  isAvailable  Boolean         @default(true)
  viewCount    Int             @default(0)
  bookingCount Int             @default(0)
  createdAt    DateTime        @default(now())
  updatedAt    DateTime        @updatedAt
  bookings     BookingKimono[]
  favorites    Favorite[]
  images       KimonoImage[]
  stores       KimonoStore[]

  @@index([category])
  @@index([isAvailable])
  @@map("kimonos")
}

model KimonoImage {
  id       String  @id @default(cuid())
  kimonoId String
  url      String
  alt      String?
  order    Int     @default(0)
  kimono   Kimono  @relation(fields: [kimonoId], references: [id], onDelete: Cascade)

  @@map("kimono_images")
}

model Merchant {
  id             String           @id @default(cuid())
  ownerId        String           @unique
  businessName   String
  legalName      String?
  description    String?
  logo           String?
  status         MerchantStatus   @default(PENDING)
  verified       Boolean          @default(false)
  commissionRate Float            @default(0.15)
  bankAccount    String?
  taxId          String?
  totalBookings  Int              @default(0)
  totalRevenue   Int              @default(0)
  rating         Float?
  reviewCount    Int              @default(0)
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt
  owner          User             @relation(fields: [ownerId], references: [id], onDelete: Cascade)
  stores         Store[]
  listings       Listing[]
  rentalPlans    RentalPlan[]
  bookings       Booking[]
  reviews        MerchantReview[]
  payouts        Payout[]
  components     MerchantComponent[]  // 商户组件实例

  @@index([status])
  @@index([verified])
  @@map("merchants")
}

model Store {
  id           String        @id @default(cuid())
  slug         String        @unique
  name         String
  nameEn       String?
  city         String
  address      String
  addressEn    String?
  phone        String?
  email        String?
  latitude     Float?
  longitude    Float?
  openingHours Json?
  isActive     Boolean       @default(true)
  merchantId   String?
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  merchant     Merchant?     @relation(fields: [merchantId], references: [id])
  bookingItems BookingItem[]
  kimonos      KimonoStore[]
  listings     Listing[]
  planStores   PlanStore[]   // 店铺可售套餐 (1:N via junction)

  @@index([merchantId])
  @@map("stores")
}

model KimonoStore {
  id       String @id @default(cuid())
  kimonoId String
  storeId  String
  quantity Int    @default(1)
  kimono   Kimono @relation(fields: [kimonoId], references: [id], onDelete: Cascade)
  store    Store  @relation(fields: [storeId], references: [id], onDelete: Cascade)

  @@unique([kimonoId, storeId])
  @@map("kimono_stores")
}

// ============================================
// 主题系统 (Theme System)
// ============================================

model Theme {
  id           String       @id @default(cuid())
  slug         String       @unique  // trendy-photo, formal-ceremony...

  // 默认语言（中文）
  name         String                // 潮流出片
  description  String?      @db.Text // 详细说明

  // 多语言翻译 JSON: { "en": { "name": "...", "description": "..." }, "ja": { ... } }
  translations Json?

  icon         String?               // emoji 或 lucide icon name
  color        String?               // 主题色 hex，如 #FF6B6B
  coverImage   String?               // 主题封面图
  displayOrder Int          @default(0)
  isActive     Boolean      @default(true)

  // 季节限定控制（主题级别）
  seasonStart  DateTime?    // 季节开始日期
  seasonEnd    DateTime?    // 季节结束日期

  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt

  // 关联
  plans        RentalPlan[]
  mapTemplate  MapTemplate?  // 地图模板（1:1，可选，无则使用默认模板）

  @@index([isActive, displayOrder])
  @@index([seasonStart, seasonEnd])
  @@map("themes")
}

model RentalPlan {
  id            String        @id @default(cuid())
  slug          String        @unique

  // 默认语言（中文）
  name          String
  description   String
  highlights    String?       // 核心卖点描述

  // 多语言翻译 JSON: { "en": { "name": "...", "description": "..." }, "ja": { ... } }
  translations  Json?

  price         Int
  originalPrice Int?
  depositAmount Int           @default(0)
  duration      Int
  includes      String[]
  imageUrl      String?
  images        String[]      @default([])  // 多图支持
  customMapImageUrl String?   @map("custom_map_image_url")  // 自定义热点图背景

  // ========== 计价单位 (Pricing Unit) ==========
  // "person" = 按人计价 (女士套餐 ¥8,800/人)
  // "group" = 按组计价 (情侣套餐 ¥15,000/组)
  pricingUnit     String   @default("person") @map("pricing_unit")
  unitLabel       String   @default("人") @map("unit_label")     // 显示: "人" | "組" | "套"
  unitDescription String?  @map("unit_description")               // "2人" | "2大人+1小孩" | null
  minQuantity     Int      @default(1) @map("min_quantity")
  maxQuantity     Int      @default(10) @map("max_quantity")

  // 主题关联
  themeId  String?
  theme    Theme?    @relation(fields: [themeId], references: [id], onDelete: SetNull)

  // 商家所有权
  merchantId String?
  merchant   Merchant? @relation(fields: [merchantId], references: [id], onDelete: Cascade)
  createdBy  String?       // 创建者 User ID

  // 店铺和地区信息
  storeName String?
  region    String?
  tags      String[]      @default([])  // 保留旧字段，后续可移除

  // 活动关联
  campaignId String?
  campaign   Campaign? @relation(fields: [campaignId], references: [id], onDelete: SetNull)

  // 活动特性
  isCampaign      Boolean @default(false)
  isLimited       Boolean @default(false)
  maxBookings     Int?
  currentBookings Int     @default(0)

  // 时间/季节限制（套餐级别，覆盖 Theme 级别）
  availableFrom  DateTime?
  availableUntil DateTime?

  // 发布状态
  status       PlanStatus @default(PUBLISHED)

  isActive     Boolean @default(true)
  isFeatured   Boolean @default(false)
  displayOrder Int     @default(0)  // 在主题内的排序

  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt

  // 关联
  bookingItems   BookingItem[]
  cartItems      CartItem[]
  planTags       PlanTag[]
  planComponents PlanComponent[]  // 套餐包含的服务组件
  planUpgrades   PlanUpgrade[]    // 套餐可选的升级服务
  planStores     PlanStore[]      // 套餐可用店铺 (1:N)
  favorites      Favorite[]       // 用户收藏

  @@index([merchantId])
  @@index([themeId])
  @@index([themeId, isActive, displayOrder])
  @@index([campaignId])
  @@index([isCampaign])
  @@index([availableFrom, availableUntil])
  @@map("rental_plans")
}

// ============================================
// 套餐-店铺关联 (Plan-Store Junction Table)
// ============================================
// 一个套餐可以在多个店铺销售
// 用户搜索地点后，筛选出该店铺可用的套餐
model PlanStore {
  id        String   @id @default(cuid())
  planId    String   @map("plan_id")
  storeId   String   @map("store_id")

  plan      RentalPlan @relation(fields: [planId], references: [id], onDelete: Cascade)
  store     Store      @relation(fields: [storeId], references: [id], onDelete: Cascade)

  // 可按店铺启用/禁用此套餐
  isActive  Boolean  @default(true) @map("is_active")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@unique([planId, storeId])
  @@index([planId])
  @@index([storeId])
  @@index([storeId, isActive])
  @@map("plan_stores")
}

model Listing {
  id             String        @id @default(cuid())
  merchantId     String
  storeId        String
  name           String
  nameEn         String?
  description    String
  price          Int
  originalPrice  Int?
  depositAmount  Int           @default(0)
  duration       Int
  includes       String[]
  imageUrl       String?
  images         String[]      @default([])
  status         ListingStatus @default(PENDING)
  rejectionReason String?
  isActive       Boolean       @default(true)
  isFeatured     Boolean       @default(false)
  viewCount      Int           @default(0)
  bookingCount   Int           @default(0)
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt
  merchant       Merchant      @relation(fields: [merchantId], references: [id], onDelete: Cascade)
  store          Store         @relation(fields: [storeId], references: [id])

  @@index([merchantId])
  @@index([storeId])
  @@index([status])
  @@map("listings")
}

model Cart {
  id        String     @id @default(cuid())
  userId    String?    @unique
  sessionId String?    @unique
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt
  expiresAt DateTime
  items     CartItem[]
  user      User?      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([sessionId])
  @@index([expiresAt])
  @@map("carts")
}

model CartItem {
  id             String      @id @default(cuid())
  cartId         String
  type           String
  planId         String?
  quantity       Int         @default(1)
  addOns         String[]
  notes          String?
  createdAt      DateTime    @default(now())
  cart           Cart        @relation(fields: [cartId], references: [id], onDelete: Cascade)
  plan           RentalPlan? @relation(fields: [planId], references: [id], onDelete: Cascade)

  @@map("cart_items")
}

model Booking {
  id              String        @id @default(cuid())
  userId          String?
  merchantId      String?
  guestName       String?
  guestEmail      String?
  guestPhone      String?
  totalAmount     Int
  depositAmount   Int
  paidAmount      Int           @default(0)
  platformFee     Int           @default(0)
  merchantAmount  Int           @default(0)
  paymentStatus   PaymentStatus @default(PENDING)
  paymentMethod   String?
  status          BookingStatus @default(PENDING)
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  specialRequests String?
  visitDate       DateTime
  visitTime       String
  items           BookingItem[]
  user            User?         @relation(fields: [userId], references: [id])
  merchant        Merchant?     @relation(fields: [merchantId], references: [id])
  payout          Payout?

  @@index([userId])
  @@index([merchantId])
  @@index([visitDate])
  @@index([status])
  @@map("bookings")
}

model BookingItem {
  id             String          @id @default(cuid())
  bookingId      String
  storeId        String
  type           String
  planId         String?
  quantity       Int             @default(1)
  unitPrice      Int
  totalPrice     Int
  addOns         String[]
  notes          String?
  createdAt      DateTime        @default(now())
  booking        Booking         @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  plan           RentalPlan?     @relation(fields: [planId], references: [id])
  store          Store           @relation(fields: [storeId], references: [id])
  kimonos        BookingKimono[]

  @@index([storeId])
  @@map("booking_items")
}

model BookingKimono {
  id            String      @id @default(cuid())
  kimonoId      String
  bookingItemId String
  bookingItem   BookingItem @relation(fields: [bookingItemId], references: [id], onDelete: Cascade)
  kimono        Kimono      @relation(fields: [kimonoId], references: [id])

  @@map("booking_kimonos")
}

model Favorite {
  id        String   @id @default(cuid())
  userId    String
  kimonoId  String?
  planId    String?       // 套餐收藏
  imageUrl  String?       // 收藏的具体图片 URL
  createdAt DateTime @default(now())

  kimono    Kimono?      @relation(fields: [kimonoId], references: [id], onDelete: Cascade)
  plan      RentalPlan?  @relation(fields: [planId], references: [id], onDelete: Cascade)
  user      User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, kimonoId])
  @@unique([userId, planId, imageUrl])
  @@index([userId])
  @@index([planId])
  @@map("favorites")
}

model Review {
  id        String   @id @default(cuid())
  userId    String
  bookingId String?
  rating    Int
  comment   String
  images    String[]
  isPublic  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("reviews")
}

model UserBehavior {
  id        String        @id @default(cuid())
  userId    String?
  event     BehaviorEvent
  page      String?
  kimonoId  String?
  userAgent String?
  ipAddress String?
  metadata  Json?
  createdAt DateTime      @default(now())
  user      User?         @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([event])
  @@index([createdAt])
  @@map("user_behaviors")
}

model VirtualTryOn {
  id               String       @id @default(cuid())
  userId           String?      // 可为 null（游客）
  sessionId        String       // Cookie session ID（用于追踪游客）

  // 关联信息
  planId           String?
  kimonoId         String?

  // 图片 URL（存储在 Supabase Storage）
  personImageUrl   String?      // 用户原始照片（可选，需用户同意）
  resultImageUrl   String       // 试穿结果（必存）

  // 状态和性能
  status           TryOnStatus  @default(PROCESSING)
  duration         Int?         // 生成耗时（秒）
  cost             Float?       // API 成本（美元）
  fromCache        Boolean      @default(false)

  // 元数据
  prompt           String?      @db.Text // 使用的 prompt
  modelVersion     String?      // AI 模型版本（如 "gemini-2.5-flash-image"）
  errorMessage     String?      @db.Text // 错误信息（如果失败）

  createdAt        DateTime     @default(now())
  updatedAt        DateTime     @updatedAt

  @@index([userId])
  @@index([sessionId])
  @@index([planId])
  @@index([status])
  @@index([createdAt])
  @@map("virtual_tryons")
}

model Campaign {
  id             String         @id @default(cuid())
  slug           String         @unique
  title          String
  titleEn        String?
  description    String
  subtitle       String?
  startDate      DateTime
  endDate        DateTime
  usageStartDate DateTime?
  usageEndDate   DateTime?
  isActive       Boolean        @default(true)
  isPinned       Boolean        @default(false)
  priority       Int            @default(0)
  coverImage     String?
  bannerImage    String?
  type           CampaignType   @default(DISCOUNT)
  restrictions   String[]
  terms          String?
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt
  rentalPlans    RentalPlan[]

  @@index([isActive])
  @@index([startDate, endDate])
  @@map("campaigns")
}

enum Role {
  USER
  ADMIN
  STAFF
  MERCHANT
}

enum Language {
  JA
  EN
  ZH
}

enum Gender {
  MALE
  FEMALE
  OTHER
}

enum KimonoCategory {
  WOMEN
  MEN
  CHILDREN
}

enum Season {
  SPRING
  SUMMER
  AUTUMN
  WINTER
  ALL_SEASON
}

enum PlanStatus {
  DRAFT
  PUBLISHED
  ARCHIVED
}

enum BookingStatus {
  PENDING
  CONFIRMED
  IN_PROGRESS
  COMPLETED
  CANCELLED
  NO_SHOW
}

enum PaymentStatus {
  PENDING
  PARTIAL
  PAID
  REFUNDED
}

enum BehaviorEvent {
  PAGE_VIEW
  KIMONO_VIEW
  KIMONO_FAVORITE
  BOOKING_START
  BOOKING_COMPLETE
}

enum TryOnStatus {
  PROCESSING
  COMPLETED
  FAILED
}

enum CampaignType {
  DISCOUNT
  ANNIVERSARY
  SEASONAL
  FLASH_SALE
  GROUP_BUY
  EARLY_BIRD
  SPECIAL
}

// 社交媒体帖子
model SocialPost {
  id          String         @id @default(cuid())
  platform    SocialPlatform // Instagram, Facebook, 微博
  postId      String         @unique // 原平台的帖子ID
  postUrl     String         // 帖子链接

  // 内容
  content     String?        @db.Text // 帖子文字内容
  images      String[]       // 图片URL数组

  // 作者信息
  authorName  String         // 发帖人名称
  authorAvatar String?       // 发帖人头像

  // 互动数据
  likes       Int            @default(0)
  comments    Int            @default(0)
  shares      Int            @default(0)

  // 元数据
  postedAt    DateTime       // 发帖时间
  scrapedAt   DateTime       @default(now()) // 爬取时间

  // 是否在首页展示
  isFeatured  Boolean        @default(false)
  displayOrder Int?          // 展示顺序（数字越小越靠前）

  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt

  @@index([platform])
  @@index([isFeatured, displayOrder])
  @@map("social_posts")
}

enum SocialPlatform {
  INSTAGRAM
  FACEBOOK
  WEIBO
}

model Payout {
  id          String       @id @default(cuid())
  merchantId  String
  bookingId   String       @unique
  amount      Int
  platformFee Int
  status      PayoutStatus @default(PENDING)
  scheduledAt DateTime?
  paidAt      DateTime?
  method      String?
  reference   String?
  notes       String?
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  merchant    Merchant     @relation(fields: [merchantId], references: [id], onDelete: Cascade)
  booking     Booking      @relation(fields: [bookingId], references: [id])

  @@index([merchantId])
  @@index([status])
  @@index([scheduledAt])
  @@map("payouts")
}

model MerchantReview {
  id          String   @id @default(cuid())
  merchantId  String
  userId      String
  bookingId   String?
  rating      Int
  comment     String?
  response    String?
  isPublic    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  merchant    Merchant @relation(fields: [merchantId], references: [id], onDelete: Cascade)

  @@index([merchantId])
  @@index([rating])
  @@map("merchant_reviews")
}

enum MerchantStatus {
  PENDING
  APPROVED
  REJECTED
  SUSPENDED
}

enum ListingStatus {
  PENDING
  APPROVED
  REJECTED
  SUSPENDED
}

enum PayoutStatus {
  PENDING
  SCHEDULED
  PROCESSING
  COMPLETED
  FAILED
  CANCELLED
}

enum ComponentApprovalStatus {
  DRAFT       // 草稿（商户刚创建，未提交）
  PENDING     // 审核中（商户提交，管理员可见）
  APPROVED    // 已通过（正式上架，所有套餐可用）
  REJECTED    // 已驳回（需修改）
}

// ============================================
// 标签系统 (Tag System)
// ============================================

model TagCategory {
  id             String   @id @default(cuid())
  code           String   @unique
  name           String
  nameEn         String?  @map("name_en")
  description    String?
  icon           String?
  color          String?
  order          Int      @default(0)
  isActive       Boolean  @default(true) @map("is_active")
  showInFilter   Boolean  @default(true) @map("show_in_filter")
  filterOrder    Int      @default(0) @map("filter_order")
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  tags Tag[]

  @@index([isActive, order])
  @@index([showInFilter, filterOrder])
  @@map("tag_categories")
}

model Tag {
  id         String   @id @default(cuid())
  categoryId String   @map("category_id")
  code       String
  name       String
  nameEn     String?  @map("name_en")
  icon       String?
  color      String?
  order      Int      @default(0)
  isActive   Boolean  @default(true) @map("is_active")
  usageCount Int      @default(0) @map("usage_count")
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")

  category TagCategory @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  plans    PlanTag[]

  @@unique([categoryId, code])
  @@index([categoryId, isActive, order])
  @@index([usageCount])
  @@map("tags")
}

model PlanTag {
  id      String   @id @default(cuid())
  planId  String   @map("plan_id")
  tagId   String   @map("tag_id")
  addedBy String?  @map("added_by")
  addedAt DateTime @default(now()) @map("added_at")

  plan RentalPlan @relation(fields: [planId], references: [id], onDelete: Cascade)
  tag  Tag        @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@unique([planId, tagId])
  @@index([planId])
  @@index([tagId])
  @@map("plan_tags")
}

// ============================================
// 交互式配件地图系统 (Interactive Component Map)
// ============================================

// 服务组件类型 - v10.1 简化版
enum ComponentType {
  OUTFIT     // 着装：可在热图展示（和服+配饰+造型）
  ADDON      // 增值服务：独立于热图，附加购买（跟拍、延时等）
}

// v10.2: OUTFIT 组件分类（基于和服着装结构）
enum OutfitCategory {
  MAIN_GARMENT   // 主体服装：和服、振袖、访问着
  INNERWEAR      // 内搭层：襦袢、内衣
  OBI_SET        // 腰带组：帯、帯揚、帯締、伊達衿
  STYLING        // 造型服务：髮飾、发型、化妆
  ACCESSORIES    // 随身配件：包包、巾袋
  FOOTWEAR       // 足部穿着：草履、足袋
}

// 地图模板 - 每个主题一个模板，或作为默认模板
model MapTemplate {
  id          String   @id @default(cuid())

  // 关联主题（可选，null 表示默认模板）
  themeId     String?  @unique @map("theme_id")
  theme       Theme?   @relation(fields: [themeId], references: [id], onDelete: Cascade)

  // 是否为默认模板（当主题没有专属模板时使用）
  isDefault   Boolean  @default(false) @map("is_default")

  // 模板信息
  name        String
  imageUrl    String   @map("image_url")
  imageWidth  Int?     @map("image_width")
  imageHeight Int?     @map("image_height")

  // 元数据
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // 关联
  hotspots    MapHotspot[]

  @@index([isDefault])
  @@index([isActive])
  @@map("map_templates")
}

// 热点定义 - 定义模板上每个组件的位置
model MapHotspot {
  id            String           @id @default(cuid())
  templateId    String           @map("template_id")
  componentId   String           @map("component_id")

  template      MapTemplate      @relation(fields: [templateId], references: [id], onDelete: Cascade)
  component     ServiceComponent @relation(fields: [componentId], references: [id], onDelete: Cascade)

  // 热点位置（百分比坐标）
  // x: 0=最左, 1=最右; y: 0=最上, 1=最下
  x             Float
  y             Float

  // 标签显示位置
  labelPosition String           @default("right") @map("label_position")

  // 连接线配置（可选）
  lineStyle     String?          @map("line_style")

  // 排序（决定热点动画顺序）
  displayOrder  Int              @default(0) @map("display_order")

  createdAt     DateTime         @default(now()) @map("created_at")

  @@unique([templateId, componentId])
  @@index([templateId])
  @@map("map_hotspots")
}

// 服务组件模板 - v10.1
// 平台统一维护的配件/服务定义，作为商户组件的模板
model ServiceComponent {
  id              String          @id @default(cuid())
  code            String          @unique

  // ========== 平台定义（商户不能修改）==========
  name            String
  nameJa          String?         @map("name_ja")
  nameEn          String?         @map("name_en")
  description     String?         @db.Text
  type            ComponentType
  icon            String?

  // ========== v10.2: OUTFIT 分类（仅 OUTFIT 类型有值）==========
  outfitCategory  OutfitCategory? @map("outfit_category")

  // ========== 默认内容（商户未自定义时使用）==========
  defaultHighlights String[]      @default([]) @map("default_highlights")
  defaultImages     String[]      @default([]) @map("default_images")

  // ========== 建议价（仅 ADDON 类型有意义）==========
  basePrice       Int             @default(0) @map("base_price")

  // ========== 元数据 ==========
  displayOrder    Int             @default(0) @map("display_order")
  isActive        Boolean         @default(true) @map("is_active")
  createdAt       DateTime        @default(now()) @map("created_at")
  updatedAt       DateTime        @updatedAt @map("updated_at")

  // ========== 关联 ==========
  merchantComponents MerchantComponent[]  // 商户组件实例
  mapHotspots        MapHotspot[]

  @@index([type, outfitCategory, displayOrder])
  @@index([type, isActive, displayOrder])
  @@map("service_components")
}

// ============================================
// 商户组件 (Merchant Component) - v10.1
// ============================================
// 商户级别的组件实例，每个商户对每个平台组件模板有一个实例
model MerchantComponent {
  id            String   @id @default(cuid())

  // 商户
  merchantId    String   @map("merchant_id")
  merchant      Merchant @relation(fields: [merchantId], references: [id], onDelete: Cascade)

  // 平台组件模板（自定义服务时为 null）
  templateId    String?  @map("template_id")
  template      ServiceComponent? @relation(fields: [templateId], references: [id], onDelete: Cascade)

  // ========== 自定义服务标识 ==========
  isCustom           Boolean                  @default(false) @map("is_custom")
  approvalStatus     ComponentApprovalStatus  @default(APPROVED) @map("approval_status")
  adminFeedback      String?                  @map("admin_feedback")  // 驳回理由

  // ========== 自定义服务专用字段 ==========
  // 当 isCustom=true 时使用这些字段，否则从 template 读取
  customName         String?                  @map("custom_name")
  customNameEn       String?                  @map("custom_name_en")
  customDescription  String?                  @map("custom_description")
  customIcon         String?                  @map("custom_icon")
  customBasePrice    Int?                     @map("custom_base_price")

  // ========== 商户自定义内容 ==========
  // 空数组 = 使用平台默认内容 (template.defaultImages / template.defaultHighlights)
  images        String[]         @default([])
  highlights    String[]         @default([])

  // ========== 仅 ADDON 类型 ==========
  // null = 使用平台建议价 (template.basePrice 或 customBasePrice)
  price         Int?

  // ========== 启用状态 ==========
  // false = 商户不提供此组件
  isEnabled     Boolean  @default(true) @map("is_enabled")

  // ========== 关联 ==========
  planComponents PlanComponent[]
  planUpgrades   PlanUpgrade[]     // 作为升级服务被套餐引用

  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  @@unique([merchantId, templateId])
  @@index([merchantId])
  @@index([templateId])
  @@index([approvalStatus])
  @@map("merchant_components")
}

// ============================================
// 套餐升级服务 (Plan Upgrade Services)
// ============================================
// 记录套餐可选的升级服务（使用 ADDON 类型的 ServiceComponent）

model PlanUpgrade {
  id                   String            @id @default(cuid())
  planId               String            @map("plan_id")

  // 关联商户组件实例（必须是 ADDON 类型）
  merchantComponentId  String            @map("merchant_component_id")
  merchantComponent    MerchantComponent @relation(fields: [merchantComponentId], references: [id], onDelete: Cascade)

  plan                 RentalPlan        @relation(fields: [planId], references: [id], onDelete: Cascade)

  // 套餐级别的价格覆盖（null = 使用 MerchantComponent.price 或 ServiceComponent.basePrice）
  priceOverride        Int?              @map("price_override")

  // 是否为推荐/人气服务
  isPopular            Boolean           @default(false) @map("is_popular")

  // 显示顺序
  displayOrder         Int               @default(0) @map("display_order")

  createdAt            DateTime          @default(now()) @map("created_at")
  updatedAt            DateTime          @updatedAt @map("updated_at")

  @@unique([planId, merchantComponentId])
  @@index([planId])
  @@index([merchantComponentId])
  @@map("plan_upgrades")
}

// 套餐-组件关联 - v10.1
// 记录套餐包含哪些商户组件及热点位置
model PlanComponent {
  id                   String           @id @default(cuid())
  planId               String           @map("plan_id")

  // 关联商户组件实例
  merchantComponentId  String           @map("merchant_component_id")
  merchantComponent    MerchantComponent @relation(fields: [merchantComponentId], references: [id], onDelete: Cascade)

  plan                 RentalPlan       @relation(fields: [planId], references: [id], onDelete: Cascade)

  createdAt            DateTime         @default(now()) @map("created_at")
  updatedAt            DateTime         @updatedAt @map("updated_at")

  // ========== 热点图配置（仅 OUTFIT 类型）==========
  // 热点位置（百分比坐标 0-1，null = 不显示在图上）
  hotmapX              Float?           @map("hotmap_x")
  hotmapY              Float?           @map("hotmap_y")

  // 标签显示方向
  hotmapLabelPosition  String           @default("right") @map("hotmap_label_position")

  // 标签偏移位置（像素，相对于热点中心）
  hotmapLabelOffsetX   Float?           @map("hotmap_label_offset_x")
  hotmapLabelOffsetY   Float?           @map("hotmap_label_offset_y")

  // 热点显示顺序（用于动画、层级）
  hotmapOrder          Int              @default(0) @map("hotmap_order")

  @@unique([planId, merchantComponentId])
  @@index([planId])
  @@index([merchantComponentId])
  @@map("plan_components")
}

