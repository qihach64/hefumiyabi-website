# 包含服务热图 - 数据库设计

## 服务组件二分法设计 (2024.12)

### 设计原则

将服务组件简化为**两大类**：

| 类型 | 英文 | 中文 | 特点 |
|------|------|------|------|
| **OUTFIT** | Outfit | 着装 | 可在热图展示、支持单项升级 |
| **ADDON** | Add-on | 增值服务 | 独立于热图、附加购买 |

### 类型定义

#### OUTFIT (着装) - 热图组件

包含所有"穿戴在身上"的可视化元素：

| 原类型 | 组件 | 说明 |
|--------|------|------|
| KIMONO | 和服、振袖、蕾丝和服、访问着 | 和服本体 |
| ACCESSORY | 襦袢、腰带、草履、包包、足袋、内衣、发饰 | 配饰 |
| STYLING | 专业发型、专业化妆 | 造型服务 |

**特点**：
- 可在热图上标注位置
- 支持升级路径（基础 → 高级）
- 商户可拖拽调整热点位置
- 用户端展示 WYSIWYG

#### ADDON (增值服务) - 独立服务

独立于热图的附加服务：

| 原类型 | 组件 | 说明 |
|--------|------|------|
| EXPERIENCE | 基础跟拍、豪华跟拍、隔日归还 | 体验增值 |
| (未来) | 道具租借、翻译服务、接送服务 | 扩展服务 |

**特点**：
- 不在热图上展示
- 独立计价，可选购
- 在套餐详情页单独区块展示

---

## 数据迁移计划

### 迁移映射

```
KIMONO    → OUTFIT
STYLING   → OUTFIT
ACCESSORY → OUTFIT
EXPERIENCE → ADDON
```

### SQL 迁移

```sql
-- Step 1: 更新现有数据
UPDATE "ServiceComponent" SET type = 'OUTFIT' WHERE type IN ('KIMONO', 'STYLING', 'ACCESSORY');
UPDATE "ServiceComponent" SET type = 'ADDON' WHERE type = 'EXPERIENCE';

-- Step 2: 更新枚举（需要 Prisma migrate）
```

---

## 架构图

```
┌─────────────────┐       ┌─────────────────┐       ┌─────────────────┐
│   MapTemplate   │       │   MapHotspot    │       │ServiceComponent │
├─────────────────┤       ├─────────────────┤       ├─────────────────┤
│ id              │1     *│ id              │*     1│ id              │
│ themeId?        │───────│ templateId      │───────│ code (unique)   │
│ isDefault       │       │ componentId     │       │ name            │
│ name            │       │ x, y (位置%)    │       │ type:           │
│ imageUrl        │       │ labelPosition   │       │   OUTFIT ← NEW  │
│ imageWidth/H    │       │ displayOrder    │       │   ADDON  ← NEW  │
└─────────────────┘       └─────────────────┘       │ icon            │
                                                     │ upgradesTo[]    │
                                                     └─────────────────┘
                                                            │
                                                            │ 1
                                                            ▼ *
                                                     ┌─────────────────┐
┌─────────────────┐                                  │  PlanComponent  │
│   RentalPlan    │                                  ├─────────────────┤
├─────────────────┤ 1                              * │ id              │
│ id              │──────────────────────────────────│ planId          │
│ name            │                                  │ componentId     │
│ themeId         │                                  │ hotmapX/Y       │
│ ...             │                                  │ isIncluded      │
└─────────────────┘                                  │ ...             │
                                                     └─────────────────┘
```

---

## UI 展示逻辑

### 商户套餐编辑器

```
┌────────────────────────────────────────────────────┐
│  套餐包含内容                                        │
├────────────────────────────────────────────────────┤
│                                                    │
│  ┌──────────────┐   ┌──────────────────────────┐  │
│  │              │   │ 着装项 (OUTFIT)           │  │
│  │   热图区域    │   │ ☑ 👘 和服                │  │
│  │              │   │ ☑ 🎀 腰带                │  │
│  │  （只显示     │   │ ☑ 👡 草履                │  │
│  │   OUTFIT）   │   │ ☑ 💇 发型                │  │
│  │              │   │                          │  │
│  └──────────────┘   │ 增值服务 (ADDON)          │  │
│                     │ ☐ 📷 基础跟拍 +¥2000      │  │
│                     │ ☐ 🌙 隔日归还 +¥1000      │  │
│                     └──────────────────────────┘  │
│                                                    │
└────────────────────────────────────────────────────┘
```

### 用户端套餐详情

```
┌────────────────────────────────────────────────────┐
│  套餐内容                                           │
├────────────────────────────────────────────────────┤
│                                                    │
│  ┌──────────────┐   ┌──────────────────────────┐  │
│  │              │   │ ✓ 和服租赁               │  │
│  │   热点地图    │   │ ✓ 腰带・草履            │  │
│  │              │   │ ✓ 专业发型              │  │
│  │              │   │ ✓ ...                   │  │
│  └──────────────┘   └──────────────────────────┘  │
│                                                    │
│  ┌──────────────────────────────────────────────┐  │
│  │ 可选增值服务                                   │  │
│  │ ┌────────┐ ┌────────┐ ┌────────┐            │  │
│  │ │📷跟拍  │ │🌙延时  │ │...     │            │  │
│  │ │+¥2000 │ │+¥1000 │ │        │            │  │
│  │ └────────┘ └────────┘ └────────┘            │  │
│  └──────────────────────────────────────────────┘  │
│                                                    │
└────────────────────────────────────────────────────┘
```

---

## 升级路径设计

### OUTFIT 支持升级

| 基础组件 | 升级选项 | 差价 |
|----------|----------|------|
| 基础发型 | 编发造型 | +¥500 |
| 标准腰带 | 太鼓结腰带 | +¥1000 |
| 基础和服 | 振袖 | +¥3000 |

### ADDON 不支持升级

增值服务独立定价，不参与升级链。

---

## 实施步骤

1. [x] 设计文档更新
2. [ ] 更新 Prisma schema 枚举
3. [ ] 创建数据迁移脚本
4. [ ] 执行数据库迁移
5. [ ] 更新前端组件过滤逻辑
6. [ ] 测试验证

---

## 历史记录

### 旧分类 (deprecated)

| 类型 | 组件数 | 迁移目标 |
|------|--------|----------|
| KIMONO | 4 | OUTFIT |
| STYLING | 2 | OUTFIT |
| ACCESSORY | 8 | OUTFIT |
| EXPERIENCE | 3 | ADDON |

### 新分类

| 类型 | 组件数 | 说明 |
|------|--------|------|
| OUTFIT | 14 | 热图可展示 |
| ADDON | 3 | 独立增值 |
