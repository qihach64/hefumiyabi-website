# æµ‹è¯•è¦†ç›–ç‡åˆ†ææŠ¥å‘Š

> ç”Ÿæˆæ—¥æœŸ: 2026-02-13

## æ¦‚è§ˆ

| æŒ‡æ ‡       | æ•°å€¼                                            |
| ---------- | ----------------------------------------------- |
| æµ‹è¯•æ–‡ä»¶æ•° | 48                                              |
| æµ‹è¯•ç”¨ä¾‹æ•° | 679 (674 é€šè¿‡, 5 å¤±è´¥)                          |
| å¤±è´¥åŸå›    | `kimono-map.test.ts` ä¾èµ– DATABASE_URL ç¯å¢ƒå˜é‡ |
| æºæ–‡ä»¶æ•°   | ~148                                            |
| æºç è¡Œæ•°   | ~17,000+                                        |

### æŒ‰æ¨¡å—è¦†ç›–æƒ…å†µ

| æ¨¡å—                                       | æºæ–‡ä»¶æ•° | æµ‹è¯•æ–‡ä»¶æ•° | è¦†ç›–ç‡  |
| ------------------------------------------ | -------- | ---------- | ------- |
| æœåŠ¡å±‚ (`server/services/`)                | 8        | 8          | âœ… 100% |
| tRPC è·¯ç”± (`server/trpc/routers/`)         | 7        | 7          | âœ… 100% |
| Zustand Store (`store/`)                   | 5        | 5          | âœ… 100% |
| é¢„çº¦ç»„ä»¶ (`features/guest/booking/`)       | 7        | 7          | âœ… 100% |
| PlanCard ç»„ä»¶                              | 3        | 3          | âœ… 100% |
| æœç´¢å‘ç°ç»„ä»¶ (`features/guest/discovery/`) | 13       | 4          | âš ï¸ ~30% |
| å¸ƒå±€ç»„ä»¶ (`components/layout/`)            | 9        | 3          | âš ï¸ ~30% |
| Zod Schema (`server/schemas/`)             | 5        | 0          | âŒ 0%   |
| REST API è·¯ç”± (`app/api/`)                 | 47       | 0          | âŒ 0%   |
| é¡µé¢ç»„ä»¶ (`app/(main)/`)                   | 36       | 0          | âŒ 0%   |
| React Context (`contexts/`)                | 2        | 0          | âŒ 0%   |
| å·¥å…·åº“ (`lib/`)                            | 11       | 1          | âŒ ~9%  |
| å•†å®¶ç»„ä»¶ (`components/merchant/`)          | 10+      | 1          | âŒ ~10% |
| å¥—é¤è¯¦æƒ…ç»„ä»¶ (`components/plan/`)          | 9        | 1          | âŒ ~11% |

---

## å½“å‰æµ‹è¯•çš„ä¼˜ç‚¹

1. **åç«¯ä¸‰å±‚æ¶æ„æµ‹è¯•å®Œæ•´** â€” æ‰€æœ‰ service å’Œ tRPC router éƒ½æœ‰æµ‹è¯•
2. **æ ¸å¿ƒä¸šåŠ¡æµç¨‹è¦†ç›–å¥½** â€” é¢„çº¦åŠŸèƒ½ (booking) 7/7 ç»„ä»¶å…¨éƒ¨æœ‰æµ‹è¯•
3. **çŠ¶æ€ç®¡ç†æµ‹è¯•å®Œæ•´** â€” æ‰€æœ‰ Zustand store éƒ½æœ‰æµ‹è¯•ï¼Œcart.test.ts ä½¿ç”¨äº†è‰¯å¥½çš„ factory æ¨¡å¼
4. **Mock æ¨¡å¼æˆç†Ÿ** â€” Prisma mockã€tRPC mock æ¨¡å¼ç»Ÿä¸€è§„èŒƒ
5. **æµ‹è¯•åŸºç¡€è®¾æ–½å®Œå–„** â€” vitest + @testing-library/react + happy-dom é…ç½®åˆç†

---

## æ”¹è¿›å»ºè®®ï¼ˆæŒ‰ä¼˜å…ˆçº§æ’åˆ—ï¼‰

### ğŸ”´ P0: å…³é”®ç¼ºå¤±ï¼ˆåº”ç«‹å³è¡¥å……ï¼‰

#### 1. Zod Schema éªŒè¯æµ‹è¯•

**ä½ç½®:** `src/server/schemas/` (5 ä¸ª schema æ–‡ä»¶, 0 ä¸ªæµ‹è¯•)

**åŸå› :** Schema æ˜¯æ•°æ®è¿›å…¥ç³»ç»Ÿçš„ç¬¬ä¸€é“é˜²çº¿ã€‚æ²¡æœ‰æµ‹è¯•æ„å‘³ç€ï¼š

- æ— æ³•éªŒè¯è¾¹ç•Œå€¼è¡Œä¸ºï¼ˆä¾‹å¦‚ `notes` è¶…è¿‡ 500 å­—ç¬¦ä¼šæ€æ ·ï¼‰
- æ— æ³•ç¡®ä¿æ—¥æœŸ/æ—¶é—´æ­£åˆ™èƒ½æ­£ç¡®æ‹’ç»æ— æ•ˆè¾“å…¥
- é‡æ„ schema æ—¶æ²¡æœ‰å›å½’ä¿æŠ¤

**é‡ç‚¹æ–‡ä»¶:**

| æ–‡ä»¶                 | è¡Œæ•° | å…³é”®éªŒè¯ç‚¹                                       |
| -------------------- | ---- | ------------------------------------------------ |
| `plan.schema.ts`     | 111  | 50+ å­—æ®µã€åµŒå¥—å¯¹è±¡ã€ä»·æ ¼è½¬æ¢ã€URL éªŒè¯ã€æšä¸¾å€¼   |
| `booking.schema.ts`  | 39   | æ—¥æœŸæ­£åˆ™ã€æ—¶é—´æ­£åˆ™ã€æ•°ç»„é•¿åº¦é™åˆ¶(1-50)ã€ä»·æ ¼éè´Ÿ |
| `auth.schema.ts`     | 18   | é‚®ç®±æ ¼å¼ã€å¯†ç æœ€å°é•¿åº¦(8)ã€å§“åé•¿åº¦é™åˆ¶(50)      |
| `merchant.schema.ts` | 14   | ç¨å·/é“¶è¡Œè´¦å·éç©ºã€æè¿°é•¿åº¦(1-1000)ã€URL æ ¼å¼    |
| `tag.schema.ts`      | 29   | ç¼–ç /åç§°é•¿åº¦é™åˆ¶(50)ã€æ’åºéè´Ÿæ•´æ•°              |

**å»ºè®®æµ‹è¯•æ¨¡å¼:**

```typescript
describe("createBookingSchema", () => {
  it.each([
    ["2025-03-15", true],
    ["2025-13-01", false], // æœˆä»½è¶…èŒƒå›´
    ["2025-3-1", false], // ç¼ºå°‘å‰å¯¼é›¶
    ["not-a-date", false],
  ])('visitDate "%s" æ ¡éªŒç»“æœåº”ä¸º %s', (date, valid) => {
    const result = bookingItemSchema.safeParse({ ...validItem, visitDate: date });
    expect(result.success).toBe(valid);
  });
});
```

#### 2. REST API è·¯ç”±æµ‹è¯•

**ä½ç½®:** `src/app/api/` (47 ä¸ªè·¯ç”±æ–‡ä»¶, 0 ä¸ªæµ‹è¯•)

**åŸå› :** è™½ç„¶ tRPC router æœ‰æµ‹è¯•ï¼Œä½†é¡¹ç›®ä¸­ä»æœ‰å¤§é‡ REST API è·¯ç”±æ‰¿æ‹…å…³é”®ä¸šåŠ¡é€»è¾‘ï¼ŒåŒ…æ‹¬ï¼š

| è·¯ç”±                                        | é£é™©ç­‰çº§ | åŸå›                               |
| ------------------------------------------- | -------- | --------------------------------- |
| `api/bookings/route.ts`                     | ğŸ”´ æé«˜  | è®¢å•åˆ›å»ºå…¥å£ï¼Œæ¶‰åŠé‡‘é¢è®¡ç®—        |
| `api/auth/register/route.ts`                | ğŸ”´ æé«˜  | ç”¨æˆ·æ³¨å†Œï¼Œæ‰‹åŠ¨éªŒè¯è€Œéä½¿ç”¨ schema |
| `api/auth/verify-email/route.ts`            | ğŸŸ¡ é«˜    | Token éªŒè¯é€»è¾‘                    |
| `api/merchant/plans/[id]/route.ts`          | ğŸŸ¡ é«˜    | å•†å®¶å¥—é¤æ›´æ–°                      |
| `api/admin/merchants/[id]/approve/route.ts` | ğŸŸ¡ é«˜    | æƒé™æ•æ„Ÿæ“ä½œ                      |

**å‘ç°çš„é—®é¢˜:** API è·¯ç”±ä¸­å­˜åœ¨ä¸ Schema é‡å¤çš„æ‰‹åŠ¨éªŒè¯é€»è¾‘ï¼Œä¾‹å¦‚ `/api/auth/register` ç”¨æ­£åˆ™éªŒè¯é‚®ç®±è€Œä¸æ˜¯ä½¿ç”¨ `auth.schema.ts`ã€‚è¿™ç±»é‡å¤åº”é€šè¿‡æµ‹è¯•æš´éœ²å¹¶æ¨åŠ¨ç»Ÿä¸€ã€‚

#### 3. `kimono-map.test.ts` ä¿®å¤

**å½“å‰çŠ¶æ€:** 5 ä¸ªç”¨ä¾‹å¤±è´¥ï¼ŒåŸå› æ˜¯ç›´æ¥è°ƒç”¨ Prisma è€Œé mock

**é—®é¢˜:** 3 ä¸ªæµ‹è¯•ç”¨ä¾‹ç›´æ¥æŸ¥è¯¢æ•°æ®åº“ (`prisma.rentalPlan.findUnique`)ï¼Œåœ¨æ²¡æœ‰ `DATABASE_URL` çš„ç¯å¢ƒä¸­å¿…ç„¶å¤±è´¥ã€‚è¿™å±äºé›†æˆæµ‹è¯•çš„èŒƒç•´ï¼Œåº”ä¸å•å…ƒæµ‹è¯•åˆ†ç¦»æˆ–æ”¹ä¸º mock æ¨¡å¼ã€‚

---

### ğŸŸ¡ P1: é‡è¦ç¼ºå¤±ï¼ˆåº”å°½å¿«è¡¥å……ï¼‰

#### 4. å¤§å‹æœªæµ‹è¯•ç»„ä»¶

ä»¥ä¸‹ç»„ä»¶è¡Œæ•°å¤šã€é€»è¾‘å¤æ‚ï¼Œä½†å®Œå…¨æ²¡æœ‰æµ‹è¯•ï¼š

| ç»„ä»¶                      | è¡Œæ•°  | é£é™©                                               |
| ------------------------- | ----- | -------------------------------------------------- |
| `PlanComponentEditor.tsx` | 1,350 | æœ€å¤æ‚çš„ç»„ä»¶ï¼Œç®¡ç†åŠ¨æ€åˆ—è¡¨ç¼–è¾‘ã€çƒ­ç‚¹æ˜ å°„ã€å®æ—¶é¢„è§ˆ |
| `HeaderSearchBar.tsx`     | 836   | æœç´¢ UX å…¥å£ï¼Œscroll äº‹ä»¶ç›‘å¬ã€nuqs çŠ¶æ€åŒæ­¥       |
| `PlanEditForm.tsx`        | 707   | å•†å®¶å¥—é¤ç¼–è¾‘è¡¨å•ï¼Œ50+ å­—æ®µ                         |
| `ImageUploader.tsx`       | 600   | S3 ä¸Šä¼ ã€é¢„è§ˆã€é”™è¯¯å¤„ç†                            |
| `BookingCard.tsx`         | 535   | è®¢å•å†å²å±•ç¤º                                       |
| `PlanDetailClient.tsx`    | 525   | å¥—é¤è¯¦æƒ…é¡µä¸»ç»„ä»¶                                   |
| `MobileSearchBar.tsx`     | 425   | ç§»åŠ¨ç«¯æœç´¢                                         |
| `TryOnModal.tsx`          | 426   | AI è¯•ç©¿å¼¹çª—                                        |

**å»ºè®®:** ä¼˜å…ˆæµ‹è¯• `PlanDetailClient.tsx`ï¼ˆè¥æ”¶å…³é”®é¡µé¢ï¼‰å’Œ `PlanComponentEditor.tsx`ï¼ˆæœ€å¤æ‚çš„äº¤äº’ç»„ä»¶ï¼‰ã€‚

#### 5. React Context æµ‹è¯•

**ä½ç½®:** `src/contexts/` (2 ä¸ªæ–‡ä»¶, 0 ä¸ªæµ‹è¯•)

| Context                    | è¡Œæ•° | å¤æ‚åº¦ | å…³é”®é€»è¾‘                                                |
| -------------------------- | ---- | ------ | ------------------------------------------------------- |
| `SearchBarContext.tsx`     | 105  | ä¸­é«˜   | æ»šåŠ¨äº‹ä»¶ç›‘å¬ã€requestAnimationFrameã€æ‰‹åŠ¨å±•å¼€çŠ¶æ€æŒä¹…åŒ– |
| `SearchLoadingContext.tsx` | 43   | ä½     | ç®€å•çŠ¶æ€æœº (isSearching + searchTarget)                 |

`SearchBarContext` åŒ…å« scroll é˜ˆå€¼åˆ¤æ–­ (100px) å’Œ delta è·ç¦»åˆ¤æ–­ (50px) çš„é€»è¾‘ï¼Œè¿™ç±»è®¡ç®—é€»è¾‘å®¹æ˜“å‡º bugï¼Œåº”å½“æµ‹è¯•ã€‚

#### 6. æœç´¢å‘ç°æ¨¡å—è¡¥å……æµ‹è¯•

**ä½ç½®:** `src/features/guest/discovery/components/` (13 ä¸ªç»„ä»¶, ä»… 4 ä¸ªæœ‰æµ‹è¯•)

**ç¼ºå¤±æµ‹è¯•çš„ç»„ä»¶:**

- `FilterSidebar.tsx` (253 è¡Œ) â€” ç­›é€‰é¢æ¿
- `GuestsDropdown.tsx` (263 è¡Œ) â€” äººæ•°é€‰æ‹©
- `ThemeImageSelector.tsx` (223 è¡Œ) â€” ä¸»é¢˜å›¾ç‰‡é€‰æ‹©
- `MobileFilterDrawer.tsx` (136 è¡Œ) â€” ç§»åŠ¨ç«¯ç­›é€‰æŠ½å±‰
- `ClientThemePills.tsx` (136 è¡Œ) â€” ä¸»é¢˜æ ‡ç­¾
- `CategoryFilter.tsx` (68 è¡Œ) â€” åˆ†ç±»ç­›é€‰
- `StoreFilter.tsx` (42 è¡Œ) â€” åº—é“ºç­›é€‰
- `SortSelector.tsx` (29 è¡Œ) â€” æ’åºé€‰æ‹©
- `SearchFilterSidebar.tsx` (406 è¡Œ) â€” æœç´¢ç­›é€‰ä¾§æ 

---

### ğŸŸ¢ P2: å»ºè®®è¡¥å……ï¼ˆæŒç»­æ”¹è¿›ï¼‰

#### 7. å·¥å…·åº“æµ‹è¯•

**ä½ç½®:** `src/lib/` (11 ä¸ªæ–‡ä»¶, ä»… 1 ä¸ªæœ‰æµ‹è¯•)

| æ–‡ä»¶                       | è¡Œæ•° | æµ‹è¯•ä»·å€¼                                |
| -------------------------- | ---- | --------------------------------------- |
| `tokens.ts`                | 52   | é«˜ â€” å®‰å…¨ç›¸å…³ï¼Œtoken ç”Ÿæˆ/éªŒè¯/è¿‡æœŸé€»è¾‘ |
| `email.ts`                 | 327  | ä¸­ â€” é‚®ä»¶æ¨¡æ¿æ¸²æŸ“ï¼ˆå¯ snapshot æµ‹è¯•ï¼‰   |
| `upload.ts`                | 50   | ä¸­ â€” æ–‡ä»¶ä¸Šä¼ ç¼–æ’                       |
| `aws.ts`                   | 130  | ä½ â€” ä¸»è¦æ˜¯ SDK wrapper                 |
| `virtual-tryon-prompts.ts` | 122  | ä½ â€” AI prompt æ¨¡æ¿                     |

#### 8. ç°æœ‰æµ‹è¯•çš„æ·±åº¦æ”¹è¿›

ç°æœ‰æµ‹è¯•è¦†ç›–äº†"æ­£å¸¸è·¯å¾„"ï¼Œä½†ä»¥ä¸‹åœºæ™¯æ™®éç¼ºå¤±ï¼š

- **booking.service.test.ts:** ç¼ºå°‘æŠ¼é‡‘è®¡ç®—ã€æ—¶åŒºå¤„ç†ã€å¹¶å‘å†²çªæµ‹è¯•
- **plan.service.test.ts:** ç¼ºå°‘éæ³•å‚æ•°(è´Ÿæ•° limit/skip)ã€ç‰¹æ®Šå­—ç¬¦è¿‡æ»¤æµ‹è¯•
- **cart.test.ts:** ç¼ºå°‘ localStorage æŒä¹…åŒ–ã€è¿‡å»æ—¥æœŸéªŒè¯æµ‹è¯•
- **InstantBookingModal.test.tsx:** ç¼ºå°‘è¡¨å•æäº¤ payload ç»“æ„éªŒè¯ã€æ— éšœç¢æµ‹è¯•

#### 9. é…ç½®è¦†ç›–ç‡æŠ¥å‘Š

å½“å‰ `vitest.config.ts` æ²¡æœ‰é…ç½®è¦†ç›–ç‡æ”¶é›†ã€‚å»ºè®®æ·»åŠ ï¼š

```typescript
// vitest.config.ts
test: {
  coverage: {
    provider: 'v8',
    reporter: ['text', 'html', 'lcov'],
    include: ['src/**/*.{ts,tsx}'],
    exclude: [
      'src/**/__tests__/**',
      'src/app/**/layout.tsx',
      'src/app/**/loading.tsx',
      'src/types/**',
    ],
    thresholds: {
      // åˆå§‹é˜ˆå€¼ï¼Œé€æ­¥æé«˜
      statements: 30,
      branches: 25,
      functions: 30,
      lines: 30,
    },
  },
}
```

#### 10. æµ‹è¯•åˆ†ç±»ä¸ç¯å¢ƒéš”ç¦»

`kimono-map.test.ts` æš´éœ²äº†ä¸€ä¸ªæ¶æ„é—®é¢˜ï¼šä¾èµ–çœŸå®æ•°æ®åº“çš„é›†æˆæµ‹è¯•å’Œçº¯å•å…ƒæµ‹è¯•æ··åœ¨ä¸€èµ·ã€‚å»ºè®®ï¼š

- å°†éœ€è¦æ•°æ®åº“çš„æµ‹è¯•æ ‡è®°ä¸º `describe.skip` æˆ–ç§»åˆ° `__integration_tests__/` ç›®å½•
- åœ¨ CI ä¸­åˆ†åˆ«è¿è¡Œ `pnpm test:unit` å’Œ `pnpm test:integration`
- å•å…ƒæµ‹è¯•å¿…é¡»å…¨éƒ¨ mock å¤–éƒ¨ä¾èµ–

---

## æ€»ç»“ä¼˜å…ˆçº§æ’åº

| ä¼˜å…ˆçº§  | ä»»åŠ¡                                                  | é¢„ä¼°æµ‹è¯•ç”¨ä¾‹æ•° |
| ------- | ----------------------------------------------------- | -------------- |
| ğŸ”´ P0-1 | Schema éªŒè¯æµ‹è¯• (5 ä¸ªæ–‡ä»¶)                            | ~60            |
| ğŸ”´ P0-2 | å…³é”® REST API è·¯ç”±æµ‹è¯• (5 ä¸ªè·¯ç”±)                     | ~30            |
| ğŸ”´ P0-3 | ä¿®å¤ kimono-map.test.ts å¤±è´¥ç”¨ä¾‹                      | 5 (ä¿®å¤)       |
| ğŸŸ¡ P1-1 | å¤§å‹ç»„ä»¶æµ‹è¯• (PlanDetailClient, PlanComponentEditor)  | ~40            |
| ğŸŸ¡ P1-2 | Context æµ‹è¯• (SearchBarContext, SearchLoadingContext) | ~15            |
| ğŸŸ¡ P1-3 | Discovery æ¨¡å—è¡¥å……æµ‹è¯• (9 ä¸ªç»„ä»¶)                     | ~45            |
| ğŸŸ¢ P2-1 | å·¥å…·åº“æµ‹è¯• (tokens.ts, email.ts)                      | ~20            |
| ğŸŸ¢ P2-2 | ç°æœ‰æµ‹è¯•æ·±åº¦æ”¹è¿›                                      | ~30            |
| ğŸŸ¢ P2-3 | é…ç½®è¦†ç›–ç‡æŠ¥å‘Š + CI é›†æˆ                              | é…ç½®ä»»åŠ¡       |
| ğŸŸ¢ P2-4 | æµ‹è¯•åˆ†ç±»ä¸ç¯å¢ƒéš”ç¦»                                    | æ¶æ„ä»»åŠ¡       |
