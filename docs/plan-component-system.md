# 套餐组件系统设计文档

> **版本**: v10 (2024-12)
> **状态**: 设计规划

---

## 概述

套餐组件系统是和服租赁平台的核心功能，用于：

1. **商户端**：创建和编辑套餐内容，配置服务组件和热点图
2. **用户端**：展示套餐包含的服务，支持交互式和服热点图
3. **平台端**：定义服务组件的种类（模板）

### 设计原则

| 原则 | 说明 |
|------|------|
| **平台定义种类** | 组件种类由平台定义，保证一致性和可比性 |
| **商户自定义内容** | 商户可自定义组件的图片、描述、价格（仅ADDON）|
| **市场质量控制** | 商户内容质量靠市场自然筛选，平台不审核 |
| **简化定价** | OUTFIT不定价（含在套餐内），ADDON商户定价 |
| **视觉一致性** | 编辑器和用户端使用同一渲染组件（WYSIWYG）|

---

## 组件类型

### OUTFIT vs ADDON

```
┌─────────────────────────────────────────────────────────────────┐
│  OUTFIT (套餐包含服务)              ADDON (增值服务)              │
├─────────────────────────────────────────────────────────────────┤
│  👘 和服、配饰、造型等               📷 跟拍、寄存、接送等         │
│  ✅ 需要热点图定位                   ❌ 不需要热点图定位           │
│  ✅ 显示在和服图上                   ✅ 在服务列表中展示           │
│  ❌ 不单独定价（含在套餐内）          ✅ 商户自定义价格（加购）      │
│  ✅ 商户可自定义描述/图片            ✅ 商户可自定义描述/图片/价格  │
└─────────────────────────────────────────────────────────────────┘
```

### 核心区别

| 维度 | OUTFIT | ADDON |
|------|--------|-------|
| 定价 | 不定价，价格含在套餐内 | 商户自定义价格，在套餐基础上加购 |
| 热点图 | 可放置在热点图上 | 不放置在热点图上 |
| 用户选择 | 套餐自带，用户不需要选择 | 用户可选加购 |
| 示例 | 振袖、帯、草履、发型 | 摄影跟拍、行李寄存、接送服务 |

### 旧类型兼容

| 旧类型 | 映射到 |
|--------|--------|
| KIMONO | OUTFIT |
| STYLING | OUTFIT |
| ACCESSORY | OUTFIT |
| EXPERIENCE | ADDON |

---

## 数据模型

### 核心模型关系

```
┌─────────────────────────────────────────────────────────────────────────┐
│                              平台层                                      │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  ServiceComponent (平台组件模板 - 定义组件种类)                            │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │  id, code, name, type (OUTFIT | ADDON)                          │   │
│  │  icon: 默认图标                                                  │   │
│  │  description: 默认描述（商户未自定义时显示）                       │   │
│  │  images: 默认图片（商户未自定义时显示）                            │   │
│  │  basePrice: 建议价（仅 ADDON 类型有意义）                         │   │
│  │                                                                  │   │
│  │  💡 平台定义"种类"，商户自定义"内容"                               │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
                                    │
                          商户自定义内容
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                              商户层                                      │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  MerchantComponentOverride (商户自定义内容 - 商户级别)                     │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │  merchantId, componentId                                         │   │
│  │                                                                  │   │
│  │  // 商户自定义内容                                                │   │
│  │  description: 商户说明（null = 使用平台默认）                      │   │
│  │  images: 商户图片（空 = 使用平台默认）                             │   │
│  │                                                                  │   │
│  │  // 仅 ADDON 类型                                                 │   │
│  │  price: 商户定价（null = 使用平台建议价）                          │   │
│  │                                                                  │   │
│  │  isEnabled: 是否启用此组件                                        │   │
│  │                                                                  │   │
│  │  💡 商户级别配置，所有套餐通用                                     │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│  RentalPlan (套餐)                                                       │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │  id, name, price, hotmapImageUrl                                 │   │
│  │                                                                  │   │
│  │  PlanComponent[] (套餐-组件关联)                                  │   │
│  │  ┌────────────────────────────────────────────────────────────┐ │   │
│  │  │  componentId                                                │ │   │
│  │  │  hotmapX, hotmapY, hotmapLabelPosition (仅 OUTFIT)         │ │   │
│  │  │                                                              │ │   │
│  │  │  💡 只存储"套餐包含哪些组件"和"热点位置"                       │ │   │
│  │  └────────────────────────────────────────────────────────────┘ │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### ServiceComponent（平台组件模板）

```prisma
model ServiceComponent {
  id              String          @id @default(cuid())
  code            String          @unique  // 全局唯一编码

  // 基本信息（平台定义的"种类"）
  name            String           // "振袖和服"、"摄影跟拍"
  nameJa          String?
  nameEn          String?

  // 组件类型
  type            ComponentType    // OUTFIT | ADDON

  // 默认展示信息（商户未自定义时使用）
  icon            String?          // Emoji 图标
  description     String?          // 默认描述
  images          String[]         // 默认图片
  highlights      String[]         // 亮点列表

  // 建议价（仅 ADDON 类型有意义）
  basePrice       Int             @default(0)

  // 所有权
  isSystemComponent Boolean       @default(true)   // true=平台组件
  status          ComponentStatus @default(APPROVED)

  // 元数据
  displayOrder    Int             @default(0)
  isActive        Boolean         @default(true)

  // 关联
  planComponents       PlanComponent[]
  merchantOverrides    MerchantComponentOverride[]
}

enum ComponentType {
  OUTFIT    // 套餐包含服务（不定价，热图可显示）
  ADDON     // 增值服务（商户定价，加购）
}
```

### MerchantComponentOverride（商户自定义内容）

```prisma
model MerchantComponentOverride {
  id            String   @id @default(cuid())

  // 关联
  merchantId    String
  merchant      Merchant @relation(...)
  componentId   String
  component     ServiceComponent @relation(...)

  // ========== 商户自定义内容 ==========
  // null/空 = 使用平台默认内容
  description   String?          // 商户说明
  images        String[]         // 商户图片

  // ========== 仅 ADDON 类型 ==========
  price         Int?             // 商户定价（null = 使用平台建议价）

  // ========== 启用状态 ==========
  isEnabled     Boolean  @default(true)

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@unique([merchantId, componentId])
}
```

**设计说明**：
- 商户可自定义描述和图片，展示自己的服务特色
- 如果商户未自定义，显示平台提供的默认内容
- 价格字段仅对 ADDON 类型有意义（OUTFIT 不定价）
- 商户级别配置，设一次后所有套餐通用

### PlanComponent（套餐-组件关联）

```prisma
model PlanComponent {
  id                   String           @id @default(cuid())
  planId               String
  componentId          String

  plan                 RentalPlan       @relation(...)
  component            ServiceComponent @relation(...)

  // 热点图配置（仅 OUTFIT 类型）
  hotmapX              Float?           // 百分比坐标 0-1
  hotmapY              Float?
  hotmapLabelPosition  String           @default("right")
  hotmapOrder          Int              @default(0)

  createdAt            DateTime         @default(now())
  updatedAt            DateTime         @updatedAt

  @@unique([planId, componentId])
}
```

**设计说明**：
- 只存储"套餐包含哪些组件"和"热点位置"
- 移除了 `isIncluded`、`quantity` 等字段（简化）
- 组件的描述、图片、价格从 MerchantComponentOverride 获取

---

## 内容展示逻辑

### 两层信息模式

用户看到的组件信息分为两层：

```
┌─────────────────────────────────────────────────────────────────────────┐
│  组件展示                                                                │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  [振袖和服]  ← 组件类型名称（平台定义，统一展示）                           │
│                                                                         │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │  [商户上传的振袖图片]                                             │   │
│  │                                                                  │   │
│  │  我们提供多款传统古典风格的正绢振袖，                              │   │
│  │  包括鹤、樱花、牡丹等吉祥图案。                                   │   │
│  │  所有振袖均为日本进口，每日限量 3 套。                             │   │
│  │                                                                  │   │
│  │  ← 商户说明（商户自定义，展示特色）                                │   │
│  │  ← 如果商户未自定义，显示平台默认描述                              │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### 内容获取优先级

```typescript
// 获取组件展示内容
function getComponentDisplay(
  component: ServiceComponent,
  override: MerchantComponentOverride | null
) {
  return {
    // 名称始终使用平台定义（保证一致性）
    name: component.name,
    icon: component.icon,

    // 描述和图片优先使用商户自定义
    description: override?.description || component.description,
    images: override?.images?.length ? override.images : component.images,

    // 价格仅 ADDON 类型有意义
    price: component.type === 'ADDON'
      ? (override?.price ?? component.basePrice)
      : null,
  };
}
```

---

## 价格体系

### 简化设计

```
┌─────────────────────────────────────────────────────────────────────────┐
│  价格模型                                                                │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  OUTFIT (套餐包含服务)                                                   │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │  ❌ 不单独定价                                                   │   │
│  │  价格已包含在套餐价格内                                           │   │
│  │  用户只需要知道"套餐包含什么"，不需要知道每项值多少                 │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│  ADDON (增值服务)                                                        │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │  ✅ 商户自定义价格                                               │   │
│  │  平台提供建议价 (ServiceComponent.basePrice)                     │   │
│  │  商户可覆盖 (MerchantComponentOverride.price)                    │   │
│  │  用户可选加购，在套餐基础上增加订单金额                            │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### 套餐价格计算

```typescript
// 订单总价 = 套餐价 + Σ(用户选中的 ADDON 价格)
function calculateOrderTotal(
  plan: RentalPlan,
  selectedAddonIds: string[],
  merchantId: string
): number {
  let total = plan.price;  // 套餐基础价（已包含所有 OUTFIT）

  // 加上用户选中的增值服务
  for (const addonId of selectedAddonIds) {
    const addonPrice = getAddonPrice(addonId, merchantId);
    total += addonPrice;
  }

  return total;
}

// 获取 ADDON 价格
function getAddonPrice(componentId: string, merchantId: string): number {
  const override = getMerchantOverride(merchantId, componentId);
  const component = getComponent(componentId);

  return override?.price ?? component.basePrice ?? 0;
}
```

---

## 热点图系统

### 仅 OUTFIT 显示在热点图

```
┌─────────────────────────────────────────────────────────────────────────┐
│  热点图展示                                                              │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  ┌─────────────────────────────────┐                                   │
│  │                                 │                                   │
│  │      ●─── 振袖和服              │  ← OUTFIT：显示在热点图上          │
│  │                                 │                                   │
│  │           ●─── 帯・帯締め       │  ← OUTFIT：显示在热点图上          │
│  │                                 │                                   │
│  │                 ●─── 草履       │  ← OUTFIT：显示在热点图上          │
│  │                                 │                                   │
│  └─────────────────────────────────┘                                   │
│                                                                         │
│  增值服务（可选加购）                                                     │
│  ┌─────────────────────────────────┐                                   │
│  │ 📷 摄影跟拍    +¥3,000  [添加]  │  ← ADDON：列表展示，用户可选      │
│  │ 🧳 行李寄存    +¥500    [添加]  │                                   │
│  │ 🚗 接送服务    +¥1,500  [添加]  │                                   │
│  └─────────────────────────────────┘                                   │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### 热点坐标

- **坐标系统**：百分比坐标 (0-1)
- **存储位置**：`PlanComponent.hotmapX/Y`
- **标签方向**：`hotmapLabelPosition` (left | right)
- **自动计算**：热点在图片左半边 → 标签右侧，反之亦然

---

## 前端组件

### 组件架构

```
src/
├── app/(main)/merchant/
│   ├── components/
│   │   ├── page.tsx                # 商户组件配置页面（服务端）
│   │   └── ComponentsClient.tsx    # 商户组件配置（客户端交互）
│   └── dashboard/
│       └── page.tsx                # 商户控制台
├── components/
│   ├── merchant/
│   │   ├── PlanComponentEditor.tsx     # 主编辑器（三栏式工作台）
│   │   └── ServiceComponentSelector.tsx # 简化选择器
│   ├── plan/
│   │   └── InteractiveKimonoMap/
│   │       ├── index.tsx               # 用户端交互地图
│   │       ├── Hotspot.tsx             # 热点展示
│   │       └── ComponentDetailPanel.tsx # 组件详情面板
│   └── shared/
│       └── EditorHotspot.tsx           # 统一热点组件
└── app/api/merchant/
    └── component-overrides/
        └── route.ts                    # 商户组件配置 API
```

### 商户组件配置页面

```
┌─────────────────────────────────────────────────────────────────────────┐
│  我的服务组件配置                                                         │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  💡 在此配置您提供的服务内容，适用于所有套餐                               │
│  💡 如果不填写，将显示平台提供的默认内容                                   │
│                                                                         │
│  ─────────────────────────────────────────────────────────────────────  │
│  👘 套餐包含服务 (OUTFIT)                                                │
│  ─────────────────────────────────────────────────────────────────────  │
│                                                                         │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │ 振袖和服                                              [启用 ✓]  │   │
│  │                                                                  │   │
│  │ 我的说明：[                                                    ] │   │
│  │ 我们提供多款传统古典风格振袖，鹤、樱花、牡丹图案...               │   │
│  │                                                                  │   │
│  │ 我的图片：[上传图片] [图1] [图2] [图3]                           │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│  ─────────────────────────────────────────────────────────────────────  │
│  ✨ 增值服务 (ADDON)                                                     │
│  ─────────────────────────────────────────────────────────────────────  │
│                                                                         │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │ 摄影跟拍                                              [启用 ✓]  │   │
│  │                                                                  │   │
│  │ 我的定价：[¥3,000    ] (平台建议价：¥2,500)                      │   │
│  │                                                                  │   │
│  │ 我的说明：[                                                    ] │   │
│  │ 专业摄影师全程跟拍，包含 50 张精修照片...                         │   │
│  │                                                                  │   │
│  │ 我的图片：[上传图片] [作品1] [作品2]                             │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### PlanComponentEditor（三栏式工作台）

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│  组件配置  •  已选 3 项  •  已放置 2 项                    [50%] [100%] [200%]  │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│  ┌─ 组件库 ──────┐  ┌─ 画布区域 (可滚动) ──────────────┐  ┌─ 属性面板 ────────┐ │
│  │               │  │                                  │  │                   │ │
│  │  🔍 搜索...   │  │      [热点图 450×600]            │  │  📋 套餐概览       │ │
│  │               │  │                                  │  │                   │ │
│  │  ▼ 👘 套餐包含│  │      ●─── 振袖和服               │  │  包含组件: 3      │ │
│  │  ┌──────────┐ │  │                                  │  │  已放置热点: 2    │ │
│  │  │☑ 振袖和服│ │  │           ●─── 帯・帯締め        │  │                   │ │
│  │  │☑ 帯     │ │  │                                  │  │  ─────────────    │ │
│  │  │☐ 草履   │ │  │                                  │  │                   │ │
│  │  └──────────┘ │  │                                  │  │  (选中组件后显示   │ │
│  │               │  │  点击组件进入放置模式            │  │   组件详情面板)    │ │
│  │  ▶ ✨ 增值服务│  │  点击画布放置热点                │  │                   │ │
│  │               │  │  拖拽热点调整位置                │  │                   │ │
│  └───────────────┘  └──────────────────────────────────┘  └───────────────────┘ │
│                                                                                 │
└─────────────────────────────────────────────────────────────────────────────────┘
```

**交互流程**：

1. 在左侧组件库勾选组件
2. OUTFIT 类型：点击画布放置热点，拖拽调整位置
3. ADDON 类型：无需放置热点，在服务列表中展示
4. 右侧显示组件详情（商户自定义的内容）
5. 保存 → 调用 API 更新套餐

---

## API 接口

### GET /api/service-components

获取平台组件模板

**响应**：

```json
{
  "categories": [
    {
      "type": "OUTFIT",
      "label": "套餐包含服务",
      "icon": "👘",
      "components": [
        {
          "id": "comp-1",
          "code": "KIMONO_FURISODE",
          "name": "振袖和服",
          "type": "OUTFIT",
          "icon": "👘",
          "description": "华丽的正装振袖...",
          "images": ["default-furisode.jpg"]
        }
      ]
    },
    {
      "type": "ADDON",
      "label": "增值服务",
      "icon": "✨",
      "components": [
        {
          "id": "comp-5",
          "code": "ADDON_PHOTO",
          "name": "摄影跟拍",
          "type": "ADDON",
          "icon": "📷",
          "description": "专业摄影师跟拍...",
          "basePrice": 250000
        }
      ]
    }
  ]
}
```

### PATCH /api/merchant/component-overrides

更新商户组件配置

**请求体**：

```json
{
  "componentId": "comp-5",
  "description": "我们的专业摄影师...",
  "images": ["my-photo-1.jpg", "my-photo-2.jpg"],
  "price": 300000,
  "isEnabled": true
}
```

### PATCH /api/merchant/plans/[id]

更新套餐组件配置

**请求体**：

```json
{
  "name": "豪华振袖体验",
  "price": 1980000,
  "componentConfigs": [
    {
      "componentId": "comp-1",
      "hotmapX": 0.3,
      "hotmapY": 0.4,
      "hotmapLabelPosition": "right"
    },
    {
      "componentId": "comp-2",
      "hotmapX": 0.5,
      "hotmapY": 0.6,
      "hotmapLabelPosition": "left"
    }
  ]
}
```

---

## 实现状态

### v9.1 已完成

| 功能 | 状态 | 说明 |
|------|------|------|
| ServiceComponent 模型 | ✅ | 平台组件模板 |
| PlanComponent 模型 | ✅ | 套餐-组件关联 |
| MerchantComponentOverride 模型 | ✅ | 商户覆盖配置（需扩展） |
| PlanComponentEditor（三栏式）| ✅ | 套餐编辑器 UI |
| /merchant/components 页面 | ✅ | 商户组件配置（需更新） |

### v10 待实现

| 功能 | 优先级 | 说明 |
|------|--------|------|
| MerchantComponentOverride 扩展 | P1 | 添加 description, images 字段 |
| 商户组件配置页面更新 | P1 | 支持编辑描述和上传图片 |
| PlanComponentEditor 简化 | P1 | 移除升级系统相关代码 |
| 移除 ComponentUpgrade 模型 | P1 | 删除升级系统 |
| 移除 PlanUpgradeBundle 模型 | P1 | 删除升级包系统 |
| OUTFIT/ADDON 价格逻辑 | P1 | OUTFIT 不定价，ADDON 商户定价 |

---

## 更新日志

| 版本 | 日期 | 变更 |
|------|------|------|
| v10 | 2024-12 | 简化组件类型：OUTFIT（套餐包含，不定价）vs ADDON（增值服务，商户定价）；移除组件升级系统；商户可自定义内容（描述、图片） |
| v9.1 | 2024-12 | MerchantComponentOverride 模型；PlanComponentEditor 三栏式布局 |
| v9 | 2024-12 | 平台统一管理组件，商户定价规划 |
| v8 | 2024-11 | 简化为 copy-on-use 模式（已废弃）|

---

## 设计决策记录

### 为什么 OUTFIT 不定价？

**问题**：
- 套餐是一个整体产品，用户关心的是套餐总价
- 拆分组件价格可能造成用户困惑
- 用户可能会质疑："这个¥19,800的套餐里，和服¥10,000、造型¥5,000，那我不是多付了？"

**解决方案**：
- OUTFIT 类型组件不单独定价
- 套餐价格是一个整体，包含所有 OUTFIT
- 用户只需要知道"套餐包含什么"，不需要知道每项值多少

### 为什么移除组件升级系统？

**问题**：
- 升级系统（ComponentUpgrade, PlanUpgradeBundle）增加了复杂度
- 商户和用户都难以理解升级路径
- 管理和展示逻辑复杂

**解决方案**：
- 移除升级系统
- 商户可以创建不同档次的套餐（基础版、豪华版）
- 用户直接选择不同套餐，而不是"升级"组件

### 为什么让商户自定义内容？

**问题**：
- 不同商户的服务确实有差异（和服风格、摄影师水平等）
- 用户可能想了解具体商户提供的服务细节
- 平台统一的描述无法展示商户特色

**解决方案**：
- 组件"种类"由平台定义（名称、类型）
- 组件"内容"由商户自定义（描述、图片、ADDON价格）
- 如果商户未自定义，显示平台默认内容
- 质量控制靠市场自然筛选，平台不审核

### 两层信息的好处

1. **用户比较方便**：组件类型名称统一（"都提供振袖和服"）
2. **商户差异化**：商户可以展示自己的特色
3. **默认值兜底**：商户懒得填也有内容显示
4. **渐进式完善**：商户可以先启用，后续再完善描述和图片
