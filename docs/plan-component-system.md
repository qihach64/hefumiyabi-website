# å¥—é¤ç»„ä»¶ç³»ç»Ÿè®¾è®¡æ–‡æ¡£

> **ç‰ˆæœ¬**: v9 (2024-12)
> **çŠ¶æ€**: å½“å‰å®ç° + è®¾è®¡è§„åˆ’

---

## æ¦‚è¿°

å¥—é¤ç»„ä»¶ç³»ç»Ÿæ˜¯å’Œæœç§Ÿèµå¹³å°çš„æ ¸å¿ƒåŠŸèƒ½ï¼Œç”¨äºï¼š

1. **å•†æˆ·ç«¯**ï¼šåˆ›å»ºå’Œç¼–è¾‘å¥—é¤å†…å®¹ï¼Œé…ç½®æœåŠ¡ç»„ä»¶å’Œçƒ­ç‚¹å›¾
2. **ç”¨æˆ·ç«¯**ï¼šå±•ç¤ºå¥—é¤åŒ…å«çš„æœåŠ¡ï¼Œæ”¯æŒäº¤äº’å¼å’Œæœçƒ­ç‚¹å›¾
3. **å¹³å°ç«¯**ï¼šç»Ÿä¸€ç®¡ç†æœåŠ¡ç»„ä»¶åº“ï¼ŒæŒ‰ä¸»é¢˜ç»„ç»‡æ¨è

### è®¾è®¡åŸåˆ™

| åŸåˆ™ | è¯´æ˜ |
|------|------|
| **å¹³å°ç»Ÿä¸€ç®¡ç†** | ç»„ä»¶ç”±å¹³å°å®šä¹‰ï¼Œå•†æˆ·åªèƒ½é€‰æ‹©å’Œå®šä»· |
| **å‡å°‘é€‰æ‹©å›°éš¾** | æŒ‰ä¸»é¢˜æ¨èç»„ä»¶ï¼Œç®€åŒ–å•†æˆ·æ“ä½œ |
| **è§†è§‰ä¸€è‡´æ€§** | ç¼–è¾‘å™¨å’Œç”¨æˆ·ç«¯ä½¿ç”¨åŒä¸€æ¸²æŸ“ç»„ä»¶ï¼ˆWYSIWYGï¼‰|
| **çµæ´»å‡çº§** | ä¸‰å±‚ä¼˜å…ˆçº§ï¼šå•†æˆ· > ä¸»é¢˜ > å…¨å±€ |

---

## ç»„ä»¶ç±»å‹

### OUTFIT vs ADDON

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  OUTFIT (ç€è£…é¡¹)                    ADDON (å¢å€¼æœåŠ¡)             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ğŸ‘˜ å’Œæœã€é…é¥°ã€é€ å‹ç­‰               ğŸ“· è·Ÿæ‹ã€å¯„å­˜ã€æ¥é€ç­‰         â”‚
â”‚  âœ… éœ€è¦çƒ­ç‚¹å›¾å®šä½                   âŒ ä¸éœ€è¦çƒ­ç‚¹å›¾å®šä½           â”‚
â”‚  âœ… æ˜¾ç¤ºåœ¨å’Œæœå›¾ä¸Š                   âœ… åœ¨æœåŠ¡åˆ—è¡¨ä¸­å±•ç¤º           â”‚
â”‚  âœ… æ”¯æŒå‡çº§è·¯å¾„                     âœ… æ”¯æŒå‡çº§è·¯å¾„               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ—§ç±»å‹å…¼å®¹

| æ—§ç±»å‹ | æ˜ å°„åˆ° |
|--------|--------|
| KIMONO | OUTFIT |
| STYLING | OUTFIT |
| ACCESSORY | OUTFIT |
| EXPERIENCE | ADDON |

---

## æ•°æ®æ¨¡å‹

### æ ¸å¿ƒæ¨¡å‹å…³ç³»

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              å¹³å°å±‚                                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                         â”‚
â”‚  ServiceComponent (å¹³å°ç»„ä»¶åº“ - ç»Ÿä¸€ç®¡ç†)                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  id, code, name, type, icon, basePrice, tier, highlights...     â”‚   â”‚
â”‚  â”‚  isSystemComponent: true (å¹³å°ç»„ä»¶)                              â”‚   â”‚
â”‚  â”‚  status: APPROVED (å®¡æ ¸é€šè¿‡)                                     â”‚   â”‚
â”‚  â”‚                                                                  â”‚   â”‚
â”‚  â”‚  ğŸ’¡ ç»„ä»¶ä¿¡æ¯ç”±å¹³å°ç»Ÿä¸€ç®¡ç†ï¼Œå•†æˆ·ä¸èƒ½ä¿®æ”¹                           â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚         â”‚                                                               â”‚
â”‚         â”‚ ComponentUpgrade (å‡çº§è·¯å¾„)                                   â”‚
â”‚         â”‚ scope: PLATFORM | MERCHANT                                   â”‚
â”‚         â–¼                                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  fromComponentId â†’ toComponentId                                 â”‚   â”‚
â”‚  â”‚  priceDiff: å‡çº§å·®ä»·                                             â”‚   â”‚
â”‚  â”‚  label: "å‡çº§ä¸ºæŒ¯è¢–"                                             â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                          å•†æˆ·è®¾ç½®ä»·æ ¼ï¼ˆå•†æˆ·çº§åˆ«ï¼‰
                                    â”‚
                                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              å•†æˆ·å±‚                                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                         â”‚
â”‚  MerchantComponentOverride (å•†æˆ·å®šä»· - å•†æˆ·çº§åˆ«ï¼Œæ‰€æœ‰å¥—é¤é€šç”¨)               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  merchantId, componentId                                         â”‚   â”‚
â”‚  â”‚  price: å•†æˆ·å®šä»·ï¼ˆè¦†ç›–å¹³å°å»ºè®®ä»·ï¼‰                                 â”‚   â”‚
â”‚  â”‚  isEnabled: æ˜¯å¦å¯ç”¨æ­¤ç»„ä»¶                                        â”‚   â”‚
â”‚  â”‚                                                                  â”‚   â”‚
â”‚  â”‚  ğŸ’¡ è®¾ä¸€æ¬¡ï¼Œæ‰€æœ‰å¥—é¤é€šç”¨                                          â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                         â”‚
â”‚  RentalPlan (å¥—é¤)                                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  id, name, price, themeId, hotmapImageUrl, hotmapTemplateId     â”‚   â”‚
â”‚  â”‚                                                                  â”‚   â”‚
â”‚  â”‚  PlanComponent[] (å¥—é¤-ç»„ä»¶å…³è” - åªå­˜ä½ç½®ä¿¡æ¯)                    â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚   â”‚
â”‚  â”‚  â”‚  componentId, isIncluded, quantity                          â”‚ â”‚   â”‚
â”‚  â”‚  â”‚  hotmapX, hotmapY, hotmapLabelPosition (çƒ­ç‚¹ä½ç½®)           â”‚ â”‚   â”‚
â”‚  â”‚  â”‚                                                              â”‚ â”‚   â”‚
â”‚  â”‚  â”‚  ğŸ’¡ ä¸å­˜å‚¨è¦†ç›–ä¿¡æ¯ï¼Œç»„ä»¶åç§°/ä»·æ ¼ç”±å¹³å°+å•†æˆ·å®šä»·å†³å®š           â”‚ â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚   â”‚
â”‚  â”‚                                                                  â”‚   â”‚
â”‚  â”‚  PlanUpgradeBundle[] (ä¸€é”®å‡çº§åŒ…)                                â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚   â”‚
â”‚  â”‚  â”‚  label: "è±ªåå‡çº§åŒ…"                                        â”‚ â”‚   â”‚
â”‚  â”‚  â”‚  bundlePrice: æ‰“åŒ…ä»·                                        â”‚ â”‚   â”‚
â”‚  â”‚  â”‚  upgradeItems: JSON (å‡çº§æ¸…å•)                              â”‚ â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### è®¾è®¡ç®€åŒ–è¦ç‚¹

| ä¹‹å‰ | ä¹‹å |
|------|------|
| PlanComponent å­˜å‚¨ nameOverride, descriptionOverride ç­‰ | ç§»é™¤ï¼Œç»„ä»¶ä¿¡æ¯ç”±å¹³å°ç»Ÿä¸€ç®¡ç† |
| æ¯ä¸ªå¥—é¤å¯å•ç‹¬è®¾ç½®ç»„ä»¶ä»·æ ¼ | å•†æˆ·çº§åˆ«å®šä»·ï¼ˆMerchantComponentOverrideï¼‰|
| å•†æˆ·å¯ä¿®æ”¹ç»„ä»¶å±•ç¤ºä¿¡æ¯ | å•†æˆ·åªèƒ½æ§åˆ¶ä»·æ ¼å’Œå¯ç”¨/ç¦ç”¨ |

**ä¼˜åŠ¿**ï¼š
- ç”¨æˆ·ä½“éªŒä¸€è‡´ï¼šåŒä¸€ç»„ä»¶åœ¨ä¸åŒå¥—é¤ä¸­å±•ç¤ºç›¸åŒ
- ç®¡ç†ç®€å•ï¼šå•†æˆ·è®¾ä¸€æ¬¡ä»·æ ¼ï¼Œæ‰€æœ‰å¥—é¤é€šç”¨
- å¹³å°å¯æ§ï¼šç»„ä»¶è´¨é‡å’Œå±•ç¤ºç”±å¹³å°ä¿è¯

### ServiceComponent

```prisma
model ServiceComponent {
  id              String          @id @default(cuid())
  code            String          @unique  // å…¨å±€å”¯ä¸€ç¼–ç 

  // åŸºæœ¬ä¿¡æ¯
  name            String
  nameJa          String?
  nameEn          String?
  description     String?

  // ç»„ä»¶ç±»å‹
  type            ComponentType   // OUTFIT | ADDON

  // å±•ç¤ºä¿¡æ¯
  icon            String?         // Emoji å›¾æ ‡
  imageUrl        String?         // å¡ç‰‡å›¾ç‰‡
  highlights      String[]        // äº®ç‚¹åˆ—è¡¨
  images          String[]        // è¯¦æƒ…å›¾é›†

  // å‡çº§å±‚çº§
  tier            Int             @default(0)  // 0=åŸºç¡€, 1=æ ‡å‡†, 2=è±ªå, 3=é¡¶çº§
  tierLabel       String?                      // "è±ªåç‰ˆ"

  // å®šä»·
  basePrice       Int             @default(0)  // å¹³å°å»ºè®®ä»·ï¼ˆåˆ†ï¼‰

  // æ‰€æœ‰æƒ
  isSystemComponent Boolean       @default(false)  // true=å¹³å°ç»„ä»¶
  merchantId      String?                          // å•†æˆ·ç»„ä»¶çš„æ‰€æœ‰è€…
  status          ComponentStatus @default(PENDING) // å®¡æ ¸çŠ¶æ€

  // å…ƒæ•°æ®
  displayOrder    Int             @default(0)
  isActive        Boolean         @default(true)

  // å…³è”
  planComponents       PlanComponent[]
  upgradesFrom         ComponentUpgrade[] @relation("UpgradeFrom")
  upgradesTo           ComponentUpgrade[] @relation("UpgradeTo")
}

enum ComponentType {
  OUTFIT    // ç€è£…é¡¹ï¼ˆéœ€çƒ­ç‚¹å›¾å®šä½ï¼‰
  ADDON     // å¢å€¼æœåŠ¡ï¼ˆä¸éœ€è¦å®šä½ï¼‰
  // ä»¥ä¸‹ä¸ºå…¼å®¹æ—§æ•°æ®
  KIMONO
  STYLING
  ACCESSORY
  EXPERIENCE
}
```

### PlanComponent

```prisma
model PlanComponent {
  id              String   @id @default(cuid())

  // å…³è”
  planId          String
  plan            RentalPlan @relation(...)
  componentId     String
  component       ServiceComponent @relation(...)

  // å¥—é¤é…ç½®
  isIncluded      Boolean  @default(true)   // æ˜¯å¦åŒ…å«åœ¨å¥—é¤åŸºç¡€ä»·
  quantity        Int      @default(1)

  // çƒ­ç‚¹å›¾é…ç½®ï¼ˆä»… OUTFIT ç±»å‹ï¼‰
  hotmapX              Float?   // ç™¾åˆ†æ¯”åæ ‡ 0-1
  hotmapY              Float?
  hotmapLabelPosition  String   @default("right")  // left | right
  hotmapOrder          Int      @default(0)

  @@unique([planId, componentId])
}
```

**è®¾è®¡è¯´æ˜**ï¼š
- ç§»é™¤äº†å¥—é¤çº§åˆ«çš„å•†æˆ·è¦†ç›–å­—æ®µï¼ˆnameOverride, descriptionOverride ç­‰ï¼‰
- ç»„ä»¶ä¿¡æ¯ç”±å¹³å°ç»Ÿä¸€ç®¡ç†ï¼Œå•†æˆ·ä¸èƒ½ä¿®æ”¹
- ä»·æ ¼åœ¨å•†æˆ·çº§åˆ«è¦†ç›–ï¼ˆè§ MerchantComponentOverrideï¼‰

### MerchantComponentOverrideï¼ˆå•†æˆ·è¦†ç›–é…ç½®ï¼‰

```prisma
model MerchantComponentOverride {
  id            String   @id @default(cuid())

  // å•†æˆ·
  merchantId    String
  merchant      Merchant @relation(...)

  // å¹³å°ç»„ä»¶
  componentId   String
  component     ServiceComponent @relation(...)

  // ========== ä»·æ ¼è¦†ç›– ==========
  price         Int?     // å•†æˆ·å®šä»·ï¼ˆnull = ä½¿ç”¨å¹³å°å»ºè®®ä»·ï¼‰

  // ========== å¯ç”¨çŠ¶æ€ ==========
  isEnabled     Boolean  @default(true)  // æ˜¯å¦å¯ç”¨æ­¤ç»„ä»¶

  // ========== é¢„ç•™æ‰©å±•å­—æ®µ ==========
  // æœªæ¥å¯æ·»åŠ å…¶ä»–è¦†ç›–å­—æ®µï¼Œå¦‚ï¼š
  // customNote    String?  // å•†æˆ·å¤‡æ³¨
  // sortOrder     Int?     // å•†æˆ·è‡ªå®šä¹‰æ’åº

  @@unique([merchantId, componentId])
}
```

**è®¾è®¡è¯´æ˜**ï¼š
- å•†æˆ·çº§åˆ«é…ç½®ï¼Œè®¾ä¸€æ¬¡åæ‰€æœ‰å¥—é¤é€šç”¨
- å•†æˆ·å¯ç¦ç”¨ä¸æƒ³æä¾›çš„ç»„ä»¶ï¼ˆisEnabled = falseï¼‰
- ä»·æ ¼è¦†ç›–ï¼šè®¾ç½® price è¦†ç›–å¹³å°å»ºè®®ä»·ï¼Œnull è¡¨ç¤ºä½¿ç”¨å¹³å°å»ºè®®ä»·
- å‘½åä¸º Override è€Œé Priceï¼Œä¸ºæœªæ¥æ‰©å±•é¢„ç•™ç©ºé—´

### ComponentUpgrade

```prisma
model ComponentUpgrade {
  id              String   @id @default(cuid())

  // å‡çº§é“¾
  fromComponentId String
  fromComponent   ServiceComponent @relation("UpgradeFrom", ...)
  toComponentId   String
  toComponent     ServiceComponent @relation("UpgradeTo", ...)

  // å·®ä»·
  priceDiff       Int      // å‡çº§å·®ä»·ï¼ˆåˆ†ï¼‰

  // ä½œç”¨åŸŸ
  scope           UpgradeScope  // PLATFORM | MERCHANT
  scopeId         String?       // themeId | merchantId | null

  // å±•ç¤º
  label           String?       // "å‡çº§ä¸ºæŒ¯è¢–"
  description     String?
  isRecommended   Boolean  @default(false)
  displayOrder    Int      @default(0)
  isActive        Boolean  @default(true)

  @@unique([fromComponentId, toComponentId, scope, scopeId])
}

enum UpgradeScope {
  PLATFORM   // å¹³å°é¢„è®¾ï¼ˆscopeId = themeId æˆ– nullï¼‰
  MERCHANT   // å•†æˆ·è‡ªå®šä¹‰ï¼ˆscopeId = merchantIdï¼‰
}
```

### å‡çº§ä¼˜å…ˆçº§

```typescript
// æŸ¥è¯¢ä¼˜å…ˆçº§ï¼šMERCHANT > PLATFORM(themeId) > PLATFORM(null)
function getUpgradePriority(scope: string, scopeId: string | null, merchantId: string, themeId: string | null): number {
  if (scope === 'MERCHANT' && scopeId === merchantId) return 3;  // æœ€é«˜
  if (scope === 'PLATFORM' && scopeId === themeId && themeId !== null) return 2;
  if (scope === 'PLATFORM' && scopeId === null) return 1;  // æœ€ä½
  return 0;
}
```

---

## çƒ­ç‚¹å›¾ç³»ç»Ÿ

### å›¾ç‰‡æ¥æº

```typescript
async function getHotmapImage(plan: RentalPlan): Promise<string | null> {
  // 1. å•†æˆ·è‡ªå®šä¹‰å›¾ç‰‡ï¼ˆæœ€é«˜ä¼˜å…ˆçº§ï¼‰
  if (plan.hotmapImageUrl) {
    return plan.hotmapImageUrl;
  }

  // 2. å•†æˆ·é€‰æ‹©çš„å¹³å°æ¨¡æ¿
  if (plan.hotmapTemplateId) {
    const template = await prisma.mapTemplate.findUnique({
      where: { id: plan.hotmapTemplateId }
    });
    return template?.imageUrl ?? null;
  }

  // éƒ½ä¸ºç©º = ä¸æ˜¾ç¤ºçƒ­ç‚¹å›¾
  return null;
}
```

### çƒ­ç‚¹åæ ‡

- **åæ ‡ç³»ç»Ÿ**ï¼šç™¾åˆ†æ¯”åæ ‡ (0-1)
- **å­˜å‚¨ä½ç½®**ï¼š`PlanComponent.hotmapX/Y`ï¼ˆæ¯å¥—é¤ç‹¬ç«‹ï¼‰
- **æ ‡ç­¾æ–¹å‘**ï¼š`hotmapLabelPosition` (left | right)
- **è‡ªåŠ¨è®¡ç®—**ï¼šçƒ­ç‚¹åœ¨å›¾ç‰‡å·¦åŠè¾¹ â†’ æ ‡ç­¾å³ä¾§ï¼Œåä¹‹äº¦ç„¶

### çƒ­ç‚¹æ¸²æŸ“ï¼ˆEditorHotspotï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                             â”‚
â”‚      â—â”€â”€â”€â”€â”€â”€â”€ æŒ¯è¢–å’Œæœ                       â”‚   â† çƒ­ç‚¹ + è¿æ¥çº¿ + æ ‡ç­¾
â”‚                                             â”‚
â”‚              â—â”€â”€â”€â”€â”€â”€â”€ å¸¯ãƒ»å¸¯ç· ã‚             â”‚
â”‚                                             â”‚
â”‚                     â—â”€â”€â”€â”€â”€â”€â”€ è‰å±¥           â”‚
â”‚                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

çƒ­ç‚¹æ ·å¼ï¼š
- åœ†ç‚¹ï¼š6pxï¼Œsakura-500 èƒŒæ™¯
- è„‰å†²åŠ¨ç”»ï¼šhover æ—¶æš‚åœ
- è¿æ¥çº¿ï¼š32pxï¼Œæ¸å˜é€æ˜
- æ ‡ç­¾ï¼šç™½è‰²èƒŒæ™¯ï¼Œé˜´å½±
```

---

## å‰ç«¯ç»„ä»¶

### ç»„ä»¶æ¶æ„

```
src/components/
â”œâ”€â”€ merchant/
â”‚   â”œâ”€â”€ PlanComponentEditor.tsx     # ä¸»ç¼–è¾‘å™¨ï¼ˆçƒ­ç‚¹ + ç»„ä»¶é€‰æ‹©ï¼‰
â”‚   â”œâ”€â”€ ServiceComponentSelector.tsx # ç®€åŒ–é€‰æ‹©å™¨ï¼ˆæ— çƒ­ç‚¹ï¼‰
â”‚   â””â”€â”€ HotspotEditor.tsx           # æ¨¡æ¿çº§çƒ­ç‚¹ç¼–è¾‘
â”œâ”€â”€ plan/
â”‚   â””â”€â”€ InteractiveKimonoMap/
â”‚       â”œâ”€â”€ index.tsx               # ç”¨æˆ·ç«¯äº¤äº’åœ°å›¾
â”‚       â”œâ”€â”€ Hotspot.tsx             # çƒ­ç‚¹å±•ç¤º
â”‚       â”œâ”€â”€ ComponentDetailPanel.tsx # ç»„ä»¶è¯¦æƒ…é¢æ¿
â”‚       â””â”€â”€ types.ts                # ç±»å‹å®šä¹‰
â””â”€â”€ shared/
    â””â”€â”€ EditorHotspot.tsx           # ç»Ÿä¸€çƒ­ç‚¹ç»„ä»¶ï¼ˆç¼–è¾‘ + å±•ç¤ºï¼‰
```

### PlanComponentEditor

**åŠŸèƒ½**ï¼šå¥—é¤å†…å®¹çš„å®Œæ•´ç¼–è¾‘å™¨

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å¥—é¤å†…å®¹ç¼–è¾‘å™¨                                            [ä¿å­˜] [é¢„è§ˆ] â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                         â”‚
â”‚  â”Œâ”€â”€ ç»„ä»¶é€‰æ‹© â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€ çƒ­ç‚¹å›¾é¢„è§ˆ (3:4) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                              â”‚   â”‚                                  â”‚ â”‚
â”‚  â”‚  ğŸ‘˜ ç€è£…é¡¹ (OUTFIT)          â”‚   â”‚      [å•†æˆ·ä¸Šä¼ çš„å’Œæœå›¾ç‰‡]         â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚   â”‚                                  â”‚ â”‚
â”‚  â”‚  â”‚ â˜‘ æŒ¯è¢–å’Œæœ      [â†“å‡çº§] â”‚ â”‚   â”‚      â—â”€â”€â”€ æŒ¯è¢–å’Œæœ               â”‚ â”‚
â”‚  â”‚  â”‚ â˜‘ å¸¯ãƒ»å¸¯ç· ã‚    [â†“å‡çº§] â”‚ â”‚   â”‚                                  â”‚ â”‚
â”‚  â”‚  â”‚ â˜ è‰å±¥ãƒ»è¶³è¢‹           â”‚ â”‚   â”‚           â—â”€â”€â”€ å¸¯ãƒ»å¸¯ç· ã‚        â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚   â”‚                                  â”‚ â”‚
â”‚  â”‚                              â”‚   â”‚                                  â”‚ â”‚
â”‚  â”‚  âœ¨ å¢å€¼æœåŠ¡ (ADDON)         â”‚   â”‚                                  â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚   â”‚                                  â”‚ â”‚
â”‚  â”‚  â”‚ â˜‘ ä¸“ä¸šè·Ÿæ‹             â”‚ â”‚   â”‚   ç‚¹å‡»çƒ­ç‚¹å¯æ‹–æ‹½è°ƒæ•´ä½ç½®          â”‚ â”‚
â”‚  â”‚  â”‚ â˜ è¡Œæå¯„å­˜             â”‚ â”‚   â”‚                                  â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                       â”‚
â”‚                                                                         â”‚
â”‚  ğŸ’¡ å‹¾é€‰ OUTFIT ç±»å‹ç»„ä»¶åï¼Œç‚¹å‡»çƒ­å›¾æ”¾ç½®çƒ­ç‚¹                             â”‚
â”‚  ğŸ’¡ ADDON ç±»å‹æ— éœ€æ”¾ç½®ä½ç½®                                              â”‚
â”‚                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**çŠ¶æ€ç®¡ç†**ï¼š

```typescript
interface ComponentConfig {
  componentId: string;
  isIncluded: boolean;
  enabledUpgrades: string[];  // å¯ç”¨çš„å‡çº§é€‰é¡¹
  hotmapX?: number | null;
  hotmapY?: number | null;
  hotmapLabelPosition?: string;
}
```

**äº¤äº’æµç¨‹**ï¼š

1. å‹¾é€‰ç»„ä»¶ â†’ å¦‚æœæ˜¯ OUTFIT ç±»å‹ï¼Œè¿›å…¥ã€Œæ”¾ç½®æ¨¡å¼ã€
2. ç‚¹å‡»çƒ­å›¾ â†’ æ”¾ç½®çƒ­ç‚¹ï¼Œè‡ªåŠ¨è®¡ç®—æ ‡ç­¾æ–¹å‘
3. æ‹–æ‹½çƒ­ç‚¹ â†’ è°ƒæ•´ä½ç½®
4. å±•å¼€å‡çº§é¢æ¿ â†’ å‹¾é€‰å¯ç”¨çš„å‡çº§é€‰é¡¹
5. ä¿å­˜ â†’ è°ƒç”¨ API æ›´æ–°å¥—é¤

### InteractiveKimonoMap

**åŠŸèƒ½**ï¼šç”¨æˆ·ç«¯çš„äº¤äº’å¼å’Œæœå±•ç¤º

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                                     â”‚  â”‚                        â”‚   â”‚
â”‚  â”‚    [çƒ­ç‚¹å›¾å±•ç¤ºåŒºåŸŸ]                  â”‚  â”‚  ç»„ä»¶è¯¦æƒ…é¢æ¿           â”‚   â”‚
â”‚  â”‚                                     â”‚  â”‚                        â”‚   â”‚
â”‚  â”‚    â—â”€â”€â”€ æŒ¯è¢–å’Œæœ â†(ç‚¹å‡»)            â”‚  â”‚  ğŸ‘˜ æŒ¯è¢–å’Œæœ            â”‚   â”‚
â”‚  â”‚           â—â”€â”€â”€ å¸¯                   â”‚  â”‚  âœ… å·²åŒ…å«             â”‚   â”‚
â”‚  â”‚                  â—â”€â”€â”€ è‰å±¥          â”‚  â”‚                        â”‚   â”‚
â”‚  â”‚                                     â”‚  â”‚  åä¸½çš„æ­£è£…æŒ¯è¢–...      â”‚   â”‚
â”‚  â”‚                                     â”‚  â”‚                        â”‚   â”‚
â”‚  â”‚                                     â”‚  â”‚  å¯å‡çº§ä¸ºï¼š            â”‚   â”‚
â”‚  â”‚                                     â”‚  â”‚  Â· é«˜çº§æŒ¯è¢– +Â¥5,000    â”‚   â”‚
â”‚  â”‚                                     â”‚  â”‚  Â· é¡¶çº§æŒ¯è¢– +Â¥10,000   â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ä¸¤ç§å¸ƒå±€**ï¼š

- **horizontal**ï¼šçƒ­å›¾å·¦ä¾§ï¼Œè¯¦æƒ…å³ä¾§ï¼ˆæ¡Œé¢ç«¯ï¼‰
- **vertical**ï¼šçƒ­å›¾ä¸Šæ–¹ï¼Œè¯¦æƒ…ä¸‹æ–¹å¼¹å‡ºï¼ˆç§»åŠ¨ç«¯ï¼‰

---

## API æ¥å£

### GET /api/service-components

è·å–å¹³å°ç»„ä»¶åº“ + å‡çº§è·¯å¾„

**Query å‚æ•°**ï¼š

| å‚æ•° | è¯´æ˜ |
|------|------|
| `themeId` | ä¸»é¢˜ IDï¼ˆè·å–ä¸»é¢˜ç‰¹å®šå‡çº§ï¼‰ |
| `merchantId` | å•†æˆ· IDï¼ˆè·å–å•†æˆ·è‡ªå®šä¹‰ç»„ä»¶ï¼‰ |

**å“åº”**ï¼š

```json
{
  "components": [...],
  "categories": [
    {
      "type": "OUTFIT",
      "label": "ç€è£…é¡¹",
      "icon": "ğŸ‘˜",
      "components": [...]
    },
    {
      "type": "ADDON",
      "label": "å¢å€¼æœåŠ¡",
      "icon": "âœ¨",
      "components": [...]
    }
  ],
  "upgradePaths": {
    "component-id-1": [
      {
        "id": "upgrade-1",
        "fromComponentId": "component-id-1",
        "toComponentId": "component-id-2",
        "priceDiff": 500000,
        "label": "å‡çº§ä¸ºæŒ¯è¢–",
        "isRecommended": true
      }
    ]
  }
}
```

### PATCH /api/merchant/plans/[id]

æ›´æ–°å¥—é¤ï¼ˆå«ç»„ä»¶é…ç½®ï¼‰

**è¯·æ±‚ä½“**ï¼š

```json
{
  "name": "è±ªåæŒ¯è¢–ä½“éªŒ",
  "price": 1980000,
  "componentConfigs": [
    {
      "componentId": "comp-1",
      "isIncluded": true,
      "enabledUpgrades": ["upgrade-1", "upgrade-2"],
      "hotmapX": 0.3,
      "hotmapY": 0.4,
      "hotmapLabelPosition": "right"
    },
    {
      "componentId": "comp-3",
      "isIncluded": true,
      "enabledUpgrades": [],
      "hotmapX": null,
      "hotmapY": null
    }
  ]
}
```

**å¤„ç†é€»è¾‘**ï¼š

1. æ›´æ–° RentalPlan åŸºæœ¬ä¿¡æ¯
2. åˆ é™¤æ—§çš„ PlanComponent è®°å½•
3. åˆ›å»ºæ–°çš„ PlanComponent è®°å½•ï¼ˆå«çƒ­ç‚¹ä½ç½®ï¼‰
4. æ”¶é›†æ‰€æœ‰ enabledUpgrades
5. åˆ›å»º PlanUpgradeBundleï¼ˆå¦‚æœ‰å‡çº§é€‰é¡¹ï¼‰

---

## ä»·æ ¼ä½“ç³»

### è®¾è®¡åŸåˆ™

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ä»·æ ¼å±‚çº§                                                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                         â”‚
â”‚  å¹³å°å»ºè®®ä»· (ServiceComponent.basePrice)                                 â”‚
â”‚       â†“                                                                 â”‚
â”‚  å•†æˆ·å®šä»· (MerchantComponentOverride.price) â† å•†æˆ·çº§åˆ«ï¼Œæ‰€æœ‰å¥—é¤é€šç”¨         â”‚
â”‚       â†“                                                                 â”‚
â”‚  æœ€ç»ˆä»·æ ¼ = å•†æˆ·å®šä»· ?? å¹³å°å»ºè®®ä»·                                        â”‚
â”‚                                                                         â”‚
â”‚  ğŸ’¡ æ²¡æœ‰å¥—é¤çº§åˆ«çš„ä»·æ ¼è¦†ç›–ï¼Œç®€åŒ–ç®¡ç†                                      â”‚
â”‚                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ä»·æ ¼è§£æ

```typescript
// è·å–ç»„ä»¶çš„æœ‰æ•ˆä»·æ ¼
async function getComponentPrice(
  componentId: string,
  merchantId: string
): Promise<number> {
  // 1. æŸ¥æ‰¾å•†æˆ·è¦†ç›–é…ç½®
  const override = await prisma.merchantComponentOverride.findUnique({
    where: { merchantId_componentId: { merchantId, componentId } }
  });

  // 2. å¦‚æœå•†æˆ·è®¾ç½®äº†ä»·æ ¼ï¼Œä½¿ç”¨å•†æˆ·ä»·æ ¼
  if (override?.price != null) {
    return override.price;
  }

  // 3. å¦åˆ™ä½¿ç”¨å¹³å°å»ºè®®ä»·
  const component = await prisma.serviceComponent.findUnique({
    where: { id: componentId }
  });

  return component?.basePrice ?? 0;
}

// æ£€æŸ¥ç»„ä»¶æ˜¯å¦å¯¹å•†æˆ·å¯ç”¨
function isComponentEnabled(
  override: MerchantComponentOverride | null
): boolean {
  // é»˜è®¤å¯ç”¨ï¼Œé™¤éæ˜ç¡®ç¦ç”¨
  return override?.isEnabled ?? true;
}
```

### å•†æˆ·ç»„ä»¶é…ç½®

å•†æˆ·åœ¨ `/merchant/components` é¡µé¢ç»Ÿä¸€é…ç½®ç»„ä»¶ï¼ˆä»·æ ¼ã€å¯ç”¨çŠ¶æ€ï¼‰ï¼Œé€‚ç”¨äºæ‰€æœ‰å¥—é¤ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç»„ä»¶é…ç½®ç®¡ç†                                                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                         â”‚
â”‚  ğŸ’¡ åœ¨æ­¤è®¾ç½®çš„é…ç½®é€‚ç”¨äºæ‚¨çš„æ‰€æœ‰å¥—é¤                                      â”‚
â”‚                                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚
â”‚  â”‚ ç»„ä»¶          â”‚ å¹³å°å»ºè®®ä»·    â”‚ æˆ‘çš„å®šä»·    â”‚ çŠ¶æ€    â”‚               â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤               â”‚
â”‚  â”‚ ğŸ‘˜ æŒ¯è¢–å’Œæœ   â”‚ Â¥5,000       â”‚ [Â¥4,500   ] â”‚ â˜‘ å¯ç”¨  â”‚               â”‚
â”‚  â”‚ ğŸ€ å¸¯ãƒ»å¸¯ç· ã‚ â”‚ Â¥1,000       â”‚ [         ] â”‚ â˜‘ å¯ç”¨  â”‚  â† ç•™ç©º=å»ºè®®ä»· â”‚
â”‚  â”‚ ğŸ“· ä¸“ä¸šè·Ÿæ‹   â”‚ Â¥2,000       â”‚ [Â¥1,800   ] â”‚ â˜‘ å¯ç”¨  â”‚               â”‚
â”‚  â”‚ ğŸš— æ¥é€æœåŠ¡   â”‚ Â¥1,500       â”‚ [         ] â”‚ â˜ ç¦ç”¨  â”‚  â† ç¦ç”¨=ä¸æä¾› â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚
â”‚                                                                         â”‚
â”‚  â“˜ ç•™ç©ºå®šä»· = ä½¿ç”¨å¹³å°å»ºè®®ä»·                                             â”‚
â”‚  â“˜ ç¦ç”¨çš„ç»„ä»¶ä¸ä¼šå‡ºç°åœ¨æ‚¨çš„å¥—é¤ä¸­                                        â”‚
â”‚                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### å¥—é¤ä»·æ ¼è®¡ç®—

```typescript
// å¥—é¤æ€»ä»· = åŸºç¡€ä»· + Î£(é¡¾å®¢é€‰ä¸­çš„å¯é€‰ç»„ä»¶ä»·æ ¼) + Î£(å‡çº§å·®ä»·)
function calculateTotal(
  plan: RentalPlan,
  selectedOptionalIds: string[],
  selectedUpgrades: { fromId: string; toId: string }[]
): number {
  let total = plan.price;  // åŸºç¡€å¥—é¤ä»·

  // åŠ ä¸Šå¯é€‰ç»„ä»¶
  for (const pc of plan.planComponents) {
    if (!pc.isIncluded && selectedOptionalIds.includes(pc.componentId)) {
      total += getComponentPrice(pc.component);
    }
  }

  // åŠ ä¸Šå‡çº§å·®ä»·
  for (const upgrade of selectedUpgrades) {
    const upgradeConfig = findUpgrade(upgrade.fromId, upgrade.toId);
    total += upgradeConfig?.priceDiff ?? 0;
  }

  return total;
}
```

---

## å®ç°çŠ¶æ€

### å·²å®Œæˆ

| åŠŸèƒ½ | çŠ¶æ€ | æ–‡ä»¶ |
|------|------|------|
| ServiceComponent æ¨¡å‹ | âœ… | `prisma/schema.prisma` |
| PlanComponent æ¨¡å‹ | âœ… | `prisma/schema.prisma` |
| ComponentUpgrade æ¨¡å‹ | âœ… | `prisma/schema.prisma` |
| PlanUpgradeBundle æ¨¡å‹ | âœ… | `prisma/schema.prisma` |
| PlanComponentEditor | âœ… | `src/components/merchant/` |
| ServiceComponentSelector | âœ… | `src/components/merchant/` |
| EditorHotspot | âœ… | `src/components/shared/` |
| InteractiveKimonoMap | âœ… | `src/components/plan/` |
| GET /api/service-components | âœ… | `src/app/api/` |
| PATCH /api/merchant/plans/[id] | âœ… | `src/app/api/` |

### v9 å¾…å®ç°

| åŠŸèƒ½ | ä¼˜å…ˆçº§ | è¯´æ˜ |
|------|--------|------|
| MerchantComponentOverride æ¨¡å‹ | P1 | å•†æˆ·çº§åˆ«è¦†ç›–é…ç½®ï¼ˆä»·æ ¼ã€å¯ç”¨çŠ¶æ€ï¼‰|
| /merchant/components é¡µé¢ | P1 | å•†æˆ·ç»„ä»¶é…ç½®ç•Œé¢ |
| ç§»é™¤ PlanComponent è¦†ç›–å­—æ®µ | P1 | ç®€åŒ–æ•°æ®æ¨¡å‹ |
| ThemeComponent æ¨¡å‹ | P2 | ä¸»é¢˜-ç»„ä»¶å…³è” |
| /admin/components é¡µé¢ | P2 | å¹³å°ç»„ä»¶ç®¡ç† |
| ä¸»é¢˜æ¨èç»„ä»¶ | P2 | é€‰ä¸»é¢˜åæ˜¾ç¤ºæ¨è |

### éœ€è¦ç§»é™¤çš„å­—æ®µ

ä» `PlanComponent` æ¨¡å‹ä¸­ç§»é™¤ä»¥ä¸‹å­—æ®µï¼ˆæ”¹ä¸ºå•†æˆ·çº§åˆ«ç®¡ç†ï¼‰ï¼š

```diff
model PlanComponent {
  // ä¿ç•™
  id, planId, componentId
  isIncluded, quantity
  hotmapX, hotmapY, hotmapLabelPosition, hotmapOrder

  // ç§»é™¤ï¼ˆä¸å†æ”¯æŒå¥—é¤çº§åˆ«è¦†ç›–ï¼‰
- nameOverride
- descriptionOverride
- highlightsOverride
- upgradePriceOverride
- customNote
- isHighlighted
- tier
- tierLabel
}
```

---

## å·²çŸ¥é—®é¢˜

### Bugï¼šç»„ä»¶æ•°æ®å»¶è¿ŸåŠ è½½

**é—®é¢˜**ï¼šç»„ä»¶æ•°æ®æœªåŠ è½½å®Œæˆæ—¶ï¼Œå·²æ”¾ç½®çš„çƒ­ç‚¹ä¸æ¸²æŸ“

**ä¿®å¤æ–¹æ¡ˆ**ï¼š

```typescript
// ä½¿ç”¨å ä½ç¬¦
const renderedHotspots = placedComponents.map(config => {
  const component = getAllComponents().find(c => c.id === config.componentId);

  if (config.hotmapX == null || config.hotmapY == null) {
    return null;
  }

  return {
    id: config.componentId,
    x: config.hotmapX,
    y: config.hotmapY,
    name: component?.name ?? 'åŠ è½½ä¸­...',  // å ä½ç¬¦
    icon: component?.icon ?? 'ğŸ“',          // å ä½ç¬¦
  };
}).filter(Boolean);
```

---

## é™„å½•ï¼šç±»å‹å®šä¹‰

```typescript
// çƒ­ç‚¹æ•°æ®ï¼ˆç”¨æˆ·ç«¯å±•ç¤ºï¼‰
interface HotspotData {
  id: string;
  x: number;  // 0-1
  y: number;  // 0-1
  labelPosition: 'left' | 'right' | 'top' | 'bottom';
  displayOrder: number;
  component: ServiceComponentData;
  isIncluded: boolean;
}

// åœ°å›¾æ•°æ®
interface MapData {
  imageUrl: string;
  imageWidth?: number | null;
  imageHeight?: number | null;
  hotspots: HotspotData[];
}

// ç»„ä»¶é…ç½®ï¼ˆç¼–è¾‘å™¨çŠ¶æ€ï¼‰
interface ComponentConfig {
  componentId: string;
  isIncluded: boolean;           // æ˜¯å¦åŒ…å«åœ¨å¥—é¤åŸºç¡€ä»·
  enabledUpgrades: string[];     // å¯ç”¨çš„å‡çº§é€‰é¡¹ ID
  hotmapX?: number | null;       // çƒ­ç‚¹ X åæ ‡
  hotmapY?: number | null;       // çƒ­ç‚¹ Y åæ ‡
  hotmapLabelPosition?: string;  // æ ‡ç­¾æ–¹å‘
}

// æœåŠ¡ç»„ä»¶ï¼ˆå¹³å°å®šä¹‰ï¼‰
interface ServiceComponentData {
  id: string;
  code: string;
  name: string;
  nameJa?: string | null;
  nameEn?: string | null;
  description?: string | null;
  type: ComponentType;
  icon?: string | null;
  basePrice: number;       // å¹³å°å»ºè®®ä»·
  highlights: string[];
  images: string[];
  tier: number;
  tierLabel?: string | null;
}

// å•†æˆ·è¦†ç›–é…ç½®ï¼ˆå•†æˆ·çº§åˆ«ï¼‰
interface MerchantComponentOverride {
  merchantId: string;
  componentId: string;
  price: number | null;    // å•†æˆ·å®šä»·ï¼ˆnull = ä½¿ç”¨å¹³å°å»ºè®®ä»·ï¼‰
  isEnabled: boolean;      // æ˜¯å¦å¯ç”¨æ­¤ç»„ä»¶
  // é¢„ç•™æ‰©å±•...
}
```

---

## æ›´æ–°æ—¥å¿—

| ç‰ˆæœ¬ | æ—¥æœŸ | å˜æ›´ |
|------|------|------|
| v9.1 | 2024-12 | ç§»é™¤å¥—é¤çº§åˆ«è¦†ç›–ï¼Œå•†æˆ·åªèƒ½è®¾ç½®ä»·æ ¼ï¼ˆå•†æˆ·çº§åˆ«ï¼‰|
| v9 | 2024-12 | å¹³å°ç»Ÿä¸€ç®¡ç†ç»„ä»¶ï¼Œå•†æˆ·å®šä»·è§„åˆ’ |
| v8 | 2024-11 | ç®€åŒ–ä¸º copy-on-use æ¨¡å¼ï¼ˆå·²åºŸå¼ƒï¼‰|
| v7 | 2024-11 | MerchantComponentConfig æ–¹æ¡ˆï¼ˆå·²åºŸå¼ƒï¼‰|

---

## è®¾è®¡å†³ç­–è®°å½•

### ä¸ºä»€ä¹ˆç§»é™¤å¥—é¤çº§åˆ«è¦†ç›–ï¼Ÿ

**é—®é¢˜**ï¼š
- å¥—é¤çº§åˆ«è¦†ç›–ï¼ˆnameOverride, descriptionOverrideï¼‰å¢åŠ äº†å¤æ‚åº¦
- åŒä¸€ç»„ä»¶åœ¨ä¸åŒå¥—é¤ä¸­å¯èƒ½æ˜¾ç¤ºä¸åŒåç§°ï¼Œç”¨æˆ·ä½“éªŒä¸ä¸€è‡´
- å•†æˆ·éœ€è¦ä¸ºæ¯ä¸ªå¥—é¤å•ç‹¬é…ç½®ï¼Œå·¥ä½œé‡å¤§

**è§£å†³æ–¹æ¡ˆ**ï¼š
- ç»„ä»¶ä¿¡æ¯ç”±å¹³å°ç»Ÿä¸€ç®¡ç†ï¼ˆåç§°ã€æè¿°ã€å›¾æ ‡ç­‰ï¼‰
- å•†æˆ·åªèƒ½æ§åˆ¶ä»·æ ¼ï¼ˆå•†æˆ·çº§åˆ«ï¼Œæ‰€æœ‰å¥—é¤é€šç”¨ï¼‰
- å•†æˆ·å¯å¯ç”¨/ç¦ç”¨ç»„ä»¶

**å¥½å¤„**ï¼š
- ç®€åŒ–æ•°æ®æ¨¡å‹ï¼ˆç§»é™¤ 7 ä¸ªå­—æ®µï¼‰
- ç®€åŒ–å•†æˆ·æ“ä½œï¼ˆè®¾ä¸€æ¬¡ä»·æ ¼ï¼Œæ‰€æœ‰å¥—é¤é€šç”¨ï¼‰
- ä¿è¯ç”¨æˆ·ä½“éªŒä¸€è‡´æ€§
