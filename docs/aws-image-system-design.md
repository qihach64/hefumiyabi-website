# AWS å›¾ç‰‡ç³»ç»Ÿæ¶æ„è®¾è®¡æ–‡æ¡£

> **çŠ¶æ€**: âœ… Phase 1 å®Œæˆ - Phase 2 è¿›è¡Œä¸­
> **åˆ›å»ºæ—¥æœŸ**: 2026-01-01
> **æ›´æ–°æ—¥æœŸ**: 2026-01-01
> **ç›®æ ‡**: å°† Kimono One å¹³å°å›¾ç‰‡ç³»ç»Ÿè¿ç§»åˆ° AWS

## å·²ç¡®è®¤çš„æ¶æ„å†³ç­–

| å†³ç­–é¡¹ | é€‰æ‹© | è¯´æ˜ |
|--------|------|------|
| æ•°æ®æ¨¡å‹ | **åªå­˜ URL** | ä¸å¼•å…¥ Image æ¨¡å‹ï¼Œä¿æŒç®€å• |
| å›¾ç‰‡å¤„ç† | **Lambda é¢„å¤„ç†** | ä¸Šä¼ æ—¶ç”Ÿæˆæ‰€æœ‰å°ºå¯¸å˜ä½“ |
| ä¸­å›½åŒºåŠ é€Ÿ | **åç»­è¿­ä»£** | å…ˆç”¨ CloudFront å›½é™…ç‰ˆ |
| AWS åŒºåŸŸ | **ap-northeast-1** | ä¸œäº¬ï¼Œè·ç¦»ä¸­å›½æœ€è¿‘ |

---

## 1. ç°çŠ¶åˆ†æ

### 1.1 å½“å‰å›¾ç‰‡å­˜å‚¨æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      å½“å‰å›¾ç‰‡å­˜å‚¨åˆ†å¸ƒ                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                     â”‚
â”‚  â”‚  Supabase Storage â”‚     â”‚   å¤–éƒ¨ CDN/URL    â”‚                     â”‚
â”‚  â”‚  (tryon-results)  â”‚     â”‚                  â”‚                     â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                     â”‚
â”‚  â”‚ â€¢ AI è¯•ç©¿ç»“æœå›¾    â”‚     â”‚ â€¢ å¥—é¤å›¾ç‰‡        â”‚                     â”‚
â”‚  â”‚ â€¢ å”¯ä¸€ä¸»åŠ¨ä¸Šä¼ å­˜å‚¨  â”‚     â”‚ â€¢ å’Œæœå›¾ç‰‡        â”‚                     â”‚
â”‚  â”‚ â€¢ 1å¹´ç¼“å­˜ç­–ç•¥     â”‚     â”‚ â€¢ ä¸»é¢˜å°é¢        â”‚                     â”‚
â”‚  â”‚ â€¢ ~50MB/æœˆä¼°è®¡    â”‚     â”‚ â€¢ å•†å®¶ Logo       â”‚                     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚ â€¢ ç”¨æˆ·å¤´åƒ        â”‚                     â”‚
â”‚                           â”‚ â€¢ è¯„ä»·å›¾ç‰‡        â”‚                     â”‚
â”‚                           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                     â”‚
â”‚                                    â”‚                               â”‚
â”‚                           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”                      â”‚
â”‚                           â”‚   æ¥æºåˆ†æ•£:      â”‚                      â”‚
â”‚                           â”‚ â€¢ Unsplash      â”‚                      â”‚
â”‚                           â”‚ â€¢ Cloudinary    â”‚                      â”‚
â”‚                           â”‚ â€¢ hefumiyabi.comâ”‚                      â”‚
â”‚                           â”‚ â€¢ ç¬¬ä¸‰æ–¹ä¾›åº”å•†   â”‚                      â”‚
â”‚                           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.2 æ¶‰åŠå›¾ç‰‡çš„æ•°æ®åº“æ¨¡å‹

| æ¨¡å‹ | å­—æ®µ | ç±»å‹ | ç”¨é€” |
|------|------|------|------|
| `RentalPlan` | `imageUrl` | String? | å¥—é¤ä¸»å›¾ |
| `RentalPlan` | `images[]` | String[] | å¥—é¤å›¾åº“ |
| `Kimono` | é€šè¿‡ `KimonoImage` | å…³è”è¡¨ | å’Œæœå›¾åº“ |
| `Listing` | `imageUrl`, `images[]` | String? / String[] | å•†å®¶å•†å“å›¾ |
| `Campaign` | `coverImage`, `bannerImage` | String? | æ´»åŠ¨å°é¢/æ¨ªå¹… |
| `Review` | `images[]` | String[] | ç”¨æˆ·è¯„ä»·å›¾ |
| `User` | `avatar` | String? | ç”¨æˆ·å¤´åƒ |
| `Merchant` | `logo` | String? | å•†å®¶ Logo |
| `VirtualTryOn` | `resultImageUrl` | String | AI è¯•ç©¿ç»“æœ |
| `Theme` | `coverImage` | String? | ä¸»é¢˜å°é¢ |

### 1.3 å½“å‰ç—›ç‚¹

1. **æ— ç»Ÿä¸€ä¸Šä¼ å…¥å£**: å•†å®¶/ç”¨æˆ·å¿…é¡»è‡ªè¡Œæ‰˜ç®¡å›¾ç‰‡ï¼Œåªèƒ½æä¾› URL
2. **å›¾ç‰‡æ¥æºåˆ†æ•£**: ä¾èµ–å¤šä¸ªå¤–éƒ¨æœåŠ¡ï¼Œå¯é æ€§ä¸ä¸€
3. **æ— å›¾ç‰‡å¤„ç†**: ç¼ºä¹è£å‰ªã€å‹ç¼©ã€æ ¼å¼è½¬æ¢èƒ½åŠ›
4. **å­˜å‚¨æˆæœ¬ä¸é€æ˜**: Supabase å…è´¹é¢åº¦æœ‰é™ï¼Œæ‰©å±•æˆæœ¬é«˜
5. **CDN è¦†ç›–ä¸å‡**: ä¸­å›½å¤§é™†è®¿é—®æŸäº›å¤–éƒ¨å›¾ç‰‡æœåŠ¡è¾ƒæ…¢

---

## 2. AWS å›¾ç‰‡ç³»ç»Ÿç›®æ ‡æ¶æ„

### 2.1 æ¶æ„æ€»è§ˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        AWS å›¾ç‰‡ç³»ç»Ÿæ¶æ„                                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚   å®¢æˆ·ç«¯     â”‚â”€â”€â”€â–¶â”‚  Next.js    â”‚â”€â”€â”€â–¶â”‚   S3 API    â”‚â”€â”€â”€â–¶â”‚   S3å­˜å‚¨     â”‚  â”‚
â”‚  â”‚  (æµè§ˆå™¨)    â”‚    â”‚  API Route  â”‚    â”‚  (Presigned)â”‚    â”‚   (åŸå›¾)     â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚         â”‚                 â”‚                                     â”‚          â”‚
â”‚         â”‚                 â”‚                                     â–¼          â”‚
â”‚         â”‚                 â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚         â”‚                 â”‚              â”‚       S3 Event Trigger      â”‚   â”‚
â”‚         â”‚                 â”‚              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚         â”‚                 â”‚                           â”‚                    â”‚
â”‚         â”‚                 â”‚                           â–¼                    â”‚
â”‚         â”‚                 â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚         â”‚                 â”‚              â”‚      Lambda å›¾ç‰‡å¤„ç†         â”‚   â”‚
â”‚         â”‚                 â”‚              â”‚  â€¢ ç”Ÿæˆç¼©ç•¥å›¾ (thumbnail)    â”‚   â”‚
â”‚         â”‚                 â”‚              â”‚  â€¢ å‹ç¼©ä¼˜åŒ– (webp/avif)      â”‚   â”‚
â”‚         â”‚                 â”‚              â”‚  â€¢ å°ºå¯¸å˜ä½“ (sm/md/lg)       â”‚   â”‚
â”‚         â”‚                 â”‚              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚         â”‚                 â”‚                           â”‚                    â”‚
â”‚         â”‚                 â”‚                           â–¼                    â”‚
â”‚         â”‚                 â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚         â”‚                 â”‚              â”‚    S3 å­˜å‚¨ (å¤„ç†åå›¾ç‰‡)       â”‚   â”‚
â”‚         â”‚                 â”‚              â”‚    /processed/{size}/{id}   â”‚   â”‚
â”‚         â”‚                 â”‚              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚         â”‚                 â”‚                           â”‚                    â”‚
â”‚         â”‚                 â–¼                           â–¼                    â”‚
â”‚         â”‚        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚         â”‚        â”‚              CloudFront CDN                  â”‚          â”‚
â”‚         â”‚        â”‚  â€¢ å…¨çƒè¾¹ç¼˜ç¼“å­˜                               â”‚          â”‚
â”‚         â”‚        â”‚  â€¢ ä¸­å›½åŒºåŠ é€Ÿ (éœ€å¤‡æ¡ˆ)                        â”‚          â”‚
â”‚         â”‚        â”‚  â€¢ è‡ªåŠ¨é€‰æ‹©æœ€è¿‘èŠ‚ç‚¹                           â”‚          â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â–¶â”‚  â€¢ æ”¯æŒ WebP/AVIF è‡ªåŠ¨åå•†                   â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â”‚                                      â”‚                                    â”‚
â”‚                                      â–¼                                    â”‚
â”‚                             â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                           â”‚
â”‚                             â”‚  ç”¨æˆ·æµè§ˆå™¨æ˜¾ç¤º   â”‚                           â”‚
â”‚                             â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.2 æ ¸å¿ƒ AWS æœåŠ¡é€‰å‹

| æœåŠ¡ | ç”¨é€” | é€‰æ‹©ç†ç”± |
|------|------|----------|
| **S3** | å›¾ç‰‡å­˜å‚¨ | é«˜å¯ç”¨ã€ä½æˆæœ¬ã€æ— é™æ‰©å±• |
| **CloudFront** | CDN åˆ†å‘ | å…¨çƒè¾¹ç¼˜èŠ‚ç‚¹ã€ä¸ S3 æ·±åº¦é›†æˆ |
| **Lambda** | å›¾ç‰‡å¤„ç† | æŒ‰éœ€ä»˜è´¹ã€è‡ªåŠ¨æ‰©å±•ã€ä¸ S3 è§¦å‘é›†æˆ |
| **API Gateway** | ä¸Šä¼ ç«¯ç‚¹ (å¯é€‰) | å¦‚éœ€é¢å¤–æ§åˆ¶å±‚ |

### 2.3 S3 Bucket ç»“æ„è®¾è®¡

```
kimono-one-images/
â”œâ”€â”€ originals/                    # åŸå§‹ä¸Šä¼ å›¾ç‰‡
â”‚   â”œâ”€â”€ plans/                    # å¥—é¤å›¾ç‰‡
â”‚   â”‚   â””â”€â”€ {planId}/
â”‚   â”‚       â”œâ”€â”€ main.jpg
â”‚   â”‚       â””â”€â”€ gallery-{n}.jpg
â”‚   â”œâ”€â”€ kimonos/                  # å’Œæœå›¾ç‰‡
â”‚   â”‚   â””â”€â”€ {kimonoId}/
â”‚   â”‚       â””â”€â”€ {n}.jpg
â”‚   â”œâ”€â”€ merchants/                # å•†å®¶èµ„æº
â”‚   â”‚   â””â”€â”€ {merchantId}/
â”‚   â”‚       â”œâ”€â”€ logo.png
â”‚   â”‚       â””â”€â”€ listings/{listingId}/{n}.jpg
â”‚   â”œâ”€â”€ users/                    # ç”¨æˆ·å†…å®¹
â”‚   â”‚   â””â”€â”€ {userId}/
â”‚   â”‚       â”œâ”€â”€ avatar.jpg
â”‚   â”‚       â””â”€â”€ reviews/{reviewId}/{n}.jpg
â”‚   â”œâ”€â”€ campaigns/                # æ´»åŠ¨å›¾ç‰‡
â”‚   â”‚   â””â”€â”€ {campaignId}/
â”‚   â”‚       â”œâ”€â”€ cover.jpg
â”‚   â”‚       â””â”€â”€ banner.jpg
â”‚   â””â”€â”€ tryon/                    # AI è¯•ç©¿ (ä» Supabase è¿ç§»)
â”‚       â””â”€â”€ {userId}/
â”‚           â””â”€â”€ {resultId}.jpg
â”‚
â”œâ”€â”€ processed/                    # Lambda å¤„ç†åçš„å›¾ç‰‡
â”‚   â”œâ”€â”€ thumbnails/               # ç¼©ç•¥å›¾ (200x267, 3:4)
â”‚   â”‚   â””â”€â”€ {originalPath}.webp
â”‚   â”œâ”€â”€ small/                    # å°å›¾ (400x533)
â”‚   â”‚   â””â”€â”€ {originalPath}.webp
â”‚   â”œâ”€â”€ medium/                   # ä¸­å›¾ (800x1067)
â”‚   â”‚   â””â”€â”€ {originalPath}.webp
â”‚   â””â”€â”€ large/                    # å¤§å›¾ (1200x1600)
â”‚       â””â”€â”€ {originalPath}.webp
â”‚
â””â”€â”€ temp/                         # ä¸´æ—¶ä¸Šä¼  (24å°æ—¶è‡ªåŠ¨æ¸…ç†)
    â””â”€â”€ {uploadId}.jpg
```

---

## 3. ä¸Šä¼ æµç¨‹è®¾è®¡

### 3.1 Presigned URL ä¸Šä¼ æµç¨‹ (æ¨è)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     Presigned URL ä¸Šä¼ æµç¨‹                                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚  1. è¯·æ±‚ä¸Šä¼ å‡­è¯                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     POST /api/upload/presign      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚  â”‚  Client  â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶ â”‚  Next.js API â”‚           â”‚
â”‚  â”‚          â”‚     { fileType, category }        â”‚              â”‚           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â”‚       â”‚                                                â”‚                    â”‚
â”‚       â”‚                                                â”‚ AWS SDK           â”‚
â”‚       â”‚                                                â–¼                    â”‚
â”‚       â”‚                                         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚       â”‚                                         â”‚     S3       â”‚           â”‚
â”‚       â”‚                                         â”‚ getSignedUrl â”‚           â”‚
â”‚       â”‚                                         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â”‚       â”‚                                                â”‚                    â”‚
â”‚       â”‚     { presignedUrl, key, publicUrl }          â”‚                    â”‚
â”‚       â”‚ â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                    â”‚
â”‚       â”‚                                                                     â”‚
â”‚  2. ç›´æ¥ä¸Šä¼ åˆ° S3                                                            â”‚
â”‚       â”‚                                                                     â”‚
â”‚       â”‚      PUT presignedUrl                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚     S3       â”‚           â”‚
â”‚              (Binary file data)                 â”‚   Bucket     â”‚           â”‚
â”‚                                                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â”‚                                                        â”‚                    â”‚
â”‚  3. S3 Event è§¦å‘ Lambda å¤„ç†                                                â”‚
â”‚                                                        â”‚                    â”‚
â”‚                                                        â–¼                    â”‚
â”‚                                                 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚                                                 â”‚   Lambda     â”‚           â”‚
â”‚                                                 â”‚ å›¾ç‰‡å¤„ç†     â”‚           â”‚
â”‚                                                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â”‚                                                        â”‚                    â”‚
â”‚  4. å®¢æˆ·ç«¯ä¿å­˜ URL åˆ°æ•°æ®åº“                              â”‚                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                          â”‚                    â”‚
â”‚  â”‚  Client  â”‚ â”€â”€â”€ POST /api/plans (å« imageUrl) â”€â”€â”€â–¶ DB                    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.2 API ç«¯ç‚¹è®¾è®¡

```typescript
// POST /api/upload/presign
// è·å–é¢„ç­¾åä¸Šä¼  URL

interface PresignRequest {
  fileType: 'image/jpeg' | 'image/png' | 'image/webp';
  category: 'plan' | 'kimono' | 'merchant' | 'user' | 'campaign' | 'tryon';
  entityId?: string;  // å¯é€‰ï¼Œå¦‚ planIdã€merchantId
  purpose?: 'main' | 'gallery' | 'avatar' | 'logo' | 'cover' | 'banner';
}

interface PresignResponse {
  presignedUrl: string;        // ä¸Šä¼ ç”¨ URL (æœ‰æ•ˆæœŸ 5 åˆ†é’Ÿ)
  key: string;                 // S3 å¯¹è±¡ key
  publicUrl: string;           // CDN å…¬å¼€è®¿é—® URL
  expiresAt: string;           // è¿‡æœŸæ—¶é—´
}
```

```typescript
// POST /api/upload/confirm
// ç¡®è®¤ä¸Šä¼ å®Œæˆï¼Œè§¦å‘æ•°æ®åº“æ›´æ–° (å¯é€‰)

interface ConfirmRequest {
  key: string;
  category: string;
  entityId: string;
  field: string;  // å¦‚ 'imageUrl' æˆ– 'images'
}
```

---

## 4. Lambda å›¾ç‰‡å¤„ç†è®¾è®¡

### 4.1 å¤„ç†è§¦å‘å™¨

```yaml
# S3 Event Trigger Configuration
Events:
  - s3:ObjectCreated:*
Filter:
  Prefix: originals/
  Suffix:
    - .jpg
    - .jpeg
    - .png
    - .webp
```

### 4.2 å¤„ç†é€»è¾‘

```typescript
// Lambda å‡½æ•°ä¼ªä»£ç 
export async function handler(event: S3Event) {
  for (const record of event.Records) {
    const bucket = record.s3.bucket.name;
    const key = decodeURIComponent(record.s3.object.key);

    // 1. ä¸‹è½½åŸå›¾
    const original = await s3.getObject({ Bucket: bucket, Key: key });

    // 2. ä½¿ç”¨ Sharp å¤„ç†
    const variants = [
      { name: 'thumbnail', width: 200, height: 267 },
      { name: 'small', width: 400, height: 533 },
      { name: 'medium', width: 800, height: 1067 },
      { name: 'large', width: 1200, height: 1600 },
    ];

    for (const variant of variants) {
      const processed = await sharp(original.Body)
        .resize(variant.width, variant.height, { fit: 'cover' })
        .webp({ quality: 85 })
        .toBuffer();

      // 3. ä¸Šä¼ å¤„ç†åçš„å›¾ç‰‡
      const processedKey = key
        .replace('originals/', `processed/${variant.name}/`)
        .replace(/\.(jpg|jpeg|png)$/, '.webp');

      await s3.putObject({
        Bucket: bucket,
        Key: processedKey,
        Body: processed,
        ContentType: 'image/webp',
        CacheControl: 'public, max-age=31536000',
      });
    }
  }
}
```

### 4.3 å¤„ç†åçš„ URL ç»“æ„

```
åŸå›¾:     https://cdn.kimono-one.com/originals/plans/abc123/main.jpg
ç¼©ç•¥å›¾:   https://cdn.kimono-one.com/processed/thumbnails/plans/abc123/main.webp
å°å›¾:     https://cdn.kimono-one.com/processed/small/plans/abc123/main.webp
ä¸­å›¾:     https://cdn.kimono-one.com/processed/medium/plans/abc123/main.webp
å¤§å›¾:     https://cdn.kimono-one.com/processed/large/plans/abc123/main.webp
```

---

## 5. CloudFront CDN é…ç½®

### 5.1 åˆ†å‘è®¾ç½®

```yaml
Distribution:
  Origins:
    - S3 Bucket: kimono-one-images
      OriginAccessControl: enabled  # é™åˆ¶ç›´æ¥è®¿é—® S3

  DefaultCacheBehavior:
    ViewerProtocolPolicy: redirect-to-https
    CachePolicy: CachingOptimized
    ResponseHeadersPolicy: CORS-with-preflight

  CacheBehaviors:
    - PathPattern: /originals/*
      CacheTTL: 86400  # 1 å¤© (åŸå›¾å¯èƒ½è¢«æ›¿æ¢)
    - PathPattern: /processed/*
      CacheTTL: 31536000  # 1 å¹´ (å¤„ç†åä¸å˜)

  PriceClass: PriceClass_All  # å…¨çƒè¾¹ç¼˜èŠ‚ç‚¹

  CustomDomain: cdn.kimono-one.com
  Certificate: ACM (us-east-1)
```

### 5.2 ä¸­å›½åŒºåŠ é€Ÿæ–¹æ¡ˆ

**æ–¹æ¡ˆ A: ä½¿ç”¨ AWS ä¸­å›½åŒº (éœ€ ICP å¤‡æ¡ˆ)**
- å•ç‹¬éƒ¨ç½²ä¸­å›½åŒº S3 + CloudFront
- é€šè¿‡ DNS æ™ºèƒ½è§£æåˆ†æµ

**æ–¹æ¡ˆ B: ç¬¬ä¸‰æ–¹ CDN å›æº (æ¨èèµ·æ­¥)**
- ä½¿ç”¨é˜¿é‡Œäº‘ CDN / è…¾è®¯äº‘ CDN
- å›æºåˆ° AWS CloudFront
- æ— éœ€å¤‡æ¡ˆï¼Œä½†å¢åŠ ä¸€å±‚

**æ–¹æ¡ˆ C: æ··åˆæ¶æ„**
- å›½é™…ç”¨æˆ·: CloudFront ç›´è¿
- ä¸­å›½ç”¨æˆ·: é˜¿é‡Œäº‘ CDN â†’ S3 (è·¨å¢ƒå›æº)

---

## 6. æ•°æ®åº“ Schema ç­–ç•¥

### âœ… å·²ç¡®è®¤: ä¿æŒ URL å­—æ®µä¸å˜

- ç°æœ‰ `imageUrl` / `images[]` å­—æ®µç»§ç»­ä½¿ç”¨
- å­˜å‚¨ CloudFront URL è€Œé Supabase URL
- **ä¸å¼•å…¥ Image æ¨¡å‹**ï¼Œä¿æŒæœ€å°ä»£ç æ”¹åŠ¨
- æ•°æ®åº“å­—æ®µå­˜å‚¨åŸå›¾ URLï¼Œå‰ç«¯æ ¹æ®éœ€è¦æ‹¼æ¥å°ºå¯¸å˜ä½“è·¯å¾„

---

## 7. è¿ç§»è®¡åˆ’

### 7.1 é˜¶æ®µä¸€: åŸºç¡€è®¾æ–½æ­å»º (Week 1)

- [ ] åˆ›å»º S3 Bucket å’Œç›®å½•ç»“æ„
- [ ] é…ç½® CloudFront åˆ†å‘
- [ ] è®¾ç½® IAM æƒé™å’Œç­–ç•¥
- [ ] éƒ¨ç½² Lambda å›¾ç‰‡å¤„ç†å‡½æ•°
- [ ] æµ‹è¯•ä¸Šä¼ å’Œ CDN è®¿é—®

### 7.2 é˜¶æ®µäºŒ: API å¼€å‘ (Week 2)

- [ ] å®ç° `/api/upload/presign` ç«¯ç‚¹
- [ ] å®ç° `/api/upload/confirm` ç«¯ç‚¹ (å¯é€‰)
- [ ] æ›´æ–° `next.config.ts` æ·»åŠ  CloudFront åŸŸå
- [ ] åˆ›å»º `src/lib/aws.ts` SDK å·¥å…·

### 7.3 é˜¶æ®µä¸‰: å‰ç«¯é›†æˆ (Week 3)

- [ ] åˆ›å»ºé€šç”¨ `ImageUploader` ç»„ä»¶
- [ ] é›†æˆåˆ°å•†å®¶åå° (å¥—é¤å›¾ç‰‡ä¸Šä¼ )
- [ ] é›†æˆåˆ°ç”¨æˆ·é¡µé¢ (å¤´åƒã€è¯„ä»·å›¾)
- [ ] æ›´æ–°å›¾ç‰‡æ˜¾ç¤ºç»„ä»¶ä½¿ç”¨ CDN URL

### 7.4 é˜¶æ®µå››: æ•°æ®è¿ç§» (Week 4)

- [ ] ç¼–å†™è¿ç§»è„šæœ¬ (Supabase â†’ S3)
- [ ] è¿ç§» AI è¯•ç©¿ç»“æœå›¾ç‰‡
- [ ] ä¸‹è½½å¹¶ä¸Šä¼ å¤–éƒ¨æ‰˜ç®¡å›¾ç‰‡ (å¯é€‰)
- [ ] æ›´æ–°æ•°æ®åº“ URL å­—æ®µ
- [ ] éªŒè¯å’Œå›æ»šè®¡åˆ’

### 7.5 é˜¶æ®µäº”: æ¸…ç†å’Œä¼˜åŒ– (Week 5)

- [ ] ç§»é™¤ Supabase Storage ä¾èµ–
- [ ] æ›´æ–° `next.config.ts` ç§»é™¤æ—§åŸŸå
- [ ] è®¾ç½® S3 ç”Ÿå‘½å‘¨æœŸç­–ç•¥ (temp ç›®å½•æ¸…ç†)
- [ ] ç›‘æ§å’Œå‘Šè­¦é…ç½®
- [ ] æ–‡æ¡£æ›´æ–°

---

## 8. æˆæœ¬ä¼°ç®—

### 8.1 AWS æœåŠ¡æˆæœ¬ (æœˆä¼°ç®—)

| æœåŠ¡ | ç”¨é‡å‡è®¾ | æœˆæˆæœ¬ |
|------|----------|--------|
| **S3 å­˜å‚¨** | 50GB | ~$1.15 |
| **S3 è¯·æ±‚** | 100K PUT + 1M GET | ~$5.00 |
| **CloudFront** | 100GB ä¼ è¾“ + 2M è¯·æ±‚ | ~$12.00 |
| **Lambda** | 10K è°ƒç”¨ Ã— 5s Ã— 512MB | ~$0.50 |
| **æ•°æ®ä¼ è¾“** | S3 â†’ CloudFront (å…è´¹) | $0 |
| **æ€»è®¡** | | **~$18.65/æœˆ** |

### 8.2 ä¸ Supabase å¯¹æ¯”

| é¡¹ç›® | Supabase å…è´¹ç‰ˆ | Supabase Pro | AWS |
|------|-----------------|--------------|-----|
| å­˜å‚¨ | 1GB | 100GB | æ— é™ |
| å¸¦å®½ | 2GB/æœˆ | 250GB/æœˆ | æŒ‰é‡ |
| å›¾ç‰‡å¤„ç† | æ—  | æ—  | Lambda |
| CDN | æœ‰é™ | æœ‰é™ | CloudFront å…¨çƒ |
| æœˆè´¹ | $0 | $25 | ~$18 (æŒ‰ç”¨é‡) |

---

## 9. å·²ç¡®è®¤å†³ç­– & å¾…å®šäº‹é¡¹

### âœ… å·²ç¡®è®¤çš„æ¶æ„å†³ç­–

| # | é—®é¢˜ | å†³ç­– |
|---|------|------|
| 1 | Image æ¨¡å‹ | âŒ ä¸éœ€è¦ï¼Œä¿æŒåªå­˜ URL |
| 2 | å›¾ç‰‡å¤„ç†æ–¹å¼ | Lambda ä¸Šä¼ æ—¶é¢„å¤„ç†æ‰€æœ‰å°ºå¯¸ |
| 3 | ä¸­å›½åŒºåŠ é€Ÿ | åç»­è¿­ä»£ï¼Œå…ˆç”¨ CloudFront å›½é™…ç‰ˆ |
| 4 | AWS åŒºåŸŸ | ap-northeast-1 (ä¸œäº¬) |

### ğŸ“‹ å¾…ç¡®è®¤äº‹é¡¹

5. **å›¾ç‰‡æ ¼å¼å’Œå¤§å°é™åˆ¶**
   - å»ºè®®: æœ€å¤§ 10MBï¼Œæ”¯æŒ JPEG/PNG/WebP
   - æš‚ä¸æ”¯æŒ GIF åŠ¨å›¾

6. **å›¾ç‰‡å®¡æ ¸**
   - å»ºè®®: é¦–æœŸä¸åšï¼Œåç»­å¯æ¥å…¥ Rekognition

7. **ç°æœ‰å›¾ç‰‡è¿ç§»**
   - å»ºè®®: æ–°å›¾ç‰‡ç”¨ S3ï¼Œæ—§å›¾ç‰‡ä¿æŒåŸæ ·

---

## 10. å®æ–½è¿›åº¦

### Phase 1: ä»£ç å®ç° âœ… å·²å®Œæˆ

**åŸºç¡€è®¾æ–½ä»£ç :**
- [x] æ›´æ–°è®¾è®¡æ–‡æ¡£ç¡®è®¤å†³ç­–
- [x] åˆ›å»º `src/lib/aws.ts` - AWS SDK é…ç½®å’Œå·¥å…·å‡½æ•°
- [x] åˆ›å»º `/api/upload/presign` - é¢„ç­¾å URL API
- [x] æ›´æ–° `next.config.ts` - æ·»åŠ  CloudFront åŸŸå
- [x] åˆ›å»º Lambda å‡½æ•°ä»£ç  (`aws/lambda/image-processor/`)
- [x] å®‰è£… AWS SDK ä¾èµ– (`@aws-sdk/client-s3`, `@aws-sdk/s3-request-presigner`)

**ImageUploader ç»„ä»¶:**
- [x] åˆ›å»º `src/components/ImageUploader.tsx` é€šç”¨ä¸Šä¼ ç»„ä»¶
- [x] æ”¯æŒå¤šå›¾ç‰‡ä¸Šä¼  (æœ€å¤š 10 å¼ )
- [x] ä¸»å›¾é€‰æ‹©åŠŸèƒ½ (ç‚¹å‡»å›¾ç‰‡è®¾ä¸ºä¸»å›¾ï¼Œæ˜Ÿæ ‡æ˜¾ç¤º)
- [x] æ‹–æ‹½ä¸Šä¼ æ”¯æŒ
- [x] ä¸Šä¼ è¿›åº¦å’Œé”™è¯¯çŠ¶æ€æ˜¾ç¤º
- [x] 3:4 æ¯”ä¾‹é¢„è§ˆ (å’Œæœå±•ç¤ºæœ€ä½³æ¯”ä¾‹)

**å•†å®¶å¥—é¤ç®¡ç†é›†æˆ:**
- [x] `PlanEditForm` é›†æˆå¤šå›¾ä¸Šä¼ 
- [x] `PlanCreateForm` é›†æˆå¤šå›¾ä¸Šä¼ 
- [x] API è·¯ç”±æ”¯æŒ `images[]` æ•°ç»„å­—æ®µ
- [x] æƒé™æ£€æŸ¥: æ”¯æŒå·²å®¡æ‰¹å•†å®¶è´¦æˆ· (ä¸ä»…é™ MERCHANT è§’è‰²)

**è¯¦æƒ…é¡µå›¾åº“å±•ç¤º:**
- [x] `VisualHub` ç»„ä»¶æ”¯æŒå¤šå›¾å±•ç¤º
- [x] `PlanDetailClient` ä¼ é€’ `images[]` åˆ°å›¾åº“
- [x] è‡ªé€‚åº”å¸ƒå±€ (1-4 å¼ å›¾ç‰‡ä¸åŒæ’åˆ—)

**Bug ä¿®å¤:**
- [x] ä¿®å¤ä¸Šä¼ åå›¾ç‰‡çŠ¶æ€æœªæ­£ç¡®æ¸…ç†çš„é—®é¢˜
- [x] ä¿®å¤ React é—­åŒ…é—®é¢˜ (ä½¿ç”¨å‡½æ•°å¼æ›´æ–° `setFormData(prev => ...)`)

### Phase 2: AWS åŸºç¡€è®¾æ–½ ğŸš§ è¿›è¡Œä¸­

- [x] åˆ›å»º S3 Bucket
- [x] é…ç½® IAM æƒé™ (presigned URL å¯ç”¨)
- [ ] é…ç½® CloudFront CDN
- [ ] éƒ¨ç½² Lambda å›¾ç‰‡å¤„ç†å‡½æ•°
- [ ] è®¾ç½® S3 Event Trigger

### Phase 3: é›†æˆæµ‹è¯•

- [x] æµ‹è¯•é¢„ç­¾å URL ä¸Šä¼ æµç¨‹
- [x] éªŒè¯å•†å®¶å¥—é¤å›¾ç‰‡ä¸Šä¼ 
- [ ] éªŒè¯ Lambda å›¾ç‰‡å¤„ç†
- [ ] éªŒè¯ CDN è®¿é—®æ€§èƒ½

---

## 11. ImageUploader ç»„ä»¶ API

### 11.1 Props æ¥å£

```typescript
interface ImageUploaderProps {
  // ä¸Šä¼ åˆ†ç±» (å†³å®š S3 è·¯å¾„å’Œæƒé™æ£€æŸ¥)
  category: 'plan' | 'kimono' | 'merchant' | 'user' | 'campaign' | 'tryon';

  // å¯é€‰: å…³è”å®ä½“ ID (å¦‚ planId)
  entityId?: string;

  // å›¾ç‰‡ç”¨é€” (å†³å®šå­ç›®å½•)
  purpose?: 'main' | 'gallery' | 'avatar' | 'logo' | 'cover' | 'banner';

  // æ˜¯å¦å…è®¸å¤šå›¾ä¸Šä¼ 
  multiple?: boolean;  // é»˜è®¤ true

  // æœ€å¤§å›¾ç‰‡æ•°é‡
  maxFiles?: number;   // é»˜è®¤ 10

  // å·²ä¸Šä¼ å›¾ç‰‡ URL æ•°ç»„ (å—æ§ç»„ä»¶)
  value?: string[];

  // å½“å‰ä¸»å›¾ URL
  mainImage?: string;

  // å›¾ç‰‡å˜åŒ–å›è°ƒ (è¿”å›æ‰€æœ‰å›¾ç‰‡ URL)
  onChange?: (urls: string[]) => void;

  // ä¸»å›¾å˜åŒ–å›è°ƒ
  onMainImageChange?: (url: string) => void;

  // ä¸Šä¼ å®Œæˆå›è°ƒ (è¿”å›æœ¬æ¬¡ä¸Šä¼ æˆåŠŸçš„ URL)
  onUploadComplete?: (urls: string[]) => void;

  // é”™è¯¯å›è°ƒ
  onError?: (error: string) => void;

  // é¢„è§ˆæ¯”ä¾‹
  aspectRatio?: '3:4' | '4:3' | '1:1' | '16:9';  // é»˜è®¤ 3:4

  // ç¦ç”¨çŠ¶æ€
  disabled?: boolean;
}
```

### 11.2 ä½¿ç”¨ç¤ºä¾‹

```tsx
// å¥—é¤ç¼–è¾‘è¡¨å•ä¸­çš„å¤šå›¾ä¸Šä¼ 
<ImageUploader
  category="plan"
  entityId={plan.id}
  purpose="main"
  multiple={true}
  maxFiles={10}
  value={formData.images}
  mainImage={formData.imageUrl}
  onChange={(urls) => {
    setFormData(prev => {
      const newMainImage = prev.imageUrl && urls.includes(prev.imageUrl)
        ? prev.imageUrl
        : urls[0] || "";
      return { ...prev, images: urls, imageUrl: newMainImage };
    });
  }}
  onMainImageChange={(url) => {
    setFormData(prev => ({ ...prev, imageUrl: url }));
  }}
  onError={(err) => setError(err)}
  aspectRatio="3:4"
/>
```

### 11.3 æƒé™æ£€æŸ¥è§„åˆ™

| Category | æƒé™è¦æ±‚ |
|----------|----------|
| `plan` / `kimono` / `campaign` | éœ€è¦ç™»å½• + (ADMIN è§’è‰² OR å·²å®¡æ‰¹å•†å®¶è´¦æˆ·) |
| `merchant` | éœ€è¦ç™»å½• + å·²å®¡æ‰¹å•†å®¶è´¦æˆ· |
| `user` | éœ€è¦ç™»å½• (åªèƒ½ä¸Šä¼ è‡ªå·±çš„å†…å®¹) |
| `tryon` | å…è®¸æ¸¸å®¢ (AI è¯•ç©¿åŠŸèƒ½) |

### 11.4 ä¸Šä¼ é™åˆ¶

- **æ–‡ä»¶ç±»å‹**: JPEG, PNG, WebP
- **æœ€å¤§æ–‡ä»¶å¤§å°**: 10MB
- **æ¨èå°ºå¯¸**: 800Ã—1067 åƒç´  (3:4 æ¯”ä¾‹)

---

## é™„å½•

### A. ç›¸å…³æ–‡ä»¶æ¸…å•

```
å·²åˆ›å»º/ä¿®æ”¹çš„æ–‡ä»¶:
â”œâ”€â”€ src/lib/
â”‚   â””â”€â”€ aws.ts                          # âœ… AWS SDK é…ç½®å’Œå·¥å…·å‡½æ•°
â”œâ”€â”€ src/app/api/
â”‚   â”œâ”€â”€ upload/
â”‚   â”‚   â””â”€â”€ presign/route.ts            # âœ… é¢„ç­¾å URL API (å«æƒé™æ£€æŸ¥)
â”‚   â””â”€â”€ merchant/plans/
â”‚       â”œâ”€â”€ route.ts                    # âœ… æ›´æ–°: æ”¯æŒ images[] å­—æ®µ
â”‚       â””â”€â”€ [id]/route.ts               # âœ… æ›´æ–°: æ”¯æŒ images[] å­—æ®µ
â”œâ”€â”€ src/components/
â”‚   â”œâ”€â”€ ImageUploader.tsx               # âœ… é€šç”¨å¤šå›¾ä¸Šä¼ ç»„ä»¶
â”‚   â”œâ”€â”€ merchant/
â”‚   â”‚   â”œâ”€â”€ PlanEditForm.tsx            # âœ… é›†æˆ ImageUploader
â”‚   â”‚   â””â”€â”€ PlanCreateForm.tsx          # âœ… é›†æˆ ImageUploader
â”‚   â”œâ”€â”€ plan/
â”‚   â”‚   â””â”€â”€ VisualHub/index.tsx         # âœ… æ”¯æŒå¤šå›¾å±•ç¤º
â”‚   â””â”€â”€ PlanDetailClient.tsx            # âœ… ä¼ é€’ images[] åˆ° VisualHub
â”œâ”€â”€ next.config.ts                      # âœ… æ·»åŠ  S3/CloudFront åŸŸå
â”œâ”€â”€ prisma/schema.prisma                # âœ… RentalPlan.images String[]
â”œâ”€â”€ aws/
â”‚   â””â”€â”€ lambda/
â”‚       â””â”€â”€ image-processor/            # âœ… Lambda å‡½æ•°ä»£ç  (å¾…éƒ¨ç½²)
â”‚           â”œâ”€â”€ index.ts
â”‚           â””â”€â”€ package.json
â””â”€â”€ .env.local                          # âœ… AWS å‡­è¯é…ç½®
```

### B. ç¯å¢ƒå˜é‡

```bash
# AWS å‡­è¯
AWS_ACCESS_KEY_ID=xxx
AWS_SECRET_ACCESS_KEY=xxx
AWS_REGION=ap-northeast-1

# S3 é…ç½®
AWS_S3_BUCKET=kimono-one-images

# CloudFront é…ç½®
CLOUDFRONT_DOMAIN=cdn.kimono-one.com
CLOUDFRONT_DISTRIBUTION_ID=xxx
```

### C. å‚è€ƒèµ„æº

- [AWS S3 Presigned URLs](https://docs.aws.amazon.com/AmazonS3/latest/userguide/using-presigned-url.html)
- [CloudFront with S3 Origin](https://docs.aws.amazon.com/AmazonCloudFront/latest/DeveloperGuide/DownloadDistS3AndCustomOrigins.html)
- [Lambda Image Processing](https://aws.amazon.com/blogs/compute/resize-images-on-the-fly-with-amazon-s3-aws-lambda-and-amazon-api-gateway/)
- [Sharp Node.js Image Processing](https://sharp.pixelplumbing.com/)
