# å•†å®¶å¥—é¤æ‰€æœ‰æƒä¿®å¤æ–‡æ¡£

## é—®é¢˜èƒŒæ™¯

**å‘ç°æ—¥æœŸ**: 2025-12-03
**ä¸¥é‡ç¨‹åº¦**: ğŸ”´ é«˜å± - æƒé™æ¼æ´

### é—®é¢˜æè¿°

åŸç³»ç»Ÿå­˜åœ¨ä¸¥é‡çš„æƒé™æ¼æ´ï¼š
- `RentalPlan` æ¨¡å‹ç¼ºå°‘å•†å®¶æ‰€æœ‰æƒå­—æ®µï¼ˆ`merchantId`ï¼‰
- ä»»æ„å·²æ‰¹å‡†çš„å•†å®¶éƒ½å¯ä»¥æŸ¥çœ‹ã€ç¼–è¾‘ã€åˆ é™¤æ‰€æœ‰å¥—é¤ï¼ˆåŒ…æ‹¬å…¶ä»–å•†å®¶çš„å¥—é¤ï¼‰
- å•†å®¶åˆ—è¡¨é¡µæ˜¾ç¤ºæ‰€æœ‰å•†å®¶çš„å¥—é¤ï¼Œè€Œéä»…æ˜¾ç¤ºè‡ªå·±çš„
- æ— æ³•è¿½æº¯å¥—é¤æ˜¯ç”±å“ªä¸ªå•†å®¶åˆ›å»ºçš„

### å®‰å…¨é£é™©

1. **æ•°æ®æ³„éœ²**: å•†å®¶ A å¯ä»¥æŸ¥çœ‹å•†å®¶ B çš„æ‰€æœ‰å¥—é¤è¯¦æƒ…
2. **æ¶æ„ç¯¡æ”¹**: å•†å®¶ A å¯ä»¥ä¿®æ”¹å•†å®¶ B çš„å¥—é¤ä»·æ ¼ã€æè¿°ç­‰
3. **æ¶æ„ä¸‹æ¶**: å•†å®¶ A å¯ä»¥é€šè¿‡ DELETE API ä¸‹æ¶ç«äº‰å¯¹æ‰‹çš„å¥—é¤
4. **æ•°æ®æ··æ·†**: æ— æ³•åŒºåˆ†å¥—é¤å½’å±ï¼Œå¯¼è‡´ç®¡ç†æ··ä¹±

---

## è§£å†³æ–¹æ¡ˆ

é‡‡ç”¨**æ–¹æ¡ˆ 1ï¼šä¿®å¤ RentalPlan æ‰€æœ‰æƒ**

### ä¿®æ”¹å†…å®¹

#### 1. æ•°æ®åº“ Schema ä¿®æ”¹

**æ–‡ä»¶**: `prisma/schema.prisma`

åœ¨ `RentalPlan` æ¨¡å‹ä¸­æ·»åŠ :
```prisma
model RentalPlan {
  // ... å…¶ä»–å­—æ®µ

  // å•†å®¶æ‰€æœ‰æƒ
  merchantId String?
  merchant   Merchant? @relation(fields: [merchantId], references: [id], onDelete: Cascade)
  createdBy  String?   // åˆ›å»ºè€… User ID

  // ... å…¶ä»–å­—æ®µ

  @@index([merchantId])
}
```

åœ¨ `Merchant` æ¨¡å‹ä¸­æ·»åŠ åå‘å…³è”:
```prisma
model Merchant {
  // ... å…¶ä»–å­—æ®µ
  rentalPlans RentalPlan[]
}
```

#### 2. æ•°æ®è¿ç§»è„šæœ¬

**æ–‡ä»¶**: `scripts/migrate-rental-plans-add-merchant.ts`

åŠŸèƒ½:
- éªŒè¯ç›®æ ‡å•†å®¶ ID æ˜¯å¦å­˜åœ¨
- æŸ¥æ‰¾æ‰€æœ‰æœªå…³è”å•†å®¶çš„å¥—é¤
- å°†æ‰€æœ‰ç°æœ‰å¥—é¤å…³è”åˆ°æŒ‡å®šå•†å®¶ (`cmh158hpt0002gy0o56xmkpxo`)
- è®¾ç½® `createdBy` ä¸ºå•†å®¶æ‰€æœ‰è€…çš„ User ID
- æ˜¾ç¤ºè¿ç§»ç»Ÿè®¡ä¿¡æ¯

**æ‰§è¡Œæ–¹å¼**:
```bash
# 1. å…ˆåº”ç”¨ schema æ›´æ”¹åˆ°æ•°æ®åº“
pnpm prisma db push

# 2. è¿è¡Œè¿ç§»è„šæœ¬
pnpm tsx scripts/migrate-rental-plans-add-merchant.ts
```

#### 3. API æƒé™ä¿®å¤

##### åˆ›å»ºå¥—é¤ API (`src/app/api/merchant/plans/route.ts:56-86`)

**ä¿®æ”¹å‰**:
```typescript
const newPlan = await prisma.rentalPlan.create({
  data: {
    // ... æ‰€æœ‰å­—æ®µï¼Œä½†æ²¡æœ‰ merchantId
  },
});
```

**ä¿®æ”¹å**:
```typescript
const newPlan = await prisma.rentalPlan.create({
  data: {
    // ... æ‰€æœ‰å­—æ®µ
    merchantId: merchant.id,        // âœ… å…³è”å•†å®¶
    createdBy: session.user.id,     // âœ… è®°å½•åˆ›å»ºè€…
  },
});
```

##### æ›´æ–°å¥—é¤ API (`src/app/api/merchant/plans/[id]/route.ts:110-125`)

**æ–°å¢æ‰€æœ‰æƒæ£€æŸ¥**:
```typescript
// éªŒè¯å¥—é¤æ‰€æœ‰æƒ
const plan = await prisma.rentalPlan.findUnique({
  where: { id },
  select: { merchantId: true },
});

if (!plan) {
  return NextResponse.json({ message: "å¥—é¤ä¸å­˜åœ¨" }, { status: 404 });
}

if (plan.merchantId !== merchant.id) {
  return NextResponse.json(
    { message: "æ— æƒé™æ“ä½œæ­¤å¥—é¤" },
    { status: 403 }
  );
}
```

##### åˆ é™¤å¥—é¤ API (`src/app/api/merchant/plans/[id]/route.ts:253-268`)

åŒæ ·æ·»åŠ æ‰€æœ‰æƒæ£€æŸ¥ï¼ˆä»£ç åŒä¸Šï¼‰

#### 4. å‰ç«¯é¡µé¢ä¿®å¤

##### å¥—é¤åˆ—è¡¨é¡µ (`src/app/(main)/merchant/listings/page.tsx:27-34`)

**ä¿®æ”¹å‰**:
```typescript
const allPlans = await prisma.rentalPlan.findMany({
  orderBy: [
    { isFeatured: "desc" },
    { createdAt: "desc" },
  ],
});
```

**ä¿®æ”¹å**:
```typescript
const allPlans = await prisma.rentalPlan.findMany({
  where: {
    merchantId: merchant.id,  // âœ… åªæŸ¥è¯¢è‡ªå·±çš„å¥—é¤
  },
  orderBy: [
    { isFeatured: "desc" },
    { createdAt: "desc" },
  ],
});
```

##### ç¼–è¾‘é¡µé¢ (`src/app/(main)/merchant/listings/[id]/edit/page.tsx:58-61`)

**æ–°å¢æ‰€æœ‰æƒéªŒè¯**:
```typescript
// éªŒè¯å¥—é¤æ‰€æœ‰æƒ
if (plan.merchantId !== merchant.id) {
  redirect("/merchant/listings");
}
```

---

## éƒ¨ç½²æ­¥éª¤

### âš ï¸ é‡è¦ï¼šæŒ‰é¡ºåºæ‰§è¡Œ

1. **åº”ç”¨ä»£ç æ›´æ”¹**
   ```bash
   git add .
   git commit -m "fix: ä¿®å¤å•†å®¶å¥—é¤æ‰€æœ‰æƒæƒé™æ¼æ´"
   ```

2. **åº”ç”¨æ•°æ®åº“ Schema æ›´æ”¹**
   ```bash
   # å¼€å‘ç¯å¢ƒ
   pnpm prisma db push

   # æˆ–ç”Ÿäº§ç¯å¢ƒè¿ç§»
   pnpm prisma migrate deploy
   ```

3. **è¿è¡Œæ•°æ®è¿ç§»è„šæœ¬**
   ```bash
   pnpm tsx scripts/migrate-rental-plans-add-merchant.ts
   ```

4. **éªŒè¯è¿ç§»ç»“æœ**
   - æ£€æŸ¥è„šæœ¬è¾“å‡ºï¼Œç¡®è®¤æ‰€æœ‰å¥—é¤å·²å…³è”
   - ç™»å½•å•†å®¶åå°ï¼Œç¡®è®¤åªèƒ½çœ‹åˆ°è‡ªå·±çš„å¥—é¤
   - å°è¯•è®¿é—®å…¶ä»–å•†å®¶çš„å¥—é¤ç¼–è¾‘é¡µé¢ï¼ˆåº”è¢«é‡å®šå‘ï¼‰

5. **é‡æ–°ç”Ÿæˆ Prisma Client**
   ```bash
   pnpm prisma generate
   ```

6. **é‡å¯åº”ç”¨**
   ```bash
   pnpm dev  # å¼€å‘ç¯å¢ƒ
   # æˆ–é‡æ–°éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ
   ```

---

## æµ‹è¯•æ¸…å•

### åŠŸèƒ½æµ‹è¯•

- [ ] å•†å®¶åªèƒ½åœ¨åˆ—è¡¨é¡µçœ‹åˆ°è‡ªå·±çš„å¥—é¤
- [ ] å•†å®¶å¯ä»¥åˆ›å»ºæ–°å¥—é¤ï¼ˆè‡ªåŠ¨å…³è”åˆ°è‡ªå·±ï¼‰
- [ ] å•†å®¶å¯ä»¥ç¼–è¾‘è‡ªå·±çš„å¥—é¤
- [ ] å•†å®¶å¯ä»¥åˆ é™¤ï¼ˆä¸‹æ¶ï¼‰è‡ªå·±çš„å¥—é¤
- [ ] å•†å®¶æ— æ³•è®¿é—®å…¶ä»–å•†å®¶çš„å¥—é¤ç¼–è¾‘é¡µé¢ï¼ˆåº”é‡å®šå‘ï¼‰
- [ ] å•†å®¶æ— æ³•é€šè¿‡ API ä¿®æ”¹å…¶ä»–å•†å®¶çš„å¥—é¤ï¼ˆåº”è¿”å› 403ï¼‰

### å®‰å…¨æµ‹è¯•

- [ ] å°è¯•é€šè¿‡ä¿®æ”¹ URL å‚æ•°è®¿é—®å…¶ä»–å¥—é¤ IDï¼ˆåº”è¿”å› 404 æˆ–é‡å®šå‘ï¼‰
- [ ] å°è¯•é€šè¿‡ API ç›´æ¥è°ƒç”¨æ›´æ–°å…¶ä»–å•†å®¶çš„å¥—é¤ï¼ˆåº”è¿”å› 403ï¼‰
- [ ] å°è¯•é€šè¿‡ API ç›´æ¥è°ƒç”¨åˆ é™¤å…¶ä»–å•†å®¶çš„å¥—é¤ï¼ˆåº”è¿”å› 403ï¼‰

### æ•°æ®å®Œæ•´æ€§æµ‹è¯•

- [ ] æ‰€æœ‰ç°æœ‰å¥—é¤éƒ½å·²å…³è”åˆ°æŒ‡å®šå•†å®¶
- [ ] æ–°åˆ›å»ºçš„å¥—é¤è‡ªåŠ¨åŒ…å« `merchantId` å’Œ `createdBy`
- [ ] æ•°æ®åº“ç´¢å¼•å·²æ­£ç¡®åˆ›å»ºï¼ˆæ£€æŸ¥æŸ¥è¯¢æ€§èƒ½ï¼‰

---

## å›æ»šæ–¹æ¡ˆ

å¦‚æœå‡ºç°é—®é¢˜éœ€è¦å›æ»šï¼š

1. **æ¢å¤ä»£ç **
   ```bash
   git revert HEAD
   ```

2. **æ•°æ®åº“å›æ»š**ï¼ˆéœ€è¦æ‰‹åŠ¨æ“ä½œï¼‰
   ```sql
   -- ç§»é™¤æ‰€æœ‰æƒå­—æ®µï¼ˆæ•°æ®ä¸ä¼šä¸¢å¤±ï¼‰
   ALTER TABLE rental_plans DROP COLUMN merchant_id;
   ALTER TABLE rental_plans DROP COLUMN created_by;
   ```

3. **é‡æ–°ç”Ÿæˆ Prisma Client**
   ```bash
   pnpm prisma generate
   ```

âš ï¸ **æ³¨æ„**: å›æ»šåæƒé™æ¼æ´ä¼šé‡æ–°å‡ºç°ï¼Œä»…åœ¨ç´§æ€¥æƒ…å†µä¸‹ä½¿ç”¨ï¼

---

## æœªæ¥æ”¹è¿›å»ºè®®

1. **æ·»åŠ å®¡è®¡æ—¥å¿—**: è®°å½•å¥—é¤çš„æ‰€æœ‰ä¿®æ”¹æ“ä½œï¼ŒåŒ…æ‹¬ä¿®æ”¹äººã€æ—¶é—´ã€ä¿®æ”¹å†…å®¹
2. **ç®¡ç†å‘˜æƒé™**: å…è®¸ ADMIN è§’è‰²æŸ¥çœ‹å’Œç®¡ç†æ‰€æœ‰å¥—é¤ï¼ˆè·¨å•†å®¶ï¼‰
3. **å¥—é¤è½¬ç§»åŠŸèƒ½**: æ”¯æŒå°†å¥—é¤æ‰€æœ‰æƒä»ä¸€ä¸ªå•†å®¶è½¬ç§»åˆ°å¦ä¸€ä¸ªå•†å®¶
4. **æ‰¹é‡æ“ä½œæƒé™**: ç¡®ä¿æ‰¹é‡æ“ä½œï¼ˆå¦‚æ‰¹é‡ä¸Šæ¶/ä¸‹æ¶ï¼‰ä¹Ÿéµå¾ªæ‰€æœ‰æƒè§„åˆ™
5. **å‰ç«¯UIä¼˜åŒ–**: åœ¨å¥—é¤å¡ç‰‡ä¸Šæ˜¾ç¤º"æˆ‘çš„å¥—é¤"å¾½ç« ï¼ŒåŒºåˆ†è‡ªå·±å’Œå…¶ä»–å•†å®¶çš„å¥—é¤ï¼ˆå¦‚æœæœªæ¥æ”¯æŒè·¨å•†å®¶æŸ¥çœ‹ï¼‰

---

## ç›¸å…³æ–‡ä»¶

### ä¿®æ”¹çš„æ–‡ä»¶
- `prisma/schema.prisma` - æ•°æ®åº“ schema
- `src/app/api/merchant/plans/route.ts` - åˆ›å»ºå¥—é¤ API
- `src/app/api/merchant/plans/[id]/route.ts` - æ›´æ–°/åˆ é™¤å¥—é¤ API
- `src/app/(main)/merchant/listings/page.tsx` - å¥—é¤åˆ—è¡¨é¡µ
- `src/app/(main)/merchant/listings/[id]/edit/page.tsx` - å¥—é¤ç¼–è¾‘é¡µ

### æ–°å¢çš„æ–‡ä»¶
- `scripts/migrate-rental-plans-add-merchant.ts` - æ•°æ®è¿ç§»è„šæœ¬
- `docs/merchant-plan-ownership-fix.md` - æœ¬æ–‡æ¡£

---

## è”ç³»ä¿¡æ¯

å¦‚æœ‰é—®é¢˜ï¼Œè¯·è”ç³»ï¼š
- å¼€å‘è€…: Claude Code
- æ—¥æœŸ: 2025-12-03
- å‚è€ƒæ–‡æ¡£: CLAUDE.md (é¡¹ç›®æ¶æ„æ–‡æ¡£)
